<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth & Environment Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>üîç Auth & Environment Diagnostic</h1>
    
    <div class="section">
        <h2>üåê Environment Variables</h2>
        <div id="env-result">Checking...</div>
    </div>
    
    <div class="section">
        <h2>üîë Authentication Status</h2>
        <div id="auth-result">Checking...</div>
    </div>
    
    <div class="section">
        <h2>üìã Data Fetching Test</h2>
        <div id="data-result">Testing...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/appwrite@15.0.0/dist/sdk.js"></script>
    <script>
        const { Client, Databases, Account } = Appwrite;

        async function runDiagnostics() {
            const envDiv = document.getElementById('env-result');
            const authDiv = document.getElementById('auth-result');
            const dataDiv = document.getElementById('data-result');

            // Check environment variables
            try {
                const env = {
                    VITE_APPWRITE_ENDPOINT: window.location.origin.includes('localhost') ? 'https://syd.cloud.appwrite.io/v1' : 'Production endpoint',
                    VITE_APPWRITE_PROJECT_ID: '68f23b11000d25eb3664',
                    VITE_APPWRITE_DATABASE_ID: '68f76ee1000e64ca8d05',
                    isLocalhost: window.location.origin.includes('localhost'),
                    currentOrigin: window.location.origin
                };
                
                envDiv.innerHTML = `
                    <span class="success">‚úÖ Environment check:</span><br>
                    <pre>${JSON.stringify(env, null, 2)}</pre>
                `;
            } catch (error) {
                envDiv.innerHTML = `<span class="error">‚ùå Environment error: ${error.message}</span>`;
            }

            // Test authentication
            try {
                const client = new Client()
                    .setEndpoint('https://syd.cloud.appwrite.io/v1')
                    .setProject('68f23b11000d25eb3664');

                const account = new Account(client);

                // Check existing session
                try {
                    const user = await account.get();
                    authDiv.innerHTML = `
                        <span class="success">‚úÖ Existing session found:</span><br>
                        <pre>User: ${user.email || 'Anonymous'}\nID: ${user.$id}</pre>
                    `;
                } catch (sessionError) {
                    // Try to create anonymous session
                    try {
                        await account.createAnonymousSession();
                        const newUser = await account.get();
                        authDiv.innerHTML = `
                            <span class="success">‚úÖ Anonymous session created:</span><br>
                            <pre>User: ${newUser.email || 'Anonymous'}\nID: ${newUser.$id}</pre>
                        `;
                    } catch (anonError) {
                        authDiv.innerHTML = `
                            <span class="error">‚ùå Session creation failed:</span><br>
                            <pre>${anonError.message}</pre>
                            <span class="warning">‚ö†Ô∏è This is likely why data fetching fails on live site!</span>
                        `;
                    }
                }

                // Test data fetching
                const databases = new Databases(client);
                const databaseId = '68f76ee1000e64ca8d05';

                try {
                    console.log('üìã Testing therapist data fetch...');
                    const therapistsResponse = await databases.listDocuments(
                        databaseId,
                        'therapists_collection_id',
                        [] // No queries, just get all
                    );
                    
                    dataDiv.innerHTML = `
                        <span class="success">‚úÖ Data fetching works!</span><br>
                        <strong>Therapists found:</strong> ${therapistsResponse.documents.length}<br>
                        <pre>${JSON.stringify(therapistsResponse.documents.slice(0, 1), null, 2)}</pre>
                    `;
                } catch (dataError) {
                    dataDiv.innerHTML = `
                        <span class="error">‚ùå Data fetching failed:</span><br>
                        <pre>${dataError.message}</pre>
                        <span class="warning">‚ö†Ô∏è This confirms the live site issue!</span>
                    `;
                }

            } catch (error) {
                authDiv.innerHTML = `<span class="error">‚ùå Authentication setup failed: ${error.message}</span>`;
                dataDiv.innerHTML = `<span class="error">‚ùå Cannot test data without auth</span>`;
            }
        }

        // Run diagnostics on page load
        runDiagnostics();
    </script>
</body>
</html>