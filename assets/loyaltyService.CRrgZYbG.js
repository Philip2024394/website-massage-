import{d as u,A as h,a1 as q,a2 as O}from"./route-therapist.DVVqC6AH.js";import{Query as D}from"./vendor-appwrite.BT2H32tF.js";import"./vendor-react.DJgHGAhw.js";import"./route-booking.yuk30L8G.js";import"./vendor-misc.BCNplu90.js";import"./route-portals.BJGRQhN_.js";const l=h.databaseId,d=h.collections,T=async(s,n,e)=>{try{const i=await u.listDocuments(l,d.providerLoyaltySettings,[D.equal("providerId",s),D.equal("providerType",n)]);if(i.documents.length>0)return i.documents[0];const a=n==="therapist"?"T".concat(String(s).padStart(3,"0"),"-COINS"):"P".concat(String(s).padStart(3,"0"),"-COINS"),t={providerId:s,providerType:n,providerName:e,providerCoinId:a,tier1:{visits:3,discount:5,coinsRequired:15},tier2:{visits:5,discount:10,coinsRequired:25},tier3:{visits:10,discount:15,coinsRequired:50},tier4:{visits:20,discount:20,coinsRequired:100},coinsPerVisit:5,enableDecay:!0,decayGracePeriod:14,streakBonus:!0,birthdayBonus:10,isActive:!0,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return await u.createDocument(l,d.providerLoyaltySettings,"unique()",t)}catch(i){throw i}},I=async(s,n,e,i)=>{try{const a=await u.listDocuments(l,d.loyaltyWallets,[D.equal("userId",s),D.equal("providerId",n),D.equal("providerType",e)]);if(a.documents.length>0)return a.documents[0];const t=await T(n,e,i),o={userId:s,providerId:n,providerType:e,providerName:i,providerCoinId:t.providerCoinId,totalCoins:0,coinsEarned:0,coinsRedeemed:0,totalVisits:0,firstVisitDate:new Date().toISOString(),decayRate:0,currentTier:0,currentDiscount:0,status:q.Active,streak:0,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return await u.createDocument(l,d.loyaltyWallets,"unique()",o)}catch(a){throw a}},k=(s,n,e)=>{const i=[e.tier1,e.tier2,e.tier3,e.tier4];let a=0,t=0;for(let o=i.length-1;o>=0;o--){const r=i[o];if(s>=r.visits&&n>=r.coinsRequired){a=o+1,t=r.discount;break}}return{tier:a,discount:t}},$=async(s,n,e,i,a)=>{try{const t=await I(s,n,e,i),o=await T(n,e,i);let r=o.coinsPerVisit;const w=new Date,y=t.lastVisitDate?new Date(t.lastVisitDate):null;let c=t.streak;y&&(w.getTime()-y.getTime())/864e5<=7?(c=t.streak+1,o.streakBonus&&c>=3&&(r+=2)):c=1;const S=t.totalCoins+r,m=t.totalVisits+1,f=t.coinsEarned+r,{tier:C,discount:V}=k(m,S,o),g=C>t.currentTier?C:void 0,A=g?V:void 0;return await u.updateDocument(l,d.loyaltyWallets,t.$id,{totalCoins:S,coinsEarned:f,totalVisits:m,lastVisitDate:w.toISOString(),currentTier:C,currentDiscount:V,streak:c,status:q.Active,updatedAt:w.toISOString()}),await E(s,t.$id,n,e,O.Earned,r,"Earned from booking #".concat(a),t.totalCoins,S,a),{userId:s,providerId:n,providerType:e,providerName:i,providerCoinId:o.providerCoinId,coinsEarned:r,totalCoins:S,totalVisits:m,tierUnlocked:(g!=null?g:0)>0,discountUnlocked:(A!=null?A:0)>0,streakCount:c>=3?c:void 0}}catch(t){throw t}},E=async(s,n,e,i,a,t,o,r,w,y)=>{try{const c={userId:s,walletId:n,providerId:e,providerType:i,type:a,amount:t,reason:o,balanceBefore:r,balanceAfter:w,bookingId:y,createdAt:new Date().toISOString()};return await u.createDocument(l,d.coinTransactions,"unique()",c)}catch(c){throw c}};export{$ as awardCoins,I as getOrCreateWallet,T as getProviderSettings};
