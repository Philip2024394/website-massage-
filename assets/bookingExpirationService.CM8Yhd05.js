var u=Object.defineProperty;var f=(n,t,i)=>t in n?u(n,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):n[t]=i;var l=(n,t,i)=>f(n,typeof t!="symbol"?t+"":t,i);import{g as e,c as $,V as s,d as a,D as o}from"./route-therapist.DVVqC6AH.js";import{Query as c}from"./vendor-appwrite.BT2H32tF.js";import{s as h}from"./App.1fxTHtx8.js";import"./vendor-react.DJgHGAhw.js";import"./route-booking.yuk30L8G.js";import"./vendor-misc.BCNplu90.js";import"./route-portals.BJGRQhN_.js";import"./vendor-ui.D6Y-8hbd.js";import"./route-payment.T2FKxZVj.js";class g{constructor(){l(this,"intervalId",null);l(this,"checkIntervalMs",6e4)}start(){if(this.intervalId){e.info("Booking expiration service already running");return}e.info("Starting booking expiration service..."),this.checkExpiredBookings(),this.intervalId=setInterval(()=>{this.checkExpiredBookings()},this.checkIntervalMs)}stop(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null,e.info("Booking expiration service stopped"))}async checkExpiredBookings(){try{const t=h.get();if(t&&!t.hasSession)return;try{const p=t!=null&&t.hasSession?t.user:await $.get();t!=null&&t.hasSession||h.set(!0,p),e.info("‚úÖ Using existing user session for booking checks:",p.email)}catch{h.setNoSession();return}const i=new Date().toISOString(),d=s.bookings;e.info("üîç Checking expired bookings with collection ID:",d);const r=await a.listDocuments(o,d,[c.equal("status","pending")]);if(r.documents.length>0){e.info("Found ".concat(r.documents.length," expired booking(s)"));for(const p of r.documents)await this.handleExpiredBooking(p)}}catch(t){e.error("Error checking expired bookings:",t)}}async handleExpiredBooking(t){try{if(e.info("‚è∞ Handling expired booking: ".concat(t.$id)),e.info("üìã Booking details:",{id:t.$id,therapistId:t.therapistId,therapistType:t.therapistType,status:t.status,createdAt:t.createdAt}),!t.$id){e.error("‚ùå Invalid booking - missing ID");return}if(t.status==="expired"){e.info("‚ÑπÔ∏è Booking ".concat(t.$id," already marked as expired"));return}await a.updateDocument(o,s.bookings,t.$id,{status:"expired"}),e.info("‚úÖ Marked booking ".concat(t.$id," as expired"));try{if(!t.therapistId||t.therapistId==="null"||t.therapistId==="undefined"){e.info("‚ö†Ô∏è Skipping provider release - invalid provider ID: ".concat(t.therapistId));return}const i=t.therapistType==="therapist",d=t.therapistType==="place";if(!i&&!d){e.info("‚ö†Ô∏è Unknown therapistType: ".concat(t.therapistType," for booking ").concat(t.$id));return}const r=i?s.therapists:s.places;e.info("üîç Releasing ".concat(t.therapistType," ").concat(t.therapistId," from expired booking")),(await a.getDocument(o,r,t.therapistId)).currentBookingId===t.$id?(await a.updateDocument(o,r,t.therapistId,{status:"Available",currentBookingId:null}),e.info("‚úÖ Released ".concat(t.therapistType," ").concat(t.therapistId," from expired booking"))):e.info("‚ÑπÔ∏è ".concat(t.therapistType," ").concat(t.therapistId," was not assigned to this booking"))}catch(i){i.code===404?e.info("‚ö†Ô∏è ".concat(t.therapistType||"Provider"," ").concat(t.therapistId," not found - may have been deleted")):e.error("‚ùå Error releasing ".concat(t.therapistType||"provider"," ").concat(t.therapistId,":"),i)}await this.broadcastBookingToAll(t)}catch(i){e.error("Error handling expired booking ".concat(t.$id,":"),i)}}async broadcastBookingToAll(t){try{e.info("üîç Broadcasting booking ".concat(t.$id," to ALL therapists (Available AND Busy)..."));const i=await a.listDocuments(o,s.therapists,[c.or([c.equal("status","Available"),c.equal("status","Busy")])]),d=await a.listDocuments(o,s.therapists,[]);if(e.info("üìä Therapist Status: ".concat(i.documents.length," eligible (Available + Busy) out of ").concat(d.documents.length," total")),i.documents.length===0){e.info("‚ö†Ô∏è No eligible therapists to broadcast to - all therapists may be offline or restricted");return}e.info("üì¢ Broadcasting expired booking ".concat(t.$id," to ").concat(i.documents.length," therapist(s) - FIRST TO ACCEPT GETS THE BOOKING"));for(const r of i.documents)e.info("üì± Notifying therapist ".concat(r.$id,": ").concat(r.name," (Status: ").concat(r.status,")"));await a.updateDocument(o,s.bookings,t.$id,{broadcast:!0,broadcastAt:new Date().toISOString(),broadcastCount:i.documents.length})}catch(i){e.error("Error broadcasting booking:",i)}}}const A=new g;export{A as bookingExpirationService};
