<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Site Menu Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .log { background: #f8f8f8; border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 4px; }
        .success { border-left: 4px solid #28a745; background: #d4edda; }
        .error { border-left: 4px solid #dc3545; background: #f8d7da; }
        .warning { border-left: 4px solid #ffc107; background: #fff3cd; }
        .info { border-left: 4px solid #17a2b8; background: #d1ecf1; }
        pre { white-space: pre-wrap; word-wrap: break-word; font-size: 12px; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; margin: 10px 0; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background: #0056b3; }
        .step { margin: 20px 0; padding: 15px; border: 2px solid #007bff; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Live Site Menu Debug - Surtiningsih's 12 Services</h1>
        <p>This test simulates exactly what your live site does when loading Surtiningsih's menu.</p>
        
        <div class="step">
            <h3>üìã Test Details</h3>
            <p><strong>Therapist:</strong> Surtiningsih</p>
            <p><strong>ID:</strong> 693cfadf003d16b9896a</p>
            <p><strong>Expected:</strong> 12 menu services</p>
            <p><strong>Problem:</strong> Live site shows only "1 traditional price"</p>
        </div>
        
        <button onclick="runCompleteTest()">üß™ Run Complete Live Site Simulation</button>
        
        <div id="results"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/appwrite@15.0.0"></script>
    <script>
        const { Client, Databases, Query } = Appwrite;

        // Exact same config as live site (no API key)
        const client = new Client()
            .setEndpoint('https://syd.cloud.appwrite.io/v1')
            .setProject('68f23b11000d25eb3664');

        const databases = new Databases(client);

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<pre>${message}</pre>`;
            results.appendChild(div);
            console.log(message);
        }

        async function runCompleteTest() {
            document.getElementById('results').innerHTML = '';
            log('üöÄ Starting Complete Live Site Menu Test...\n', 'info');
            
            const therapistId = '693cfadf003d16b9896a';
            const therapist = {
                name: 'Surtiningsih',
                $id: therapistId,
                id: therapistId
            };
            
            try {
                // Step 1: Simulate TherapistCard's loadMenu function
                log('üçΩÔ∏è Step 1: Loading menu for therapist: ' + therapistId, 'info');
                log('üîç Therapist name: ' + therapist.name, 'info');
                log('üîç Therapist $id: ' + therapist.$id, 'info');
                log('üîç Therapist id: ' + therapist.id, 'info');
                
                // Step 2: Call therapistMenusService.getByTherapistId (simulated)
                log('\nüìÑ Step 2: Calling therapistMenusService.getByTherapistId...', 'info');
                
                const response = await databases.listDocuments(
                    '68f76ee1000e64ca8d05',  // APPWRITE_CONFIG.databaseId
                    'therapist_menus',        // APPWRITE_CONFIG.collections.therapistMenus
                    [
                        Query.equal('therapistId', therapistId),
                        Query.orderDesc('$updatedAt'),
                        Query.limit(1)
                    ]
                );
                
                const menuDoc = response.documents[0] || null;
                log('üìÑ Menu document received: ' + (menuDoc ? 'SUCCESS' : 'NULL'), menuDoc ? 'success' : 'error');
                
                if (menuDoc) {
                    log('üìÑ Menu document ID: ' + menuDoc.$id, 'info');
                    log('üìÑ Menu document therapistId: ' + menuDoc.therapistId, 'info');
                    log('üìÑ Menu document menuData length: ' + (menuDoc.menuData?.length || 0), 'info');
                    
                    // Step 3: Parse menu data (exact same logic as TherapistCard)
                    if (menuDoc?.menuData) {
                        log('\nüîÑ Step 3: Parsing menu data...', 'info');
                        log('üìÑ Raw menuData: ' + menuDoc.menuData.substring(0, 100) + '...', 'info');
                        
                        try {
                            const parsed = JSON.parse(menuDoc.menuData);
                            log('üìÑ Parsed menuData: SUCCESS', 'success');
                            
                            // Step 4: Set menuData (simulate setMenuData call)
                            const menuData = Array.isArray(parsed) ? parsed : [];
                            log('‚úÖ Menu items loaded: ' + parsed.length, 'success');
                            
                            // Step 5: Show what would render
                            log('\nüéØ Step 5: Rendering Logic Test', 'info');
                            log('menuData.length = ' + menuData.length, 'info');
                            log('menuData.length > 0 = ' + (menuData.length > 0), menuData.length > 0 ? 'success' : 'error');
                            
                            if (menuData.length > 0) {
                                log('\n‚úÖ SUCCESS: Would show CUSTOM MENU with ' + menuData.length + ' services:', 'success');
                                menuData.forEach((service, index) => {
                                    log(`   ${index + 1}. ${service.serviceName || service.name || 'Service'}`, 'success');
                                });
                                log('\nüéâ LIVE SITE SHOULD SHOW: 12-item menu slider', 'success');
                            } else {
                                log('\n‚ùå FALLBACK: Would show "Traditional Massage" only', 'error');
                                log('üéØ LIVE SITE SHOWS: 1 traditional price', 'error');
                            }
                            
                        } catch (parseError) {
                            log('‚ùå JSON Parse Failed: ' + parseError.message, 'error');
                            log('üéØ This would cause fallback to traditional pricing', 'warning');
                        }
                        
                    } else {
                        log('\n‚ùå No menuData field in document', 'error');
                        log('üéØ This would cause fallback to traditional pricing', 'warning');
                    }
                    
                } else {
                    log('\n‚ùå No menu document found', 'error');
                    log('üéØ This would cause fallback to traditional pricing', 'warning');
                }
                
                // Final diagnosis
                log('\n' + '='.repeat(60), 'info');
                log('üè• DIAGNOSIS COMPLETE', 'info');
                
                if (menuDoc && menuDoc.menuData) {
                    const parsed = JSON.parse(menuDoc.menuData);
                    if (parsed.length === 12) {
                        log('‚úÖ Menu data is PERFECT - 12 services exist', 'success');
                        log('ü§î If live site still shows "1 traditional", the problem is:', 'warning');
                        log('   1. JavaScript errors preventing menu load', 'warning');
                        log('   2. Different therapist ID on live site', 'warning');
                        log('   3. Caching issues in browser', 'warning');
                        log('   4. Build/deployment issues', 'warning');
                        log('\nüí° SOLUTION: Check browser console on live site', 'info');
                        log('   Press F12 ‚Üí Console tab ‚Üí Look for errors', 'info');
                    }
                }
                
            } catch (error) {
                log('‚ùå MAJOR ERROR: ' + error.message, 'error');
                log('Error code: ' + error.code, 'error');
                log('Error type: ' + error.type, 'error');
                
                if (error.code === 401) {
                    log('\nüí° SOLUTION: Collection permissions issue', 'warning');
                } else if (error.code === 404) {
                    log('\nüí° SOLUTION: Collection not found', 'warning');
                } else {
                    log('\nüîç This error would cause fallback pricing', 'warning');
                }
            }
        }

        // Auto-run test after 2 seconds
        setTimeout(() => {
            runCompleteTest();
        }, 2000);
    </script>
</body>
</html>