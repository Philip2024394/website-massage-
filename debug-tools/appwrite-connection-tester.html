<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appwrite Connection Tester</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            background: #f8f9fa;
        }
        
        .status-card {
            background: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #6c757d;
        }
        
        .status-success { border-left-color: #28a745; background: #d4edda; }
        .status-warning { border-left-color: #ffc107; background: #fff3cd; }
        .status-error { border-left-color: #dc3545; background: #f8d7da; }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px;
            transition: all 0.3s;
        }
        
        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .button-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        
        .button-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        #output {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .api-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— Appwrite Connection Diagnostic Tool</h1>
        
        <div class="api-info">
            <h3>ğŸ“Š Connection Status</h3>
            <p><strong>Endpoint:</strong> https://syd.cloud.appwrite.io/v1</p>
            <p><strong>Project ID:</strong> 68f23b11000d25eb3664</p>
            <p><strong>Collection:</strong> therapists_collection_id</p>
        </div>

        <div class="grid">
            <div class="test-section">
                <h3>ğŸ” Basic Connection Tests</h3>
                <button onclick="testAppwriteEndpoint()">ğŸŒ Test Endpoint</button>
                <button onclick="testDatabaseAccess()">ğŸ’¾ Test Database Access</button>
                <button onclick="testCollectionAccess()">ğŸ“ Test Collection Access</button>
            </div>
            
            <div class="test-section">
                <h3>ğŸ‘¤ Authentication Tests</h3>
                <button onclick="checkCurrentSession()">ğŸ” Check Current Session</button>
                <button onclick="testTherapistAuth()">ğŸ‘©â€âš•ï¸ Test Therapist Auth</button>
                <button onclick="simulateLogin()">ğŸ­ Simulate Login</button>
            </div>
            
            <div class="test-section">
                <h3>ğŸ“Š Data Fetch Tests</h3>
                <button onclick="fetchAllTherapists()">ğŸ‘¥ Fetch All Therapists</button>
                <button onclick="fetchSpecificTherapist()">ğŸ¯ Fetch Specific Therapist</button>
                <button onclick="testDataPersistence()">ğŸ’¾ Test Data Persistence</button>
            </div>
            
            <div class="test-section">
                <h3>ğŸ› ï¸ Dashboard Integration</h3>
                <button onclick="simulateDashboardLoad()">ğŸ“‹ Simulate Dashboard Load</button>
                <button onclick="testProfileSave()">ğŸ’¾ Test Profile Save</button>
                <button onclick="verifyDataFlow()">ğŸ”„ Verify Data Flow</button>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸš€ Quick Diagnostics</h3>
            <button onclick="runFullTest()" class="button-success">ğŸƒâ€â™‚ï¸ Run Full Test Suite</button>
            <button onclick="debugDashboardIssue()">ğŸ”§ Debug Dashboard Issue</button>
            <button onclick="clearTestData()" class="button-danger">ğŸ—‘ï¸ Clear Test Data</button>
        </div>

        <div id="output"></div>
    </div>

    <script>
        // Appwrite configuration
        const APPWRITE_CONFIG = {
            endpoint: 'https://syd.cloud.appwrite.io/v1',
            projectId: '68f23b11000d25eb3664',
            databaseId: '68f49abc001f04513229',
            collections: {
                therapists: 'therapists_collection_id'
            }
        };

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            output.textContent += `[${timestamp}] ${icon} ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('output').textContent = '';
        }

        async function testAppwriteEndpoint() {
            clearOutput();
            log('ğŸŒ Testing Appwrite Endpoint Connection...', 'info');
            
            try {
                const response = await fetch(APPWRITE_CONFIG.endpoint + '/health', {
                    method: 'GET',
                    headers: {
                        'X-Appwrite-Project': APPWRITE_CONFIG.projectId,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('âœ… Appwrite endpoint is reachable', 'success');
                    log(`Server status: ${data.status || 'OK'}`, 'success');
                } else {
                    log(`âŒ Endpoint returned: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(`âŒ Connection failed: ${error.message}`, 'error');
                log('This could indicate network issues or incorrect endpoint', 'warning');
            }
        }

        async function testDatabaseAccess() {
            clearOutput();
            log('ğŸ’¾ Testing Database Access...', 'info');
            
            try {
                const response = await fetch(
                    `${APPWRITE_CONFIG.endpoint}/databases/${APPWRITE_CONFIG.databaseId}`,
                    {
                        method: 'GET',
                        headers: {
                            'X-Appwrite-Project': APPWRITE_CONFIG.projectId,
                            'Content-Type': 'application/json'
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    log('âœ… Database access successful', 'success');
                    log(`Database: ${data.name} (ID: ${data.$id})`, 'info');
                } else if (response.status === 401) {
                    log('âŒ Authentication required for database access', 'error');
                    log('This is normal - database requires user session', 'warning');
                } else {
                    log(`âŒ Database access failed: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âŒ Database test failed: ${error.message}`, 'error');
            }
        }

        async function testCollectionAccess() {
            clearOutput();
            log('ğŸ“ Testing Collection Access...', 'info');
            
            try {
                const response = await fetch(
                    `${APPWRITE_CONFIG.endpoint}/databases/${APPWRITE_CONFIG.databaseId}/collections/${APPWRITE_CONFIG.collections.therapists}`,
                    {
                        method: 'GET',
                        headers: {
                            'X-Appwrite-Project': APPWRITE_CONFIG.projectId,
                            'Content-Type': 'application/json'
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    log('âœ… Collection access successful', 'success');
                    log(`Collection: ${data.name} (ID: ${data.$id})`, 'info');
                    log(`Total attributes: ${data.attributes?.length || 0}`, 'info');
                } else if (response.status === 401) {
                    log('âŒ Authentication required for collection access', 'error');
                    log('This is normal - collections require user session', 'warning');
                } else {
                    log(`âŒ Collection access failed: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âŒ Collection test failed: ${error.message}`, 'error');
            }
        }

        function checkCurrentSession() {
            clearOutput();
            log('ğŸ” Checking Current Session...', 'info');
            
            const currentUser = JSON.parse(localStorage.getItem('app_current_user') || 'null');
            const therapistId = localStorage.getItem('app_therapist_id');
            const authToken = localStorage.getItem('therapist_auth_token');
            
            log('Session Analysis:', 'info');
            log(`Current User: ${currentUser ? 'âœ… Present' : 'âŒ Missing'}`, currentUser ? 'success' : 'error');
            log(`Therapist ID: ${therapistId ? 'âœ… Present' : 'âŒ Missing'}`, therapistId ? 'success' : 'error');
            log(`Auth Token: ${authToken ? 'âœ… Present' : 'âŒ Missing'}`, authToken ? 'success' : 'error');
            
            if (currentUser) {
                log(`User Details:`, 'info');
                log(`  - Name: ${currentUser.name || 'N/A'}`, 'info');
                log(`  - Email: ${currentUser.email || 'N/A'}`, 'info');
                log(`  - ID: ${currentUser.$id || 'N/A'}`, 'info');
                log(`  - Verified: ${currentUser.emailVerification ? 'âœ…' : 'âŒ'}`, 'info');
            }
            
            if (!currentUser || !therapistId) {
                log('\nğŸ”§ Action Required:', 'warning');
                log('1. Login to the therapist dashboard', 'warning');
                log('2. Ensure login process sets app_current_user', 'warning');
                log('3. Verify therapist ID is set correctly', 'warning');
            }
        }

        function testTherapistAuth() {
            clearOutput();
            log('ğŸ‘©â€âš•ï¸ Testing Therapist Authentication...', 'info');
            
            const currentUser = JSON.parse(localStorage.getItem('app_current_user') || 'null');
            const therapistId = localStorage.getItem('app_therapist_id');
            
            if (!currentUser) {
                log('âŒ No user session found', 'error');
                log('Cannot test therapist auth without login', 'warning');
                return;
            }
            
            log('Authentication Chain:', 'info');
            log(`1. User Login: âœ… Complete (${currentUser.email})`, 'success');
            log(`2. Therapist ID: ${therapistId ? 'âœ…' : 'âŒ'} ${therapistId || 'Not Set'}`, therapistId ? 'success' : 'error');
            
            // Check if therapist ID matches user ID
            if (therapistId === currentUser.$id) {
                log('3. ID Matching: âœ… Therapist ID matches User ID', 'success');
            } else {
                log('3. ID Matching: âš ï¸ IDs do not match', 'warning');
                log(`   User ID: ${currentUser.$id}`, 'info');
                log(`   Therapist ID: ${therapistId}`, 'info');
            }
            
            // Check local therapist data
            const therapists = JSON.parse(localStorage.getItem('app_therapists') || '[]');
            const matchingTherapist = therapists.find(t => t.$id === therapistId);
            
            log(`4. Local Profile: ${matchingTherapist ? 'âœ…' : 'âŒ'} ${matchingTherapist ? 'Found' : 'Not Found'}`, matchingTherapist ? 'success' : 'error');
            
            if (matchingTherapist) {
                log('Profile Quality Check:', 'info');
                log(`   - Name: ${matchingTherapist.name ? 'âœ…' : 'âŒ'}`, matchingTherapist.name ? 'success' : 'error');
                log(`   - Description: ${matchingTherapist.description ? 'âœ…' : 'âŒ'}`, matchingTherapist.description ? 'success' : 'error');
                log(`   - Pricing: ${matchingTherapist.pricing ? 'âœ…' : 'âŒ'}`, matchingTherapist.pricing ? 'success' : 'error');
                log(`   - Location: ${matchingTherapist.location ? 'âœ…' : 'âŒ'}`, matchingTherapist.location ? 'success' : 'error');
            }
        }

        function simulateLogin() {
            clearOutput();
            log('ğŸ­ Simulating Login Process...', 'info');
            
            // Create test user data
            const testUser = {
                $id: 'test_user_' + Date.now(),
                name: 'Test Therapist',
                email: 'test@example.com',
                emailVerification: true,
                $createdAt: new Date().toISOString()
            };
            
            // Set user session
            localStorage.setItem('app_current_user', JSON.stringify(testUser));
            localStorage.setItem('app_therapist_id', testUser.$id);
            localStorage.setItem('therapist_auth_token', 'test_token_' + Date.now());
            
            log('âœ… Simulated login complete', 'success');
            log(`User: ${testUser.name} (${testUser.email})`, 'info');
            log(`Therapist ID: ${testUser.$id}`, 'info');
            
            // Create minimal therapist profile
            const therapists = JSON.parse(localStorage.getItem('app_therapists') || '[]');
            const testTherapist = {
                $id: testUser.$id,
                userId: testUser.$id,
                name: testUser.name,
                email: testUser.email,
                description: 'Professional massage therapist with 5 years experience',
                location: 'Bali, Indonesia',
                whatsappNumber: '+62812345678',
                pricing: JSON.stringify({"60": 100000, "90": 150000, "120": 200000}),
                massageTypes: ['Swedish', 'Deep Tissue'],
                languages: ['English', 'Indonesian'],
                isLive: true,
                status: 'available',
                $createdAt: new Date().toISOString()
            };
            
            therapists.push(testTherapist);
            localStorage.setItem('app_therapists', JSON.stringify(therapists));
            
            log('âœ… Created test therapist profile', 'success');
            log('Now you can test dashboard functionality!', 'info');
        }

        async function fetchAllTherapists() {
            clearOutput();
            log('ğŸ‘¥ Testing Fetch All Therapists...', 'info');
            
            // First check if we have local data
            const localTherapists = JSON.parse(localStorage.getItem('app_therapists') || '[]');
            log(`Local therapist count: ${localTherapists.length}`, 'info');
            
            if (localTherapists.length > 0) {
                log('Local therapist sample:', 'info');
                localTherapists.slice(0, 3).forEach((t, i) => {
                    log(`${i + 1}. ${t.name || 'Unnamed'} - Live: ${t.isLive ? 'âœ…' : 'âŒ'}`, 'info');
                });
            }
            
            // Try to simulate Appwrite fetch (we can't actually call it without auth)
            log('\nğŸ” Appwrite Fetch Simulation:', 'info');
            log('In real dashboard, this would call:', 'info');
            log('therapistService.getAll()', 'info');
            log('â†“', 'info');
            log('databases.listDocuments(databaseId, collectionId)', 'info');
            
            if (localTherapists.length === 0) {
                log('âŒ No local data found', 'error');
                log('This suggests Appwrite fetch may have failed', 'warning');
                log('Check network connection and authentication', 'warning');
            } else {
                log('âœ… Local data exists, suggesting successful Appwrite sync', 'success');
            }
        }

        async function fetchSpecificTherapist() {
            clearOutput();
            log('ğŸ¯ Testing Fetch Specific Therapist...', 'info');
            
            const therapistId = localStorage.getItem('app_therapist_id');
            
            if (!therapistId) {
                log('âŒ No therapist ID found', 'error');
                log('Cannot test specific fetch without ID', 'warning');
                return;
            }
            
            log(`Fetching therapist ID: ${therapistId}`, 'info');
            
            // Check local data first
            const therapists = JSON.parse(localStorage.getItem('app_therapists') || '[]');
            const localTherapist = therapists.find(t => t.$id === therapistId);
            
            if (localTherapist) {
                log('âœ… Found in local storage', 'success');
                log('Profile details:', 'info');
                log(`  Name: ${localTherapist.name || 'N/A'}`, 'info');
                log(`  Description: ${localTherapist.description ? localTherapist.description.substring(0, 50) + '...' : 'N/A'}`, 'info');
                log(`  Pricing: ${localTherapist.pricing || 'N/A'}`, 'info');
                log(`  Is Live: ${localTherapist.isLive ? 'âœ…' : 'âŒ'}`, 'info');
                
                // Test pricing parsing
                if (localTherapist.pricing) {
                    try {
                        const pricing = JSON.parse(localTherapist.pricing);
                        log('Pricing breakdown:', 'info');
                        log(`  60min: ${pricing["60"]} (${pricing["60"] > 0 ? 'Valid' : 'Zero/Invalid'})`, 'info');
                        log(`  90min: ${pricing["90"]} (${pricing["90"] > 0 ? 'Valid' : 'Zero/Invalid'})`, 'info');
                        log(`  120min: ${pricing["120"]} (${pricing["120"] > 0 ? 'Valid' : 'Zero/Invalid'})`, 'info');
                    } catch (e) {
                        log(`âŒ Pricing parse error: ${e.message}`, 'error');
                    }
                }
            } else {
                log('âŒ Not found in local storage', 'error');
                log('This suggests the dashboard fetch is failing', 'warning');
            }
            
            log('\nğŸ” In real dashboard, this would call:', 'info');
            log(`therapistService.getById("${therapistId}")`, 'info');
            log('â†“', 'info');
            log('databases.getDocument(databaseId, collectionId, id)', 'info');
        }

        function testDataPersistence() {
            clearOutput();
            log('ğŸ’¾ Testing Data Persistence...', 'info');
            
            const currentUser = JSON.parse(localStorage.getItem('app_current_user') || 'null');
            const therapistId = localStorage.getItem('app_therapist_id');
            
            if (!currentUser || !therapistId) {
                log('âŒ Cannot test persistence without login', 'error');
                return;
            }
            
            log('Testing persistence chain:', 'info');
            
            // 1. Dashboard Form â†’ Local State
            log('1. Form Input â†’ Local State: âœ… (handled by React state)', 'success');
            
            // 2. Local State â†’ Appwrite
            log('2. Local State â†’ Appwrite: ğŸ” Testing...', 'info');
            log('   This calls: therapistService.update(id, data)', 'info');
            log('   Which calls: databases.updateDocument()', 'info');
            
            // 3. Appwrite â†’ Local Storage/State
            log('3. Appwrite â†’ Local Cache: ğŸ” Testing...', 'info');
            
            const debugLoad = localStorage.getItem('debug_therapist_load');
            if (debugLoad) {
                const debug = JSON.parse(debugLoad);
                log(`   Last fetch: ${debug.timestamp}`, 'info');
                log(`   Fetch success: ${debug.profileFound ? 'âœ…' : 'âŒ'}`, debug.profileFound ? 'success' : 'error');
            } else {
                log('   No debug data found', 'warning');
            }
            
            // 4. Check if data is actually persisting
            const therapists = JSON.parse(localStorage.getItem('app_therapists') || '[]');
            const currentTherapist = therapists.find(t => t.$id === therapistId);
            
            if (currentTherapist) {
                log('4. Data Persistence Status:', 'info');
                const hasCompleteData = currentTherapist.name && currentTherapist.description && currentTherapist.pricing;
                log(`   Complete profile: ${hasCompleteData ? 'âœ…' : 'âŒ'}`, hasCompleteData ? 'success' : 'error');
                
                if (currentTherapist.pricing) {
                    try {
                        const pricing = JSON.parse(currentTherapist.pricing);
                        const hasPricing = pricing["60"] > 0 || pricing["90"] > 0 || pricing["120"] > 0;
                        log(`   Valid pricing: ${hasPricing ? 'âœ…' : 'âŒ'}`, hasPricing ? 'success' : 'error');
                    } catch {
                        log('   Valid pricing: âŒ (parse error)', 'error');
                    }
                }
            } else {
                log('4. âŒ No persisted data found', 'error');
            }
        }

        function simulateDashboardLoad() {
            clearOutput();
            log('ğŸ“‹ Simulating Dashboard Load Process...', 'info');
            
            // Simulate the exact steps from TherapistDashboardPage
            log('Step 1: Component Mount', 'info');
            log('  useEffect(() => { fetchTherapistData() }, [])', 'info');
            
            log('Step 2: fetchTherapistData() called', 'info');
            const therapistId = localStorage.getItem('app_therapist_id');
            log(`  therapistId from localStorage: ${therapistId || 'null'}`, 'info');
            
            if (!therapistId) {
                log('âŒ FAILURE: No therapist ID found', 'error');
                log('Dashboard would show empty form', 'error');
                return;
            }
            
            log('Step 3: Call therapistService.getById()', 'info');
            log(`  therapistService.getById("${therapistId}")`, 'info');
            
            const therapists = JSON.parse(localStorage.getItem('app_therapists') || '[]');
            const existingTherapist = therapists.find(t => t.$id === therapistId);
            
            if (existingTherapist) {
                log('âœ… Step 4: Profile found in cache', 'success');
                log('Step 5: Setting form state...', 'info');
                log(`  setName("${existingTherapist.name || ''}")`, 'info');
                log(`  setDescription("${(existingTherapist.description || '').substring(0, 30)}...")`, 'info');
                log(`  setPricing(parsePricing("${existingTherapist.pricing || ''}"))`, 'info');
                
                // Test pricing parsing
                if (existingTherapist.pricing) {
                    try {
                        const pricing = JSON.parse(existingTherapist.pricing);
                        log('âœ… Step 6: Pricing parsed successfully', 'success');
                        log(`  60min: ${pricing["60"]}`, 'info');
                        log(`  90min: ${pricing["90"]}`, 'info');
                        log(`  120min: ${pricing["120"]}`, 'info');
                    } catch (e) {
                        log('âŒ Step 6: Pricing parse failed', 'error');
                        log(`  Error: ${e.message}`, 'error');
                    }
                }
                
                log('âœ… Dashboard load simulation complete', 'success');
                log('Form should now display existing data', 'success');
            } else {
                log('âŒ Step 4: Profile NOT found', 'error');
                log('This explains why dashboard is empty', 'warning');
                log('Possible causes:', 'warning');
                log('  - Appwrite fetch failed', 'warning');
                log('  - Wrong therapist ID', 'warning');
                log('  - Profile never created', 'warning');
            }
        }

        function testProfileSave() {
            clearOutput();
            log('ğŸ’¾ Testing Profile Save Process...', 'info');
            
            const therapistId = localStorage.getItem('app_therapist_id');
            
            if (!therapistId) {
                log('âŒ Cannot test save without therapist ID', 'error');
                return;
            }
            
            log('Simulating profile save:', 'info');
            log('1. User fills form data', 'info');
            log('2. Clicks "Save Profile"', 'info');
            log('3. handleSaveTherapist() called', 'info');
            
            // Test save data structure
            const testSaveData = {
                name: 'Test Therapist',
                description: 'Experienced massage therapist',
                pricing: JSON.stringify({"60": 100000, "90": 150000, "120": 200000}),
                location: 'Bali',
                whatsappNumber: '+62812345678',
                isLive: true
            };
            
            log('4. Save data prepared:', 'info');
            log(`   ${JSON.stringify(testSaveData, null, 2)}`, 'info');
            
            log('5. Would call: therapistService.update()', 'info');
            log(`   therapistService.update("${therapistId}", saveData)`, 'info');
            
            log('6. Appwrite update would be called:', 'info');
            log('   databases.updateDocument(databaseId, collectionId, id, data)', 'info');
            
            // Simulate successful save
            let therapists = JSON.parse(localStorage.getItem('app_therapists') || '[]');
            const existingIndex = therapists.findIndex(t => t.$id === therapistId);
            
            if (existingIndex >= 0) {
                therapists[existingIndex] = { ...therapists[existingIndex], ...testSaveData };
                localStorage.setItem('app_therapists', JSON.stringify(therapists));
                log('âœ… Local save simulation complete', 'success');
            } else {
                const newTherapist = { $id: therapistId, ...testSaveData };
                therapists.push(newTherapist);
                localStorage.setItem('app_therapists', JSON.stringify(therapists));
                log('âœ… Created new therapist profile locally', 'success');
            }
            
            log('7. Success callback would show confirmation popup', 'info');
            log('8. Dashboard would refresh with saved data', 'info');
        }

        function verifyDataFlow() {
            clearOutput();
            log('ğŸ”„ Verifying Complete Data Flow...', 'info');
            
            const steps = [
                'User Login',
                'Therapist ID Set', 
                'Dashboard Load',
                'Appwrite Fetch',
                'Form Population',
                'User Edit',
                'Profile Save',
                'Appwrite Update',
                'Data Sync',
                'Card Display'
            ];
            
            const currentUser = JSON.parse(localStorage.getItem('app_current_user') || 'null');
            const therapistId = localStorage.getItem('app_therapist_id');
            const therapists = JSON.parse(localStorage.getItem('app_therapists') || '[]');
            const currentTherapist = therapists.find(t => t.$id === therapistId);
            const debugLoad = localStorage.getItem('debug_therapist_load');
            
            log('Data Flow Verification:', 'info');
            log('===================', 'info');
            
            // Step 1: User Login
            log(`1. User Login: ${currentUser ? 'âœ…' : 'âŒ'}`, currentUser ? 'success' : 'error');
            
            // Step 2: Therapist ID
            log(`2. Therapist ID Set: ${therapistId ? 'âœ…' : 'âŒ'}`, therapistId ? 'success' : 'error');
            
            // Step 3: Dashboard Load
            log(`3. Dashboard Load: ${debugLoad ? 'âœ…' : 'âŒ'}`, debugLoad ? 'success' : 'error');
            
            // Step 4: Appwrite Fetch
            const fetchSuccess = debugLoad ? JSON.parse(debugLoad).profileFound : false;
            log(`4. Appwrite Fetch: ${fetchSuccess ? 'âœ…' : 'âŒ'}`, fetchSuccess ? 'success' : 'error');
            
            // Step 5: Form Population
            const hasFormData = currentTherapist && currentTherapist.name;
            log(`5. Form Population: ${hasFormData ? 'âœ…' : 'âŒ'}`, hasFormData ? 'success' : 'error');
            
            // Step 6-10: Future steps
            if (hasFormData) {
                log('6. User Edit: ğŸ”„ Ready for testing', 'info');
                log('7. Profile Save: ğŸ”„ Ready for testing', 'info');
                log('8. Appwrite Update: ğŸ”„ Ready for testing', 'info');
                log('9. Data Sync: ğŸ”„ Ready for testing', 'info');
                log('10. Card Display: ğŸ”„ Ready for testing', 'info');
            } else {
                log('6-10. Remaining steps: âŒ Blocked by failed form population', 'error');
            }
            
            // Overall assessment
            const completedSteps = [currentUser, therapistId, debugLoad, fetchSuccess, hasFormData].filter(Boolean).length;
            log(`\nğŸ“Š Overall Progress: ${completedSteps}/5 steps complete`, 'info');
            
            if (completedSteps < 5) {
                log('\nğŸ”§ Next Action Required:', 'warning');
                if (!currentUser) log('â€¢ Login as therapist', 'warning');
                else if (!therapistId) log('â€¢ Fix therapist ID setting', 'warning');
                else if (!debugLoad) log('â€¢ Access dashboard to trigger fetch', 'warning');
                else if (!fetchSuccess) log('â€¢ Fix Appwrite connection/auth', 'warning');
                else log('â€¢ Check form population logic', 'warning');
            } else {
                log('\nâœ… Data flow is working correctly!', 'success');
            }
        }

        async function runFullTest() {
            clearOutput();
            log('ğŸƒâ€â™‚ï¸ Running Full Test Suite...', 'info');
            log('=' .repeat(50), 'info');
            
            const tests = [
                { name: 'Endpoint Connection', fn: testAppwriteEndpoint },
                { name: 'Session Check', fn: checkCurrentSession },
                { name: 'Therapist Auth', fn: testTherapistAuth },
                { name: 'Data Fetch', fn: fetchAllTherapists },
                { name: 'Specific Fetch', fn: fetchSpecificTherapist },
                { name: 'Data Persistence', fn: testDataPersistence },
                { name: 'Dashboard Load', fn: simulateDashboardLoad },
                { name: 'Data Flow', fn: verifyDataFlow }
            ];
            
            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                log(`\nğŸ§ª Test ${i + 1}/${tests.length}: ${test.name}`, 'info');
                log('-'.repeat(30), 'info');
                
                try {
                    await test.fn();
                } catch (error) {
                    log(`âŒ Test failed: ${error.message}`, 'error');
                }
                
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            log('\nğŸ Full test suite completed!', 'success');
            log('Check results above to identify issues', 'info');
        }

        function debugDashboardIssue() {
            clearOutput();
            log('ğŸ”§ Debugging Dashboard Issue...', 'info');
            
            log('DASHBOARD ISSUE DIAGNOSIS:', 'info');
            log('==========================', 'info');
            
            const currentUser = JSON.parse(localStorage.getItem('app_current_user') || 'null');
            const therapistId = localStorage.getItem('app_therapist_id');
            const therapists = JSON.parse(localStorage.getItem('app_therapists') || '[]');
            
            // Issue 1: No user session
            if (!currentUser) {
                log('ğŸš¨ ISSUE FOUND: No user session', 'error');
                log('CAUSE: User not logged in', 'error');
                log('FIX: Go to therapist login page and login', 'warning');
                log('URL: /provider-auth (select therapist login)', 'info');
                return;
            }
            
            // Issue 2: No therapist ID
            if (!therapistId) {
                log('ğŸš¨ ISSUE FOUND: No therapist ID', 'error');
                log('CAUSE: Login process not setting therapist ID', 'error');
                log('FIX: Check login handler in ProviderAuthPage', 'warning');
                log('Should set: localStorage.setItem("app_therapist_id", userId)', 'info');
                return;
            }
            
            // Issue 3: Empty therapists array
            if (therapists.length === 0) {
                log('ğŸš¨ ISSUE FOUND: No therapist data in app', 'error');
                log('CAUSE: Appwrite fetch failed or no data exists', 'error');
                log('FIXES:', 'warning');
                log('1. Check Appwrite connection', 'info');
                log('2. Verify collection has data', 'info');
                log('3. Check authentication permissions', 'info');
                return;
            }
            
            // Issue 4: Therapist not found in data
            const currentTherapist = therapists.find(t => t.$id === therapistId);
            if (!currentTherapist) {
                log('ğŸš¨ ISSUE FOUND: Current therapist not in data', 'error');
                log(`CAUSE: Therapist ID "${therapistId}" not found in fetched data`, 'error');
                log('Available therapist IDs:', 'info');
                therapists.forEach((t, i) => {
                    log(`  ${i + 1}. ${t.$id} (${t.name || 'Unnamed'})`, 'info');
                });
                log('FIX: Check if therapist ID matches user ID', 'warning');
                return;
            }
            
            // Issue 5: Empty profile data
            const hasData = currentTherapist.name || currentTherapist.description;
            if (!hasData) {
                log('ğŸš¨ ISSUE FOUND: Therapist profile is empty', 'error');
                log('CAUSE: Profile never created or data not saved', 'error');
                log('PROFILE STATUS:', 'info');
                log(`  Name: ${currentTherapist.name || 'EMPTY'}`, 'info');
                log(`  Description: ${currentTherapist.description || 'EMPTY'}`, 'info');
                log(`  Location: ${currentTherapist.location || 'EMPTY'}`, 'info');
                log(`  Pricing: ${currentTherapist.pricing || 'EMPTY'}`, 'info');
                log('FIX: Fill out profile in dashboard and save', 'warning');
                return;
            }
            
            // Issue 6: Pricing problems
            if (currentTherapist.pricing) {
                try {
                    const pricing = JSON.parse(currentTherapist.pricing);
                    const hasPricing = pricing["60"] > 0 || pricing["90"] > 0 || pricing["120"] > 0;
                    if (!hasPricing) {
                        log('ğŸš¨ ISSUE FOUND: Pricing is all zeros', 'error');
                        log('CAUSE: Pricing not entered correctly or save failed', 'error');
                        log('PRICING VALUES:', 'info');
                        log(`  60min: ${pricing["60"]}`, 'info');
                        log(`  90min: ${pricing["90"]}`, 'info');
                        log(`  120min: ${pricing["120"]}`, 'info');
                        log('FIX: Enter pricing with "k" suffix (e.g., 100k)', 'warning');
                        return;
                    }
                } catch (e) {
                    log('ğŸš¨ ISSUE FOUND: Pricing parse error', 'error');
                    log(`CAUSE: Invalid pricing JSON: ${e.message}`, 'error');
                    log(`RAW PRICING: ${currentTherapist.pricing}`, 'info');
                    log('FIX: Re-enter pricing in dashboard', 'warning');
                    return;
                }
            }
            
            // All checks passed
            log('âœ… NO ISSUES FOUND', 'success');
            log('Dashboard should be working correctly', 'success');
            log('If you still see issues, try:', 'info');
            log('1. Refresh the dashboard page', 'info');
            log('2. Clear browser cache', 'info');
            log('3. Re-login to account', 'info');
        }

        function clearTestData() {
            clearOutput();
            log('ğŸ—‘ï¸ Clearing Test Data...', 'warning');
            
            const keysToKeep = ['app_current_user', 'app_therapist_id'];
            const keysToRemove = [
                'debug_therapist_load',
                'test_data',
                'simulation_data'
            ];
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                log(`Removed: ${key}`, 'info');
            });
            
            // Remove test users
            let therapists = JSON.parse(localStorage.getItem('app_therapists') || '[]');
            const originalCount = therapists.length;
            therapists = therapists.filter(t => !t.$id.includes('test_user_'));
            localStorage.setItem('app_therapists', JSON.stringify(therapists));
            
            const removedCount = originalCount - therapists.length;
            if (removedCount > 0) {
                log(`Removed ${removedCount} test therapist(s)`, 'info');
            }
            
            log('âœ… Test data cleared', 'success');
            log('Real user data preserved', 'info');
        }

        // Auto-run basic check on load
        window.onload = function() {
            log('ğŸ”— Appwrite Connection Tester Ready', 'success');
            log('Run tests to verify dashboard Appwrite connection', 'info');
        };
    </script>
</body>
</html>