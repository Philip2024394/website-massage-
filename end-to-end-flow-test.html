<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>End-to-End Flow Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: bold;
            margin: 5px 0;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover { background-color: #0056b3; }
        .code {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ” End-to-End Flow Diagnostic</h1>
    <p>This tool tests the complete flow: Login â†’ Dashboard â†’ Status Updates â†’ Card Display â†’ Database</p>
    
    <div class="test-section">
        <h2>ğŸ“‹ Test Checklist</h2>
        <div id="test-results">
            <div class="info">Click "Run Complete Test" to start the diagnostic...</div>
        </div>
        <button class="button" onclick="runCompleteTest()">ğŸ§ª Run Complete Test</button>
        <button class="button" onclick="testStatusButtons()">ğŸ”˜ Test Status Buttons Only</button>
        <button class="button" onclick="testCardDisplay()">ğŸ´ Test Card Display Only</button>
        <button class="button" onclick="testAppwriteConnection()">ğŸ”Œ Test Appwrite Connection</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š Current System Status</h2>
        <div id="system-status">Loading...</div>
    </div>

    <div class="test-section">
        <h2>ğŸ”§ Quick Fixes</h2>
        <button class="button" onclick="refreshPage()">ğŸ”„ Refresh Page</button>
        <button class="button" onclick="clearCache()">ğŸ—‘ï¸ Clear Cache</button>
        <button class="button" onclick="goToDashboard()">ğŸ“± Go to Dashboard</button>
        <button class="button" onclick="goToHomePage()">ğŸ  Go to Homepage</button>
    </div>

    <script>
        // Test functions
        async function runCompleteTest() {
            const results = document.getElementById('test-results');
            results.innerHTML = '<div class="info">ğŸ§ª Running complete end-to-end test...</div>';
            
            const tests = [
                { name: 'Authentication System', test: testAuthentication },
                { name: 'Appwrite Connection', test: testAppwriteConnection },
                { name: 'Therapist Data Loading', test: testDataLoading },
                { name: 'Status Button Functionality', test: testStatusButtons },
                { name: 'Card Display Connection', test: testCardDisplay },
                { name: 'Database Synchronization', test: testDatabaseSync }
            ];
            
            for (let i = 0; i < tests.length; i++) {
                const testItem = tests[i];
                results.innerHTML += `<div class="info">ğŸ“ Testing: ${testItem.name}...</div>`;
                
                try {
                    const result = await testItem.test();
                    if (result.success) {
                        results.innerHTML += `<div class="success">âœ… ${testItem.name}: ${result.message}</div>`;
                    } else {
                        results.innerHTML += `<div class="error">âŒ ${testItem.name}: ${result.message}</div>`;
                    }
                } catch (error) {
                    results.innerHTML += `<div class="error">âŒ ${testItem.name}: Error - ${error.message}</div>`;
                }
                
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            results.innerHTML += '<div class="info">ğŸ¯ Complete test finished!</div>';
        }
        
        async function testAuthentication() {
            // Check if user is logged in and can access dashboard
            try {
                const currentUrl = window.location.href;
                if (currentUrl.includes('localhost:3001') || currentUrl.includes('localhost:3000')) {
                    return { success: true, message: 'Development server accessible' };
                }
                return { success: false, message: 'Development server not accessible' };
            } catch (error) {
                return { success: false, message: 'Authentication test failed' };
            }
        }
        
        async function testAppwriteConnection() {
            // Test if Appwrite service is available
            try {
                // Check if we can access the window object and common variables
                if (typeof window !== 'undefined') {
                    return { success: true, message: 'Browser environment ready for Appwrite' };
                }
                return { success: false, message: 'Browser environment not ready' };
            } catch (error) {
                return { success: false, message: 'Appwrite connection test failed' };
            }
        }
        
        async function testDataLoading() {
            try {
                // Simulate data loading test
                const hasTherapistData = localStorage.getItem('therapist-cache') !== null;
                if (hasTherapistData) {
                    return { success: true, message: 'Therapist data found in cache' };
                }
                return { success: true, message: 'No cached data (normal on first load)' };
            } catch (error) {
                return { success: false, message: 'Data loading test failed' };
            }
        }
        
        async function testStatusButtons() {
            try {
                // Check if we're on dashboard page
                const currentUrl = window.location.href;
                if (currentUrl.includes('dashboard') || currentUrl.includes('therapist')) {
                    return { success: true, message: 'On dashboard page - status buttons should be available' };
                }
                return { success: false, message: 'Not on dashboard page - navigate to test status buttons' };
            } catch (error) {
                return { success: false, message: 'Status button test failed' };
            }
        }
        
        async function testCardDisplay() {
            try {
                // Test if on homepage
                const currentUrl = window.location.href;
                if (currentUrl.includes('localhost:3001') && !currentUrl.includes('dashboard')) {
                    return { success: true, message: 'On homepage - therapist cards should be visible' };
                }
                return { success: false, message: 'Not on homepage - navigate to see therapist cards' };
            } catch (error) {
                return { success: false, message: 'Card display test failed' };
            }
        }
        
        async function testDatabaseSync() {
            try {
                // Check console for any obvious errors
                return { success: true, message: 'Database sync test completed (check console for detailed logs)' };
            } catch (error) {
                return { success: false, message: 'Database sync test failed' };
            }
        }
        
        // System status check
        function updateSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            const currentUrl = window.location.href;
            const timestamp = new Date().toLocaleTimeString();
            
            let status = `
                <div class="info">ğŸ• Last checked: ${timestamp}</div>
                <div class="info">ğŸŒ Current URL: ${currentUrl}</div>
                <div class="info">ğŸ“± User Agent: ${navigator.userAgent.substring(0, 50)}...</div>
                <div class="info">ğŸ”— Protocol: ${window.location.protocol}</div>
                <div class="info">ğŸ  Host: ${window.location.host}</div>
            `;
            
            // Check for dev server
            if (currentUrl.includes('localhost:3001')) {
                status += '<div class="success">âœ… Development server detected (Port 3001)</div>';
            } else if (currentUrl.includes('localhost:3000')) {
                status += '<div class="warning">âš ï¸ Development server detected (Port 3000)</div>';
            } else {
                status += '<div class="error">âŒ Not on development server</div>';
            }
            
            statusDiv.innerHTML = status;
        }
        
        // Quick action functions
        function refreshPage() {
            window.location.reload();
        }
        
        function clearCache() {
            localStorage.clear();
            sessionStorage.clear();
            alert('âœ… Cache cleared! Refresh the page to reload fresh data.');
        }
        
        function goToDashboard() {
            window.location.href = '/dashboard';
        }
        
        function goToHomePage() {
            window.location.href = '/';
        }
        
        // Initialize
        updateSystemStatus();
        setInterval(updateSystemStatus, 30000); // Update every 30 seconds
        
        // Instructions
        console.log('ğŸ” End-to-End Flow Test Instructions:');
        console.log('1. Make sure you are on http://localhost:3001');
        console.log('2. Login to therapist dashboard');
        console.log('3. Test Available/Busy/Offline buttons');
        console.log('4. Go to homepage to see if status reflects on cards');
        console.log('5. Check browser console for detailed logs');
    </script>
</body>
</html>