<!DOCTYPE html>
<html>
<head>
    <title>LocationId Migration Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@15.0.0"></script>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #00ff00; }
        .log { margin: 5px 0; }
        .success { color: #00ff00; }
        .error { color: #ff4444; }
        .warning { color: #ffaa00; }
        .info { color: #4488ff; }
        button { padding: 10px 20px; margin: 10px; background: #333; color: #fff; border: 1px solid #555; cursor: pointer; }
        button:hover { background: #555; }
        pre { background: #333; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîÑ LocationId Migration Tool</h1>
    <div>
        <button onclick="checkLocationIds()">1. Check Current LocationIds</button>
        <button onclick="migrateLocationIds()">2. Migrate Missing LocationIds</button>
        <button onclick="verifyMigration()">3. Verify Migration</button>
    </div>
    <div id="output"></div>

    <script>
        const { Client, Databases } = Appwrite;

        const client = new Client()
            .setEndpoint('https://cloud.appwrite.io/v1')
            .setProject('67449e4a002f5e205dd8');

        const databases = new Databases(client);

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = message;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }

        function convertLocationToId(location) {
            if (!location) return null;
            
            const normalized = location.toLowerCase().trim();
            
            // Yogyakarta aliases
            if (normalized.includes('yogyakarta') || normalized.includes('jogja') || normalized.includes('yogya')) {
                return 'yogyakarta';
            }
            
            // Bandung aliases  
            if (normalized.includes('bandung')) {
                return 'bandung';
            }
            
            // Jakarta aliases
            if (normalized.includes('jakarta')) {
                return 'jakarta';
            }
            
            // Denpasar/Bali aliases
            if (normalized.includes('denpasar') || normalized.includes('bali')) {
                return 'denpasar';
            }
            
            // Ubud
            if (normalized.includes('ubud')) {
                return 'ubud';
            }
            
            // Canggu  
            if (normalized.includes('canggu')) {
                return 'canggu';
            }
            
            // Seminyak
            if (normalized.includes('seminyak')) {
                return 'seminyak';
            }
            
            // Surabaya
            if (normalized.includes('surabaya')) {
                return 'surabaya';
            }
            
            // Semarang
            if (normalized.includes('semarang')) {
                return 'semarang';
            }
            
            // Default: convert to slug format
            return location.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '');
        }

        async function checkLocationIds() {
            try {
                log('üîç Checking current locationId status...', 'info');
                
                const response = await databases.listDocuments('674853ad00198e73fa74', 'therapists', [
                    Appwrite.Query.limit(100)
                ]);
                
                const therapists = response.documents;
                log(`üìä Found ${therapists.length} therapists`, 'info');
                
                const withLocationId = therapists.filter(t => t.locationId && t.locationId.trim());
                const withoutLocationId = therapists.filter(t => !t.locationId || !t.locationId.trim());
                
                log(`‚úÖ With locationId: ${withLocationId.length}`, 'success');
                log(`‚ùå Without locationId: ${withoutLocationId.length}`, 'error');
                
                if (withoutLocationId.length > 0) {
                    log('<br>üö® Therapists missing locationId:', 'warning');
                    withoutLocationId.slice(0, 10).forEach(t => {
                        const suggestedId = convertLocationToId(t.location);
                        log(`  ‚Ä¢ ${t.name}: "${t.location || 'NULL'}" ‚Üí "${suggestedId}"`, 'warning');
                    });
                    if (withoutLocationId.length > 10) {
                        log(`  ... and ${withoutLocationId.length - 10} more`, 'warning');
                    }
                }
                
                // Show location distribution
                log('<br>üìã Current location distribution:', 'info');
                const locationCounts = {};
                therapists.forEach(t => {
                    const locationId = t.locationId || convertLocationToId(t.location) || 'unknown';
                    locationCounts[locationId] = (locationCounts[locationId] || 0) + 1;
                });
                
                Object.entries(locationCounts)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([locationId, count]) => {
                        log(`  ${locationId}: ${count} therapists`, 'info');
                    });
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function migrateLocationIds() {
            try {
                log('üîÑ Starting locationId migration...', 'info');
                
                const response = await databases.listDocuments('674853ad00198e73fa74', 'therapists', [
                    Appwrite.Query.limit(100)
                ]);
                
                const therapists = response.documents;
                const needsMigration = therapists.filter(t => 
                    (!t.locationId || t.locationId.trim() === '') && t.location
                );
                
                log(`üéØ Found ${needsMigration.length} therapists needing migration`, 'info');
                
                if (needsMigration.length === 0) {
                    log('‚úÖ No therapists need locationId migration!', 'success');
                    return;
                }
                
                let migrated = 0;
                let errors = 0;
                
                for (const therapist of needsMigration) {
                    try {
                        const locationId = convertLocationToId(therapist.location);
                        
                        if (locationId) {
                            await databases.updateDocument(
                                '674853ad00198e73fa74',
                                'therapists', 
                                therapist.$id,
                                { locationId }
                            );
                            
                            log(`‚úÖ Migrated ${therapist.name}: locationId="${locationId}"`, 'success');
                            migrated++;
                        } else {
                            log(`‚ö†Ô∏è Skipped ${therapist.name}: could not determine locationId`, 'warning');
                        }
                        
                        // Small delay to avoid rate limits
                        await new Promise(resolve => setTimeout(resolve, 200));
                        
                    } catch (error) {
                        log(`‚ùå Failed to migrate ${therapist.name}: ${error.message}`, 'error');
                        errors++;
                    }
                }
                
                log(`<br>üéâ Migration Complete!`, 'success');
                log(`‚úÖ Successfully migrated: ${migrated}`, 'success');
                log(`‚ùå Errors: ${errors}`, errors > 0 ? 'error' : 'info');
                
            } catch (error) {
                log(`‚ùå Migration failed: ${error.message}`, 'error');
            }
        }

        async function verifyMigration() {
            await checkLocationIds();
        }
        
        // Auto-check on load
        document.addEventListener('DOMContentLoaded', () => {
            log('üîß LocationId Migration Tool Ready', 'success');
            log('Click "Check Current LocationIds" to analyze the current state', 'info');
        });
    </script>
</body>
</html>