<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Data Debug Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .debug-section {
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .issue {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .solution {
            background: #d1edff;
            border: 1px solid #b8daff;
            color: #004085;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        .error { color: #dc3545; }
        .success { color: #28a745; }
        .warning { color: #ffc107; }
        
        #output {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-good { background-color: #28a745; }
        .status-bad { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Profile Data Debug Tool</h1>
        
        <div class="issue">
            <h3>âŒ Current Issues</h3>
            <ul>
                <li><strong>Therapist profile page is empty</strong> - No saved data showing</li>
                <li><strong>Pricing shows "Contact"</strong> - Values not loading correctly</li>
                <li><strong>Data persistence problems</strong> - Profile not saving properly</li>
            </ul>
        </div>

        <div class="grid">
            <div class="card">
                <h3>ğŸ“Š Database Check</h3>
                <button onclick="checkAppwriteConnection()">ğŸ” Check Appwrite Data</button>
                <button onclick="checkLocalStorage()">ğŸ’¾ Check Local Storage</button>
            </div>
            
            <div class="card">
                <h3>ğŸ” Authentication</h3>
                <button onclick="checkAuth()">ğŸ‘¤ Check Login Status</button>
                <button onclick="checkTherapistId()">ğŸ†” Check Therapist ID</button>
            </div>
            
            <div class="card">
                <h3>ğŸ’° Pricing Debug</h3>
                <button onclick="debugPricing()">ğŸ’¸ Debug Pricing Logic</button>
                <button onclick="testPricingSave()">ğŸ’¾ Test Pricing Save</button>
            </div>
            
            <div class="card">
                <h3>ğŸ”„ Data Flow</h3>
                <button onclick="traceDataFlow()">ğŸ“Š Trace Complete Flow</button>
                <button onclick="fixDataIssues()">ğŸ› ï¸ Auto-Fix Issues</button>
            </div>
        </div>

        <div class="debug-section">
            <h3>ğŸ¯ Quick Diagnostics</h3>
            <button onclick="runFullDiagnostic()">ğŸš€ Run Full Diagnostic</button>
            <button onclick="resetAndTest()">ğŸ”„ Reset & Test</button>
            <button onclick="generateReport()">ğŸ“‹ Generate Report</button>
        </div>

        <div id="output"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            output.textContent += `[${timestamp}] ${icon} ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('output').textContent = '';
        }

        function checkAppwriteConnection() {
            clearOutput();
            log('ğŸ” Checking Appwrite Connection...', 'info');
            
            // Check if we can access app state
            try {
                const therapists = JSON.parse(localStorage.getItem('app_therapists') || '[]');
                const currentUser = JSON.parse(localStorage.getItem('app_current_user') || 'null');
                
                log(`Found ${therapists.length} therapists in app state`, therapists.length > 0 ? 'success' : 'warning');
                log(`Current user: ${currentUser ? currentUser.name || currentUser.email : 'Not logged in'}`, currentUser ? 'success' : 'error');
                
                if (therapists.length > 0) {
                    log('\nğŸ“‹ Therapist Data Summary:', 'info');
                    therapists.forEach((therapist, index) => {
                        const hasData = therapist.name && therapist.description && therapist.pricing;
                        log(`${index + 1}. ${therapist.name || 'Unnamed'} - Data: ${hasData ? 'âœ… Complete' : 'âŒ Incomplete'}`, hasData ? 'success' : 'error');
                        
                        if (therapist.pricing) {
                            try {
                                const pricing = typeof therapist.pricing === 'string' ? JSON.parse(therapist.pricing) : therapist.pricing;
                                const hasPrices = pricing && (pricing["60"] > 0 || pricing["90"] > 0 || pricing["120"] > 0);
                                log(`   ğŸ’° Pricing: ${hasPrices ? 'Valid' : 'Empty/Zero'}`, hasPrices ? 'success' : 'warning');
                            } catch (e) {
                                log(`   ğŸ’° Pricing: Parse Error - ${e.message}`, 'error');
                            }
                        }
                    });
                }
                
                // Check debug info
                const debugLoad = localStorage.getItem('debug_therapist_load');
                if (debugLoad) {
                    const debug = JSON.parse(debugLoad);
                    log(`\nğŸ” Last Profile Load: ${debug.timestamp}`, 'info');
                    log(`   Profile Found: ${debug.profileFound ? 'âœ… Yes' : 'âŒ No'}`, debug.profileFound ? 'success' : 'error');
                    log(`   Is Live: ${debug.isLive ? 'âœ… Yes' : 'âŒ No'}`, debug.isLive ? 'success' : 'warning');
                }
                
            } catch (error) {
                log(`Error checking app data: ${error.message}`, 'error');
            }
        }

        function checkLocalStorage() {
            clearOutput();
            log('ğŸ’¾ Checking Local Storage...', 'info');
            
            const keys = [
                'app_current_user',
                'app_therapists', 
                'app_therapist_id',
                'app_user_session',
                'debug_therapist_load',
                'therapist_auth_token'
            ];
            
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    try {
                        const parsed = JSON.parse(value);
                        log(`${key}: ${typeof parsed === 'object' ? 'Object with ' + Object.keys(parsed).length + ' keys' : parsed}`, 'success');
                    } catch {
                        log(`${key}: ${value.substring(0, 50)}...`, 'success');
                    }
                } else {
                    log(`${key}: Not found`, 'warning');
                }
            });
        }

        function checkAuth() {
            clearOutput();
            log('ğŸ‘¤ Checking Authentication Status...', 'info');
            
            const currentUser = JSON.parse(localStorage.getItem('app_current_user') || 'null');
            const therapistId = localStorage.getItem('app_therapist_id');
            const authToken = localStorage.getItem('therapist_auth_token');
            
            log(`Current User: ${currentUser ? 'âœ… Logged In' : 'âŒ Not Logged In'}`, currentUser ? 'success' : 'error');
            if (currentUser) {
                log(`   Name: ${currentUser.name || 'N/A'}`, 'info');
                log(`   Email: ${currentUser.email || 'N/A'}`, 'info');
                log(`   User ID: ${currentUser.$id || 'N/A'}`, 'info');
            }
            
            log(`Therapist ID: ${therapistId ? 'âœ… Found' : 'âŒ Missing'}`, therapistId ? 'success' : 'error');
            log(`Auth Token: ${authToken ? 'âœ… Present' : 'âŒ Missing'}`, authToken ? 'success' : 'error');
            
            if (!currentUser || !therapistId) {
                log('\nğŸ”§ FIX: You need to login as a therapist first!', 'warning');
                log('1. Go to therapist login page', 'info');
                log('2. Enter email and password', 'info');
                log('3. Make sure login is successful', 'info');
                log('4. Then try accessing the dashboard', 'info');
            }
        }

        function checkTherapistId() {
            clearOutput();
            log('ğŸ†” Checking Therapist ID Mapping...', 'info');
            
            const currentUser = JSON.parse(localStorage.getItem('app_current_user') || 'null');
            const therapistId = localStorage.getItem('app_therapist_id');
            const therapists = JSON.parse(localStorage.getItem('app_therapists') || '[]');
            
            if (currentUser) {
                log(`User ID: ${currentUser.$id}`, 'info');
            }
            
            if (therapistId) {
                log(`Therapist ID: ${therapistId}`, 'info');
                
                // Find matching therapist
                const matchingTherapist = therapists.find(t => t.$id === therapistId || t.userId === currentUser?.$id);
                if (matchingTherapist) {
                    log(`âœ… Found matching therapist: ${matchingTherapist.name}`, 'success');
                    log(`   Has Profile Data: ${matchingTherapist.name ? 'âœ… Yes' : 'âŒ No'}`, matchingTherapist.name ? 'success' : 'error');
                } else {
                    log('âŒ No matching therapist found!', 'error');
                    log('This means the therapist ID doesn\'t match any therapist in the database', 'warning');
                }
            } else {
                log('âŒ No therapist ID found', 'error');
            }
        }

        function debugPricing() {
            clearOutput();
            log('ğŸ’° Debugging Pricing Logic...', 'info');
            
            const therapists = JSON.parse(localStorage.getItem('app_therapists') || '[]');
            
            if (therapists.length === 0) {
                log('âŒ No therapist data found', 'error');
                return;
            }
            
            log('Checking pricing for all therapists:', 'info');
            
            therapists.forEach((therapist, index) => {
                log(`\n${index + 1}. ${therapist.name || 'Unnamed'}:`, 'info');
                log(`   Raw pricing data: ${therapist.pricing || 'null'}`, 'info');
                
                try {
                    if (therapist.pricing) {
                        const pricing = typeof therapist.pricing === 'string' ? JSON.parse(therapist.pricing) : therapist.pricing;
                        log(`   Parsed pricing:`, 'info');
                        log(`     60min: ${pricing["60"]} (shows as: ${formatPriceForCard(pricing["60"])})`, 'info');
                        log(`     90min: ${pricing["90"]} (shows as: ${formatPriceForCard(pricing["90"])})`, 'info');
                        log(`     120min: ${pricing["120"]} (shows as: ${formatPriceForCard(pricing["120"])})`, 'info');
                        
                        const hasValidPricing = pricing["60"] > 0 || pricing["90"] > 0 || pricing["120"] > 0;
                        log(`   Result: ${hasValidPricing ? 'âœ… Will show prices' : 'âŒ Will show "Contact"'}`, hasValidPricing ? 'success' : 'error');
                    } else {
                        log(`   âŒ No pricing data`, 'error');
                    }
                } catch (error) {
                    log(`   âŒ Pricing parse error: ${error.message}`, 'error');
                }
            });
        }
        
        function formatPriceForCard(price) {
            const numPrice = typeof price === 'string' ? parseFloat(price) : price;
            if (!numPrice || numPrice === 0 || isNaN(numPrice)) {
                return "Contact";
            }
            return `Rp ${Math.round(numPrice / 1000)}K`;
        }

        function testPricingSave() {
            clearOutput();
            log('ğŸ’¾ Testing Pricing Save Logic...', 'info');
            
            // Simulate dashboard pricing input
            const testInputs = ['100k', '150k', '200k'];
            
            testInputs.forEach((input, index) => {
                const duration = [60, 90, 120][index];
                
                // Simulate the handlePriceChange logic
                const cleanValue = input.toLowerCase().replace(/[^\dk]/g, '');
                let savedValue = 0;
                
                if (cleanValue.endsWith('k')) {
                    const digits = cleanValue.slice(0, -1);
                    if (digits.length >= 1 && digits.length <= 3) {
                        savedValue = parseInt(digits, 10) * 1000;
                    }
                }
                
                const displayValue = formatPriceForCard(savedValue);
                
                log(`${duration}min: "${input}" â†’ Saved as: ${savedValue} â†’ Card shows: "${displayValue}"`, 
                    savedValue > 0 ? 'success' : 'error');
            });
            
            log('\nğŸ¯ If pricing shows "Contact" on cards:', 'warning');
            log('1. Check if prices are being entered correctly (with "k")', 'info');
            log('2. Verify the handlePriceChange function is working', 'info');
            log('3. Confirm data is being saved to Appwrite properly', 'info');
        }

        function traceDataFlow() {
            clearOutput();
            log('ğŸ“Š Tracing Complete Data Flow...', 'info');
            
            log('1. LOGIN FLOW:', 'info');
            const currentUser = JSON.parse(localStorage.getItem('app_current_user') || 'null');
            log(`   User logged in: ${currentUser ? 'âœ…' : 'âŒ'}`, currentUser ? 'success' : 'error');
            
            log('\n2. THERAPIST ID FLOW:', 'info');
            const therapistId = localStorage.getItem('app_therapist_id');
            log(`   Therapist ID set: ${therapistId ? 'âœ…' : 'âŒ'}`, therapistId ? 'success' : 'error');
            
            log('\n3. DATA LOADING FLOW:', 'info');
            const debugLoad = localStorage.getItem('debug_therapist_load');
            if (debugLoad) {
                const debug = JSON.parse(debugLoad);
                log(`   Profile fetch attempted: âœ… (${debug.timestamp})`, 'success');
                log(`   Profile found in DB: ${debug.profileFound ? 'âœ…' : 'âŒ'}`, debug.profileFound ? 'success' : 'error');
            } else {
                log(`   Profile fetch attempted: âŒ`, 'error');
            }
            
            log('\n4. FORM STATE FLOW:', 'info');
            const therapists = JSON.parse(localStorage.getItem('app_therapists') || '[]');
            const currentTherapist = therapists.find(t => t.$id === therapistId);
            if (currentTherapist) {
                log(`   Profile data loaded to form: âœ…`, 'success');
                log(`     Name: ${currentTherapist.name ? 'âœ…' : 'âŒ'}`, currentTherapist.name ? 'success' : 'error');
                log(`     Description: ${currentTherapist.description ? 'âœ…' : 'âŒ'}`, currentTherapist.description ? 'success' : 'error');
                log(`     Pricing: ${currentTherapist.pricing ? 'âœ…' : 'âŒ'}`, currentTherapist.pricing ? 'success' : 'error');
            } else {
                log(`   Profile data loaded to form: âŒ`, 'error');
            }
            
            log('\n5. CARD DISPLAY FLOW:', 'info');
            if (currentTherapist && currentTherapist.pricing) {
                try {
                    const pricing = JSON.parse(currentTherapist.pricing);
                    const hasValidPricing = pricing["60"] > 0 || pricing["90"] > 0 || pricing["120"] > 0;
                    log(`   Cards show pricing: ${hasValidPricing ? 'âœ…' : 'âŒ'}`, hasValidPricing ? 'success' : 'error');
                } catch {
                    log(`   Cards show pricing: âŒ (parse error)`, 'error');
                }
            } else {
                log(`   Cards show pricing: âŒ (no data)`, 'error');
            }
        }

        function fixDataIssues() {
            clearOutput();
            log('ğŸ› ï¸ Attempting Auto-Fix...', 'info');
            
            const currentUser = JSON.parse(localStorage.getItem('app_current_user') || 'null');
            const therapistId = localStorage.getItem('app_therapist_id');
            
            if (!currentUser) {
                log('âŒ Cannot fix: No user logged in', 'error');
                log('Please login first, then try again', 'warning');
                return;
            }
            
            if (!therapistId) {
                log('ğŸ”§ Attempting to set therapist ID...', 'info');
                if (currentUser.$id) {
                    localStorage.setItem('app_therapist_id', currentUser.$id);
                    log('âœ… Set therapist ID to user ID', 'success');
                } else {
                    log('âŒ Cannot set therapist ID: No user ID', 'error');
                    return;
                }
            }
            
            // Try to create minimal profile if missing
            let therapists = JSON.parse(localStorage.getItem('app_therapists') || '[]');
            const existingTherapist = therapists.find(t => t.$id === therapistId);
            
            if (!existingTherapist) {
                log('ğŸ”§ Creating minimal therapist profile...', 'info');
                const newTherapist = {
                    $id: therapistId,
                    userId: currentUser.$id,
                    name: currentUser.name || 'My Profile',
                    email: currentUser.email,
                    description: '',
                    profilePicture: '',
                    location: '',
                    whatsappNumber: '',
                    pricing: JSON.stringify({"60": 0, "90": 0, "120": 0}),
                    massageTypes: [],
                    languages: [],
                    isLive: false,
                    createdAt: new Date().toISOString()
                };
                
                therapists.push(newTherapist);
                localStorage.setItem('app_therapists', JSON.stringify(therapists));
                log('âœ… Created minimal profile', 'success');
            } else {
                log('âœ… Therapist profile exists', 'success');
            }
            
            log('\nğŸ¯ Next steps:', 'info');
            log('1. Refresh the dashboard page', 'info');
            log('2. Fill in your profile details', 'info');
            log('3. Enter pricing with "k" (e.g., 100k, 150k)', 'info');
            log('4. Save the profile', 'info');
        }

        function runFullDiagnostic() {
            clearOutput();
            log('ğŸš€ Running Full Diagnostic...', 'info');
            log('================================', 'info');
            
            setTimeout(() => checkAuth(), 500);
            setTimeout(() => log('\n' + '='.repeat(50), 'info'), 1000);
            setTimeout(() => checkAppwriteConnection(), 1500);
            setTimeout(() => log('\n' + '='.repeat(50), 'info'), 2000);
            setTimeout(() => debugPricing(), 2500);
            setTimeout(() => log('\n' + '='.repeat(50), 'info'), 3000);
            setTimeout(() => traceDataFlow(), 3500);
            setTimeout(() => {
                log('\nğŸ¯ DIAGNOSTIC COMPLETE', 'success');
                log('Check the results above to identify issues', 'info');
            }, 4000);
        }

        function resetAndTest() {
            clearOutput();
            log('ğŸ”„ Performing Reset & Test...', 'info');
            
            // Clear debug data
            localStorage.removeItem('debug_therapist_load');
            log('âœ… Cleared debug data', 'success');
            
            // Check if basic auth is working
            const currentUser = JSON.parse(localStorage.getItem('app_current_user') || 'null');
            if (currentUser) {
                log('âœ… User session preserved', 'success');
                
                // Force refresh therapist ID
                if (currentUser.$id) {
                    localStorage.setItem('app_therapist_id', currentUser.$id);
                    log('âœ… Reset therapist ID', 'success');
                }
            } else {
                log('âŒ No user session - please login again', 'error');
            }
            
            log('\nğŸ¯ Ready for testing:', 'info');
            log('1. Go to therapist dashboard', 'info');
            log('2. Check if profile data loads', 'info');
            log('3. Try entering and saving data', 'info');
        }

        function generateReport() {
            clearOutput();
            log('ğŸ“‹ PROFILE DATA DIAGNOSTIC REPORT', 'info');
            log('=====================================', 'info');
            log(`Generated: ${new Date().toLocaleString()}`, 'info');
            
            // Authentication Status
            const currentUser = JSON.parse(localStorage.getItem('app_current_user') || 'null');
            const therapistId = localStorage.getItem('app_therapist_id');
            
            log('\nğŸ” AUTHENTICATION:', 'info');
            log(`User Logged In: ${currentUser ? 'âœ… YES' : 'âŒ NO'}`, currentUser ? 'success' : 'error');
            log(`Therapist ID Set: ${therapistId ? 'âœ… YES' : 'âŒ NO'}`, therapistId ? 'success' : 'error');
            
            // Data Status
            const therapists = JSON.parse(localStorage.getItem('app_therapists') || '[]');
            const currentTherapist = therapists.find(t => t.$id === therapistId);
            
            log('\nğŸ“Š DATA STATUS:', 'info');
            log(`Total Therapists in App: ${therapists.length}`, 'info');
            log(`Current Therapist Profile: ${currentTherapist ? 'âœ… FOUND' : 'âŒ MISSING'}`, currentTherapist ? 'success' : 'error');
            
            if (currentTherapist) {
                log(`  Name: ${currentTherapist.name || 'âŒ EMPTY'}`, currentTherapist.name ? 'success' : 'error');
                log(`  Description: ${currentTherapist.description ? 'âœ… SET' : 'âŒ EMPTY'}`, currentTherapist.description ? 'success' : 'error');
                log(`  Profile Picture: ${currentTherapist.profilePicture ? 'âœ… SET' : 'âŒ EMPTY'}`, currentTherapist.profilePicture ? 'success' : 'error');
                log(`  WhatsApp: ${currentTherapist.whatsappNumber ? 'âœ… SET' : 'âŒ EMPTY'}`, currentTherapist.whatsappNumber ? 'success' : 'error');
                log(`  Location: ${currentTherapist.location ? 'âœ… SET' : 'âŒ EMPTY'}`, currentTherapist.location ? 'success' : 'error');
                
                // Pricing analysis
                if (currentTherapist.pricing) {
                    try {
                        const pricing = JSON.parse(currentTherapist.pricing);
                        const hasValidPricing = pricing["60"] > 0 || pricing["90"] > 0 || pricing["120"] > 0;
                        log(`  Pricing: ${hasValidPricing ? 'âœ… VALID' : 'âŒ ALL ZERO'}`, hasValidPricing ? 'success' : 'error');
                        log(`    60min: ${pricing["60"]} (${formatPriceForCard(pricing["60"])})`, 'info');
                        log(`    90min: ${pricing["90"]} (${formatPriceForCard(pricing["90"])})`, 'info');
                        log(`    120min: ${pricing["120"]} (${formatPriceForCard(pricing["120"])})`, 'info');
                    } catch {
                        log(`  Pricing: âŒ PARSE ERROR`, 'error');
                    }
                } else {
                    log(`  Pricing: âŒ NULL/UNDEFINED`, 'error');
                }
            }
            
            // Recommendations
            log('\nğŸ¯ RECOMMENDATIONS:', 'info');
            if (!currentUser) {
                log('1. â— LOGIN REQUIRED - Go to therapist login page', 'warning');
            } else if (!therapistId) {
                log('1. â— THERAPIST ID MISSING - Contact support', 'warning');
            } else if (!currentTherapist) {
                log('1. â— PROFILE MISSING - Create new therapist profile', 'warning');
            } else {
                if (!currentTherapist.name) log('1. ğŸ“ Add your name to profile', 'warning');
                if (!currentTherapist.description) log('2. ğŸ“ Add description to profile', 'warning');
                if (!currentTherapist.pricing || JSON.parse(currentTherapist.pricing)["60"] === 0) {
                    log('3. ğŸ’° Set pricing (use format: 100k, 150k, 200k)', 'warning');
                }
                if (!currentTherapist.location) log('4. ğŸ“ Add location to profile', 'warning');
            }
            
            log('\nâœ… Report Complete - Share this with support if needed', 'success');
        }

        // Auto-run basic check on page load
        window.onload = function() {
            setTimeout(() => {
                log('ğŸ”§ Profile Data Debug Tool Ready', 'success');
                log('Click any button above to start debugging', 'info');
            }, 500);
        };
    </script>
</body>
</html>