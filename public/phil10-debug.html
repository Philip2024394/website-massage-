<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ Phil10 Language Debug</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@16.0.2"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 1000px; 
            margin: 0 auto; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container { 
            background: rgba(255, 255, 255, 0.95); 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
            margin: 20px 0; 
            color: #333;
        }
        .debug-info { 
            font-family: monospace; 
            font-size: 12px; 
            background: #f9f9f9; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 6px; 
            border-left: 4px solid #2196F3; 
            white-space: pre-wrap;
        }
        .success { color: #4CAF50; font-weight: bold; }
        .warning { color: #ff9800; font-weight: bold; }
        .error { color: #f44336; font-weight: bold; }
        button { 
            background: linear-gradient(45deg, #2196F3, #21CBF3); 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 8px; 
            font-weight: 600; 
            transition: all 0.3s ease;
        }
        button:hover { 
            transform: translateY(-2px); 
        }
        h1 { text-align: center; }
        .step { 
            background: #e3f2fd; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border-left: 4px solid #2196F3; 
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ Phil10 Language Issue Debug</h1>
    <p style="text-align: center;">Specific debugging for phil10 therapist language data</p>

    <div class="container">
        <h2>ğŸ¯ Issue Summary</h2>
        <div class="step">
            <strong>Problem:</strong> Phil10 selected 2 languages in dashboard, saved successfully (green notification), but languages don't appear on home page therapist card.
        </div>
        
        <div class="step">
            <strong>Expected:</strong> Languages should appear under massage types section with flags (ğŸ‡¬ğŸ‡§ EN ğŸ‡®ğŸ‡© ID)
        </div>
        
        <div class="step">
            <strong>Error:</strong> âŒ Failed to fetch - suggests Appwrite connection or data retrieval issue
        </div>
    </div>

    <div class="container">
        <h2>ğŸ” Step-by-Step Diagnosis</h2>
        
        <button onclick="step1_checkConnection()">ğŸ”— Step 1: Check Appwrite Connection</button>
        <div id="step1-result" class="debug-info" style="display: none;"></div>

        <button onclick="step2_findPhil10()">ğŸ‘¤ Step 2: Find Phil10 in Database</button>
        <div id="step2-result" class="debug-info" style="display: none;"></div>

        <button onclick="step3_checkLanguageData()">ğŸŒ Step 3: Check Phil10's Language Data</button>
        <div id="step3-result" class="debug-info" style="display: none;"></div>

        <button onclick="step4_testParseFunction()">ğŸ”§ Step 4: Test parseLanguages Function</button>
        <div id="step4-result" class="debug-info" style="display: none;"></div>

        <button onclick="step5_checkHomePageData()">ğŸ  Step 5: Check Home Page Data Flow</button>
        <div id="step5-result" class="debug-info" style="display: none;"></div>
    </div>

    <div class="container">
        <h2>ğŸš€ Quick Fixes</h2>
        <button onclick="quickFix_refreshData()" style="background: linear-gradient(45deg, #4CAF50, #66bb6a);">ğŸ”„ Force Refresh Phil10 Data</button>
        <button onclick="quickFix_testLanguages()" style="background: linear-gradient(45deg, #ff9800, #ffb74d);">ğŸ§ª Test Language Display</button>
        <div id="quickfix-result" class="debug-info" style="display: none;"></div>
    </div>

    <script>
        // Appwrite Configuration
        const CONFIG = {
            endpoint: 'https://syd.cloud.appwrite.io/v1',
            projectId: '68f23b11000d25eb3664',
            databaseId: '68f76ee1000e64ca8d05',
            therapistsCollection: 'therapists_collection_id'
        };

        const { Client, Databases, Account } = Appwrite;
        const client = new Client()
            .setEndpoint(CONFIG.endpoint)
            .setProject(CONFIG.projectId);
        const databases = new Databases(client);
        const account = new Account(client);

        let phil10Data = null;

        function log(message, elementId, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'block';
                const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : '';
                const timestamp = new Date().toLocaleTimeString();
                element.innerHTML += `[${timestamp}] ${message}\n`;
                if (className) element.className += ` ${className}`;
            }
            console.log(`ğŸ”§ ${message}`);
        }

        async function step1_checkConnection() {
            const resultId = 'step1-result';
            document.getElementById(resultId).innerHTML = '';
            log('ğŸ”— Testing Appwrite connection...', resultId);

            try {
                // Try to create anonymous session
                try {
                    await account.createAnonymousSession();
                    log('âœ… Anonymous session created successfully', resultId, 'success');
                } catch (e) {
                    log(`â„¹ï¸ Session already exists or minor error: ${e.message}`, resultId);
                }

                // Test database connection
                const response = await databases.listDocuments(CONFIG.databaseId, CONFIG.therapistsCollection, []);
                log(`âœ… Database connection successful! Found ${response.documents.length} therapists`, resultId, 'success');
                
                return true;
            } catch (error) {
                log(`âŒ Connection failed: ${error.message}`, resultId, 'error');
                log(`ğŸ” Check: Endpoint: ${CONFIG.endpoint}`, resultId);
                log(`ğŸ” Check: Project ID: ${CONFIG.projectId}`, resultId);
                log(`ğŸ” Check: Database ID: ${CONFIG.databaseId}`, resultId);
                return false;
            }
        }

        async function step2_findPhil10() {
            const resultId = 'step2-result';
            document.getElementById(resultId).innerHTML = '';
            log('ğŸ‘¤ Searching for Phil10 therapist...', resultId);

            try {
                const response = await databases.listDocuments(CONFIG.databaseId, CONFIG.therapistsCollection);
                log(`ğŸ“Š Scanning ${response.documents.length} therapist records...`, resultId);

                // Look for phil10 by various possible identifiers
                const phil10Candidates = response.documents.filter(therapist => {
                    const name = (therapist.name || '').toLowerCase();
                    const email = (therapist.email || '').toLowerCase();
                    const id = (therapist.$id || '').toLowerCase();
                    
                    return name.includes('phil') || name.includes('10') || 
                           email.includes('phil') || email.includes('10') ||
                           id.includes('phil') || id.includes('10');
                });

                if (phil10Candidates.length === 0) {
                    log('âŒ No therapist found matching "phil10" criteria', resultId, 'error');
                    log('ğŸ” Available therapists:', resultId);
                    response.documents.slice(0, 5).forEach((t, i) => {
                        log(`   ${i+1}. Name: "${t.name}" | Email: "${t.email}" | ID: "${t.$id}"`, resultId);
                    });
                    return false;
                }

                log(`âœ… Found ${phil10Candidates.length} potential phil10 candidates:`, resultId, 'success');
                phil10Candidates.forEach((therapist, index) => {
                    log(`   ${index+1}. Name: "${therapist.name}" | Email: "${therapist.email}"`, resultId);
                    log(`      ID: ${therapist.$id}`, resultId);
                    log(`      Languages: ${therapist.languages || 'null'}`, resultId);
                });

                // Use the first candidate as phil10
                phil10Data = phil10Candidates[0];
                log(`ğŸ¯ Using first candidate as Phil10: ${phil10Data.name}`, resultId, 'success');
                return true;

            } catch (error) {
                log(`âŒ Error finding Phil10: ${error.message}`, resultId, 'error');
                return false;
            }
        }

        async function step3_checkLanguageData() {
            const resultId = 'step3-result';
            document.getElementById(resultId).innerHTML = '';
            
            if (!phil10Data) {
                log('âŒ Phil10 data not found. Run Step 2 first.', resultId, 'error');
                return;
            }

            log(`ğŸŒ Analyzing Phil10's language data...`, resultId);
            log(`ğŸ“‹ Therapist: ${phil10Data.name} (${phil10Data.$id})`, resultId);
            
            const languageField = phil10Data.languages;
            log(`ğŸ” Raw language field: ${JSON.stringify(languageField)}`, resultId);
            log(`ğŸ” Type: ${typeof languageField}`, resultId);
            log(`ğŸ” Is null/undefined: ${languageField == null}`, resultId);
            log(`ğŸ” Is empty string: ${languageField === ''}`, resultId);
            
            if (languageField) {
                try {
                    if (typeof languageField === 'string') {
                        const parsed = JSON.parse(languageField);
                        log(`âœ… Successfully parsed: ${JSON.stringify(parsed)}`, resultId, 'success');
                        log(`âœ… Array length: ${parsed.length}`, resultId, 'success');
                        log(`âœ… Is array: ${Array.isArray(parsed)}`, resultId, 'success');
                        
                        if (parsed.length === 0) {
                            log(`âš ï¸ Languages array is empty - this is why they don't display!`, resultId, 'warning');
                        }
                    } else if (Array.isArray(languageField)) {
                        log(`âœ… Already an array: ${JSON.stringify(languageField)}`, resultId, 'success');
                    }
                } catch (error) {
                    log(`âŒ Parse error: ${error.message}`, resultId, 'error');
                }
            } else {
                log(`âŒ No language data found - this is why languages don't display!`, resultId, 'error');
            }
        }

        async function step4_testParseFunction() {
            const resultId = 'step4-result';
            document.getElementById(resultId).innerHTML = '';
            log(`ğŸ”§ Testing enhanced parseLanguages function...`, resultId);

            // Simulate the enhanced parseLanguages function
            function parseLanguages(languagesString) {
                log(`ğŸ”§ parseLanguages input: ${JSON.stringify(languagesString)} (${typeof languagesString})`, resultId);
                
                if (!languagesString) {
                    log(`ğŸ”§ parseLanguages: No input, returning empty array`, resultId);
                    return [];
                }
                
                if (Array.isArray(languagesString)) {
                    log(`ğŸ”§ parseLanguages: Input is already array: ${JSON.stringify(languagesString)}`, resultId);
                    return languagesString;
                }
                
                if (typeof languagesString === 'string') {
                    if (languagesString.trim() === '') {
                        log(`ğŸ”§ parseLanguages: Empty string, returning empty array`, resultId);
                        return [];
                    }
                    
                    try {
                        const parsed = JSON.parse(languagesString);
                        if (Array.isArray(parsed)) {
                            log(`ğŸ”§ parseLanguages: Successfully parsed JSON array: ${JSON.stringify(parsed)}`, resultId);
                            return parsed;
                        } else {
                            log(`ğŸ”§ parseLanguages: Parsed JSON is not array: ${JSON.stringify(parsed)}`, resultId);
                            return [];
                        }
                    } catch (error) {
                        log(`ğŸ”§ parseLanguages: JSON parse failed, trying comma split: ${error.message}`, resultId);
                        const splitResult = languagesString.split(',').map(l => l.trim()).filter(l => l.length > 0);
                        log(`ğŸ”§ parseLanguages: Comma split result: ${JSON.stringify(splitResult)}`, resultId);
                        return splitResult;
                    }
                }
                
                log(`ğŸ”§ parseLanguages: Unexpected input type, returning empty array`, resultId);
                return [];
            }

            if (phil10Data && phil10Data.languages != null) {
                const result = parseLanguages(phil10Data.languages);
                log(`âœ… parseLanguages result: ${JSON.stringify(result)}`, resultId, 'success');
                log(`âœ… Would display ${result.length} language(s) on card`, resultId, 'success');
            } else {
                log(`âš ï¸ No language data to test with`, resultId, 'warning');
            }
        }

        async function step5_checkHomePageData() {
            const resultId = 'step5-result';
            document.getElementById(resultId).innerHTML = '';
            log(`ğŸ  Checking home page data flow...`, resultId);

            log(`ğŸ” Open http://localhost:3000/ and check browser console for:`, resultId);
            log(`   ğŸ  HomePage passing to TherapistCard: { languages: ... }`, resultId);
            log(`   ğŸŒ TherapistCard Debug - Raw therapist.languages: ...`, resultId);
            log(`   ğŸŒ TherapistCard Debug - Parsed languages: ...`, resultId);
            
            if (phil10Data) {
                log(`ğŸ¯ Look specifically for therapist: ${phil10Data.name}`, resultId);
                log(`ğŸ¯ Expected language data: ${phil10Data.languages || 'null'}`, resultId);
            }
            
            setTimeout(() => {
                window.open('http://localhost:3000/', '_blank');
            }, 2000);
        }

        async function quickFix_refreshData() {
            const resultId = 'quickfix-result';
            document.getElementById(resultId).innerHTML = '';
            log(`ğŸ”„ Attempting to refresh Phil10 data...`, resultId);

            try {
                // Re-fetch Phil10 data
                await step2_findPhil10();
                
                if (phil10Data) {
                    log(`âœ… Phil10 data refreshed: ${phil10Data.name}`, resultId, 'success');
                    log(`ğŸŒ Current languages: ${phil10Data.languages || 'none'}`, resultId);
                    
                    // If no languages, suggest what to do
                    if (!phil10Data.languages || phil10Data.languages === '[]' || phil10Data.languages === '') {
                        log(`âš ï¸ SOLUTION: Go to therapist dashboard and re-save languages:`, resultId, 'warning');
                        log(`   1. Go to http://localhost:3000/`, resultId);
                        log(`   2. Login as Phil10 therapist`, resultId);
                        log(`   3. Select languages again`, resultId);
                        log(`   4. Click Save Profile`, resultId);
                        log(`   5. Check if database gets updated`, resultId);
                    }
                } else {
                    log(`âŒ Could not refresh Phil10 data`, resultId, 'error');
                }
            } catch (error) {
                log(`âŒ Refresh failed: ${error.message}`, resultId, 'error');
            }
        }

        async function quickFix_testLanguages() {
            const resultId = 'quickfix-result';
            document.getElementById(resultId).innerHTML = '';
            log(`ğŸ§ª Testing language display with sample data...`, resultId);

            // Test with sample language data
            const testCases = [
                '["English", "Indonesian"]',
                '[]',
                '',
                null,
                undefined,
                'English,Indonesian',
                ['English', 'Indonesian']
            ];

            testCases.forEach((testCase, index) => {
                log(`Test ${index + 1}: Input: ${JSON.stringify(testCase)}`, resultId);
                // This would use the enhanced parseLanguages function
                log(`  Expected result: parseLanguages would handle this case`, resultId);
            });
            
            log(`ğŸ¯ The issue is likely that Phil10's language data is empty/null in database`, resultId, 'warning');
            log(`ğŸ”§ Solution: Re-save languages in therapist dashboard`, resultId, 'success');
        }

        // Auto-run when page loads
        window.addEventListener('load', () => {
            console.log('ğŸ”§ Phil10 Language Debug Tool Loaded');
            console.log('ğŸ¯ Click buttons above to diagnose the language display issue');
        });
    </script>
</body>
</html>