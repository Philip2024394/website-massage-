<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Therapist Cards Diagnostic Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .diagnostic-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #ddd;
        }
        
        .success { border-left-color: #4CAF50; background: #f1f8e9; }
        .warning { border-left-color: #ff9800; background: #fff3e0; }
        .error { border-left-color: #f44336; background: #ffebee; }
        .info { border-left-color: #2196F3; background: #e3f2fd; }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        button:hover {
            background: #5a67d8;
        }
        
        .data-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-available { background-color: #4CAF50; }
        .status-busy { background-color: #ff9800; }
        .status-offline { background-color: #f44336; }
    </style>
</head>
<body>
    <div class="diagnostic-header">
        <h1>üîç Therapist Cards Diagnostic Tool</h1>
        <p>Diagnose why therapist cards are not displaying on the live site</p>
    </div>

    <div class="test-section">
        <h2>üåê Network & API Tests</h2>
        <button onclick="testAppwriteConnection()">Test Appwrite Connection</button>
        <button onclick="testTherapistAPI()">Test Therapist API</button>
        <button onclick="testDataLoading()">Test Data Loading Process</button>
        <div id="network-results"></div>
    </div>

    <div class="test-section">
        <h2>üìä Therapist Data Analysis</h2>
        <button onclick="analyzeTherapistData()">Analyze Therapist Data</button>
        <button onclick="checkLiveStatus()">Check Live Status</button>
        <button onclick="testFiltering()">Test Filtering Logic</button>
        <div id="data-analysis-results"></div>
    </div>

    <div class="test-section">
        <h2>üó∫Ô∏è Location & Distance Tests</h2>
        <button onclick="testLocationServices()">Test Location Services</button>
        <button onclick="testNearbyFiltering()">Test Nearby Filtering</button>
        <div id="location-results"></div>
    </div>

    <div class="test-section">
        <h2>üîß Configuration Check</h2>
        <button onclick="checkConfiguration()">Check App Configuration</button>
        <button onclick="checkEnvironment()">Check Environment</button>
        <div id="config-results"></div>
    </div>

    <script>
        const APPWRITE_CONFIG = {
            endpoint: 'https://syd.cloud.appwrite.io/v1',
            projectId: '68f23b11000d25eb3664',
            databaseId: '68f76ee1000e64ca8d05',
            collections: {
                therapists: '68f76f60001f58b9877c'
            }
        };

        // Test Appwrite connection
        async function testAppwriteConnection() {
            const resultsDiv = document.getElementById('network-results');
            resultsDiv.innerHTML = '<div class="test-result info">Testing Appwrite connection...</div>';
            
            try {
                const response = await fetch(`${APPWRITE_CONFIG.endpoint}/health`);
                if (response.ok) {
                    resultsDiv.innerHTML += '<div class="test-result success">‚úÖ Appwrite server is reachable</div>';
                } else {
                    resultsDiv.innerHTML += '<div class="test-result error">‚ùå Appwrite server returned error: ' + response.status + '</div>';
                }
            } catch (error) {
                resultsDiv.innerHTML += '<div class="test-result error">‚ùå Cannot reach Appwrite server: ' + error.message + '</div>';
            }
        }

        // Test therapist API directly
        async function testTherapistAPI() {
            const resultsDiv = document.getElementById('network-results');
            resultsDiv.innerHTML += '<div class="test-result info">Testing therapist API...</div>';
            
            try {
                const url = `${APPWRITE_CONFIG.endpoint}/databases/${APPWRITE_CONFIG.databaseId}/collections/${APPWRITE_CONFIG.collections.therapists}/documents`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Appwrite-Project': APPWRITE_CONFIG.projectId
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    resultsDiv.innerHTML += `<div class="test-result success">‚úÖ Therapist API accessible - Found ${data.documents.length} therapists</div>`;
                    
                    // Quick analysis
                    const liveTherapists = data.documents.filter(t => t.isLive === true);
                    resultsDiv.innerHTML += `<div class="test-result info">üìä Live therapists: ${liveTherapists.length} out of ${data.documents.length}</div>`;
                    
                } else {
                    resultsDiv.innerHTML += '<div class="test-result error">‚ùå Therapist API error: ' + response.status + '</div>';
                }
            } catch (error) {
                resultsDiv.innerHTML += '<div class="test-result error">‚ùå API request failed: ' + error.message + '</div>';
            }
        }

        // Analyze therapist data in detail
        async function analyzeTherapistData() {
            const resultsDiv = document.getElementById('data-analysis-results');
            resultsDiv.innerHTML = '<div class="test-result info">Analyzing therapist data...</div>';
            
            try {
                const url = `${APPWRITE_CONFIG.endpoint}/databases/${APPWRITE_CONFIG.databaseId}/collections/${APPWRITE_CONFIG.collections.therapists}/documents`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Appwrite-Project': APPWRITE_CONFIG.projectId
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const therapists = data.documents;
                    
                    let analysis = '<div class="test-result success">‚úÖ Retrieved ' + therapists.length + ' therapists</div>';
                    
                    // Analyze each therapist
                    const liveTherapists = [];
                    const offlineTherapists = [];
                    const missingLiveField = [];
                    
                    therapists.forEach(therapist => {
                        if (therapist.isLive === true) {
                            liveTherapists.push(therapist);
                        } else if (therapist.isLive === false) {
                            offlineTherapists.push(therapist);
                        } else {
                            missingLiveField.push(therapist);
                        }
                    });
                    
                    analysis += `<div class="test-result info">
                        üìä Data Breakdown:
                        <br>‚Ä¢ Live therapists (isLive: true): ${liveTherapists.length}
                        <br>‚Ä¢ Offline therapists (isLive: false): ${offlineTherapists.length}
                        <br>‚Ä¢ Missing isLive field: ${missingLiveField.length}
                    </div>`;
                    
                    // Sample therapist details
                    if (therapists.length > 0) {
                        const sampleTherapist = therapists[0];
                        analysis += '<div class="test-result info">üìù Sample therapist data:<div class="data-display"><pre>' + 
                            JSON.stringify({
                                id: sampleTherapist.$id,
                                name: sampleTherapist.name,
                                isLive: sampleTherapist.isLive,
                                status: sampleTherapist.status,
                                coordinates: sampleTherapist.coordinates,
                                massageTypes: sampleTherapist.massageTypes
                            }, null, 2) + '</pre></div></div>';
                    }
                    
                    resultsDiv.innerHTML = analysis;
                    
                } else {
                    resultsDiv.innerHTML += '<div class="test-result error">‚ùå Failed to fetch therapist data</div>';
                }
            } catch (error) {
                resultsDiv.innerHTML += '<div class="test-result error">‚ùå Error analyzing data: ' + error.message + '</div>';
            }
        }

        // Check live status specifically
        async function checkLiveStatus() {
            const resultsDiv = document.getElementById('data-analysis-results');
            resultsDiv.innerHTML += '<div class="test-result info">Checking live status...</div>';
            
            try {
                const url = `${APPWRITE_CONFIG.endpoint}/databases/${APPWRITE_CONFIG.databaseId}/collections/${APPWRITE_CONFIG.collections.therapists}/documents`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Appwrite-Project': APPWRITE_CONFIG.projectId
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const therapists = data.documents;
                    
                    let statusReport = '<div class="test-result info">üîç Live Status Report:<br><br>';
                    
                    therapists.forEach((therapist, index) => {
                        const liveStatus = therapist.isLive;
                        const statusIndicator = liveStatus === true ? 
                            '<span class="status-indicator status-available"></span>' :
                            liveStatus === false ?
                            '<span class="status-indicator status-offline"></span>' :
                            '<span class="status-indicator status-busy"></span>';
                            
                        statusReport += `${statusIndicator}${therapist.name || 'Unnamed'} - isLive: ${liveStatus}<br>`;
                    });
                    
                    statusReport += '</div>';
                    resultsDiv.innerHTML += statusReport;
                    
                } else {
                    resultsDiv.innerHTML += '<div class="test-result error">‚ùå Failed to check live status</div>';
                }
            } catch (error) {
                resultsDiv.innerHTML += '<div class="test-result error">‚ùå Error checking live status: ' + error.message + '</div>';
            }
        }

        // Test filtering logic
        async function testFiltering() {
            const resultsDiv = document.getElementById('data-analysis-results');
            resultsDiv.innerHTML += '<div class="test-result info">Testing filtering logic...</div>';
            
            try {
                const url = `${APPWRITE_CONFIG.endpoint}/databases/${APPWRITE_CONFIG.databaseId}/collections/${APPWRITE_CONFIG.collections.therapists}/documents`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Appwrite-Project': APPWRITE_CONFIG.projectId
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const therapists = data.documents;
                    
                    // Apply the same filtering logic as the app
                    const liveTherapists = therapists.filter(t => t.isLive === true);
                    const allMassageTypes = therapists.filter(t => 
                        t.isLive === true && (t.massageTypes && t.massageTypes.includes('Traditional Indonesian'))
                    );
                    
                    let filterReport = `<div class="test-result info">
                        üîç Filtering Results:
                        <br>‚Ä¢ Total therapists: ${therapists.length}
                        <br>‚Ä¢ After isLive filter: ${liveTherapists.length}
                        <br>‚Ä¢ With Traditional Indonesian: ${allMassageTypes.length}
                    </div>`;
                    
                    if (liveTherapists.length === 0) {
                        filterReport += '<div class="test-result warning">‚ö†Ô∏è No live therapists found! This is why cards are not showing.</div>';
                        filterReport += '<div class="test-result info">üí° Solution: Set isLive: true for therapists in the database</div>';
                    }
                    
                    resultsDiv.innerHTML += filterReport;
                    
                } else {
                    resultsDiv.innerHTML += '<div class="test-result error">‚ùå Failed to test filtering</div>';
                }
            } catch (error) {
                resultsDiv.innerHTML += '<div class="test-result error">‚ùå Error testing filters: ' + error.message + '</div>';
            }
        }

        // Test location services
        async function testLocationServices() {
            const resultsDiv = document.getElementById('location-results');
            resultsDiv.innerHTML = '<div class="test-result info">Testing location services...</div>';
            
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resultsDiv.innerHTML += '<div class="test-result success">‚úÖ Geolocation working - Lat: ' + 
                            position.coords.latitude + ', Lng: ' + position.coords.longitude + '</div>';
                    },
                    (error) => {
                        resultsDiv.innerHTML += '<div class="test-result warning">‚ö†Ô∏è Geolocation error: ' + error.message + '</div>';
                        resultsDiv.innerHTML += '<div class="test-result info">‚ÑπÔ∏è App should fallback to showing all therapists</div>';
                    }
                );
            } else {
                resultsDiv.innerHTML += '<div class="test-result error">‚ùå Geolocation not supported</div>';
            }
        }

        // Check app configuration
        function checkConfiguration() {
            const resultsDiv = document.getElementById('config-results');
            
            let configReport = '<div class="test-result info">üîß Configuration Check:<div class="data-display"><pre>';
            configReport += 'Appwrite Endpoint: ' + APPWRITE_CONFIG.endpoint + '\n';
            configReport += 'Project ID: ' + APPWRITE_CONFIG.projectId + '\n';
            configReport += 'Database ID: ' + APPWRITE_CONFIG.databaseId + '\n';
            configReport += 'Therapists Collection: ' + APPWRITE_CONFIG.collections.therapists + '\n';
            configReport += 'Current URL: ' + window.location.href + '\n';
            configReport += 'User Agent: ' + navigator.userAgent + '\n';
            configReport += '</pre></div></div>';
            
            resultsDiv.innerHTML = configReport;
        }

        // Check environment
        function checkEnvironment() {
            const resultsDiv = document.getElementById('config-results');
            
            let envReport = '<div class="test-result info">üåç Environment Check:<div class="data-display"><pre>';
            envReport += 'Is HTTPS: ' + (location.protocol === 'https:') + '\n';
            envReport += 'Domain: ' + location.hostname + '\n';
            envReport += 'Is Local: ' + (location.hostname === 'localhost' || location.hostname === '127.0.0.1') + '\n';
            envReport += 'Console Errors: Check browser console for errors\n';
            envReport += 'Network Tab: Check network tab for failed requests\n';
            envReport += '</pre></div></div>';
            
            resultsDiv.innerHTML += envReport;
        }

        // Run automatic tests on page load
        window.addEventListener('load', () => {
            console.log('üîç Therapist Cards Diagnostic Tool loaded');
            console.log('Run tests to diagnose why therapist cards are not showing');
        });
    </script>
</body>
</html>