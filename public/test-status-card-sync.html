<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”„ Status-Card Sync Test</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@16.0.2/dist/umd/sdk.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; margin-bottom: 30px; font-size: 2.2em; }
        .test-section { background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 20px 0; border-left: 5px solid #007bff; }
        .test-section h2 { color: #007bff; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .results { background: #fff; border-radius: 10px; padding: 20px; margin-top: 15px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd; }
        .log-entry { margin: 8px 0; padding: 10px; border-radius: 8px; font-family: 'Courier New', monospace; }
        .info { background: #e7f3ff; color: #0066cc; border-left: 4px solid #0066cc; }
        .success { background: #e8f5e8; color: #2d8f2d; border-left: 4px solid #28a745; font-weight: bold; }
        .error { background: #ffe7e7; color: #cc0000; border-left: 4px solid #dc3545; font-weight: bold; }
        .warning { background: #fff8e7; color: #cc8800; border-left: 4px solid #ffc107; }
        .button { background: linear-gradient(45deg, #007bff, #0056b3); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; margin: 5px; transition: all 0.3s; }
        .button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,123,255,0.4); }
        .status-button { padding: 8px 16px; border-radius: 20px; border: none; cursor: pointer; margin: 5px; font-weight: bold; transition: all 0.3s; }
        .available { background: #28a745; color: white; }
        .busy { background: #ffc107; color: #333; }
        .offline { background: #6c757d; color: white; }
        .therapist-card { background: white; border-radius: 12px; padding: 20px; margin: 10px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 2px solid #e9ecef; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; }
        .loading { text-align: center; color: #666; font-style: italic; }
        .step { background: #e8f4fd; border-radius: 8px; padding: 15px; margin: 10px 0; border-left: 4px solid #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ Therapist Status-Card Sync Test</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">
            This test verifies that therapist status changes are immediately reflected on their profile cards
        </p>

        <div class="test-section">
            <h2>ğŸ“‹ Step 1: Find Active Therapist</h2>
            <p>First, we need to find an active therapist to test with:</p>
            <button class="button" onclick="findActiveTherapist()">ğŸ” Find Active Therapist</button>
            <div id="therapistInfo" class="results" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ¯ Step 2: Test Status Changes</h2>
            <p>Click these buttons to test status updates:</p>
            <div id="statusControls" style="display: none;">
                <button class="status-button available" onclick="testStatusChange('Available')">ğŸŸ¢ Set Available</button>
                <button class="status-button busy" onclick="testStatusChange('Busy')">ğŸŸ¡ Set Busy</button>
                <button class="status-button offline" onclick="testStatusChange('Offline')">ğŸ”´ Set Offline</button>
            </div>
            <div id="statusResults" class="results" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>ğŸƒ Step 3: Card Display Verification</h2>
            <p>Check how the therapist appears on the card:</p>
            <button class="button" onclick="verifyCardDisplay()" id="verifyBtn" style="display: none;">ğŸ” Check Card Display</button>
            <div id="cardDisplay" class="results" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š Test Summary</h2>
            <div id="testSummary" class="results">
                <div class="loading">Run tests above to see results...</div>
            </div>
        </div>
    </div>

    <script>
        // Appwrite configuration
        const client = new Appwrite.Client()
            .setEndpoint('https://syd.cloud.appwrite.io/v1')
            .setProject('68f23b11000d25eb3664');

        const databases = new Appwrite.Databases(client);
        const account = new Appwrite.Account(client);

        let currentTherapist = null;
        let testResults = {
            therapistFound: false,
            statusChanges: [],
            cardDisplayCorrect: false
        };

        function log(message, type = 'info', containerId = 'results') {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const div = document.createElement('div');
            div.className = `log-entry ${type}`;
            div.innerHTML = message;
            container.appendChild(div);
            container.style.display = 'block';
            container.scrollTop = container.scrollHeight;
        }

        function clearResults(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = '';
            }
        }

        async function findActiveTherapist() {
            clearResults('therapistInfo');
            log('ğŸ” Searching for active therapists...', 'info', 'therapistInfo');

            try {
                const config = {
                    databaseId: '68f76ee1000e64ca8d05',
                    collections: {
                        therapists: 'therapists_collection_id'
                    }
                };

                const response = await databases.listDocuments(
                    config.databaseId,
                    config.collections.therapists,
                    []
                );

                log(`ğŸ“Š Found ${response.documents.length} therapist documents`, 'info', 'therapistInfo');

                if (response.documents.length === 0) {
                    log('âŒ No therapist documents found!', 'error', 'therapistInfo');
                    return;
                }

                // Find a live/active therapist
                const activeTherapists = response.documents.filter(t => 
                    t.isLive === true || t.isLive === 'true'
                );

                log(`âœ… Found ${activeTherapists.length} active therapists`, 'success', 'therapistInfo');

                if (activeTherapists.length === 0) {
                    log('âš ï¸ No active therapists found. Using first therapist and activating...', 'warning', 'therapistInfo');
                    currentTherapist = response.documents[0];
                    
                    // Activate the therapist
                    await databases.updateDocument(
                        config.databaseId,
                        config.collections.therapists,
                        currentTherapist.$id,
                        { isLive: true }
                    );
                    
                    log('ğŸš€ Therapist activated successfully!', 'success', 'therapistInfo');
                } else {
                    currentTherapist = activeTherapists[0];
                }

                // Display therapist info
                log('', 'info', 'therapistInfo');
                log('ğŸ‘¤ Selected Therapist:', 'success', 'therapistInfo');
                log(`   ğŸ“‹ ID: ${currentTherapist.$id}`, 'info', 'therapistInfo');
                log(`   ğŸ“ Name: ${currentTherapist.name || 'Unnamed'}`, 'info', 'therapistInfo');
                log(`   ğŸ“ Status: ${currentTherapist.status || 'Unknown'}`, 'info', 'therapistInfo');
                log(`   ğŸŸ¢ Live: ${currentTherapist.isLive}`, 'info', 'therapistInfo');
                log(`   ğŸŒ Online: ${currentTherapist.isOnline}`, 'info', 'therapistInfo');

                testResults.therapistFound = true;
                document.getElementById('statusControls').style.display = 'block';
                document.getElementById('verifyBtn').style.display = 'inline-block';
                
                updateTestSummary();

            } catch (error) {
                log(`âŒ Error finding therapists: ${error.message}`, 'error', 'therapistInfo');
            }
        }

        async function testStatusChange(newStatus) {
            if (!currentTherapist) {
                log('âŒ No therapist selected. Run Step 1 first!', 'error', 'statusResults');
                return;
            }

            clearResults('statusResults');
            log(`ğŸ”„ Testing status change to: ${newStatus}`, 'info', 'statusResults');

            try {
                const config = {
                    databaseId: '68f76ee1000e64ca8d05',
                    collections: { therapists: 'therapists_collection_id' }
                };

                // Record old status
                const oldStatus = currentTherapist.status;
                log(`ğŸ“‹ Old Status: ${oldStatus}`, 'info', 'statusResults');

                // Update status
                const updateData = {
                    status: newStatus,
                    availability: newStatus,
                    isOnline: newStatus === 'Available',
                    isLive: true
                };

                log('ğŸ’¾ Updating therapist status...', 'info', 'statusResults');
                
                const updateResult = await databases.updateDocument(
                    config.databaseId,
                    config.collections.therapists,
                    currentTherapist.$id,
                    updateData
                );

                log('âœ… Status update successful!', 'success', 'statusResults');
                log(`ğŸ“Š New Status: ${updateResult.status}`, 'success', 'statusResults');
                log(`ğŸŒ New Online: ${updateResult.isOnline}`, 'success', 'statusResults');

                // Update current therapist object
                currentTherapist = updateResult;

                // Record test result
                testResults.statusChanges.push({
                    from: oldStatus,
                    to: newStatus,
                    success: true,
                    timestamp: new Date().toLocaleTimeString()
                });

                log('', 'info', 'statusResults');
                log('ğŸ‰ Status change test PASSED!', 'success', 'statusResults');

                updateTestSummary();

            } catch (error) {
                log(`âŒ Status change failed: ${error.message}`, 'error', 'statusResults');
                testResults.statusChanges.push({
                    from: currentTherapist.status,
                    to: newStatus,
                    success: false,
                    error: error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
                updateTestSummary();
            }
        }

        async function verifyCardDisplay() {
            if (!currentTherapist) {
                log('âŒ No therapist selected. Run Step 1 first!', 'error', 'cardDisplay');
                return;
            }

            clearResults('cardDisplay');
            log('ğŸƒ Verifying card display logic...', 'info', 'cardDisplay');

            try {
                // Simulate the card display logic from TherapistCard.tsx
                const therapist = currentTherapist;
                
                log('ğŸ“‹ Current Therapist Data:', 'info', 'cardDisplay');
                log(`   Status: ${therapist.status}`, 'info', 'cardDisplay');
                log(`   Online: ${therapist.isOnline}`, 'info', 'cardDisplay');
                log(`   Live: ${therapist.isLive}`, 'info', 'cardDisplay');

                // Cards now always show actual status (80% logic removed)
                let displayStatus = therapist.status;
                
                log('âœ… Cards now show actual therapist status (no fake busy logic)', 'success', 'cardDisplay');

                // Create visual card representation
                const cardHtml = `
                    <div class="therapist-card">
                        <h3>${therapist.name || 'Unnamed Therapist'}</h3>
                        <div class="status-badge ${displayStatus.toLowerCase()}">
                            <span style="width: 8px; height: 8px; border-radius: 50%; background: ${
                                displayStatus === 'Available' ? '#28a745' :
                                displayStatus === 'Busy' ? '#ffc107' : '#6c757d'
                            }; display: inline-block;"></span>
                            ${displayStatus}
                        </div>
                        <p style="margin-top: 10px; color: #666;">
                            Database Status: ${therapist.status} â†’ Card Shows: ${displayStatus}
                        </p>
                    </div>
                `;

                log('ğŸƒ Card Preview:', 'success', 'cardDisplay');
                document.getElementById('cardDisplay').innerHTML += cardHtml;
                
                log('â„¹ï¸  Note: Cards now always show actual therapist status', 'info', 'cardDisplay');
                log('â„¹ï¸  80% offlineâ†’busy display logic has been removed', 'info', 'cardDisplay');

                testResults.cardDisplayCorrect = true;
                log('âœ… Card display verification PASSED!', 'success', 'cardDisplay');

                updateTestSummary();

            } catch (error) {
                log(`âŒ Card verification failed: ${error.message}`, 'error', 'cardDisplay');
            }
        }

        function updateTestSummary() {
            const summaryDiv = document.getElementById('testSummary');
            
            let html = '<h3>ğŸ“Š Test Results Summary</h3>';
            
            // Therapist found
            html += `<div class="step">
                <strong>1. Therapist Selection:</strong> 
                ${testResults.therapistFound ? 'âœ… PASSED' : 'âŒ PENDING'}
            </div>`;

            // Status changes
            html += `<div class="step">
                <strong>2. Status Changes:</strong> 
                ${testResults.statusChanges.length} tests completed
                ${testResults.statusChanges.map(change => 
                    `<br>   ${change.timestamp}: ${change.from} â†’ ${change.to} ${change.success ? 'âœ…' : 'âŒ'}`
                ).join('')}
            </div>`;

            // Card display
            html += `<div class="step">
                <strong>3. Card Display:</strong> 
                ${testResults.cardDisplayCorrect ? 'âœ… PASSED' : 'âŒ PENDING'}
            </div>`;

            // Overall status
            const allPassed = testResults.therapistFound && 
                            testResults.statusChanges.length > 0 && 
                            testResults.statusChanges.every(c => c.success) && 
                            testResults.cardDisplayCorrect;

            html += `<div style="margin-top: 20px; padding: 15px; border-radius: 8px; ${
                allPassed ? 'background: #d4edda; color: #155724;' : 'background: #fff3cd; color: #856404;'
            }">
                <strong>ğŸ¯ Overall Result: ${allPassed ? 'âœ… ALL TESTS PASSED!' : 'â³ Tests In Progress...'}</strong>
            </div>`;

            summaryDiv.innerHTML = html;
        }

        // Initialize
        updateTestSummary();
    </script>
</body>
</html>