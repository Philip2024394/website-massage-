<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ Live Therapist Language Test</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@16.0.2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 10px 0; }
        .therapist-card { border: 2px solid #e0e0e0; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .therapist-card.has-languages { border-color: #4CAF50; background: #f8fff8; }
        .therapist-card.no-languages { border-color: #ff9800; background: #fff8f0; }
        .language-display { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 5px; }
        .language-tag { display: inline-block; background: #2196F3; color: white; padding: 4px 8px; margin: 2px; border-radius: 12px; font-size: 12px; }
        .debug-info { font-family: monospace; font-size: 12px; color: #666; background: #f9f9f9; padding: 8px; margin: 5px 0; border-radius: 4px; }
        .success { color: #4CAF50; font-weight: bold; }
        .warning { color: #ff9800; font-weight: bold; }
        .error { color: #f44336; font-weight: bold; }
        button { background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #1976D2; }
    </style>
</head>
<body>
    <h1>ğŸŒ Live Therapist Language Data Test</h1>
    <p>This tool tests the exact language data displayed on your live therapist cards.</p>
    
    <div class="container">
        <h2>ğŸ” Testing Current Therapist Language Data</h2>
        <button onclick="testLiveTherapistLanguages()">ğŸ”„ Test Live Therapist Languages</button>
        <div id="resultsContainer"></div>
    </div>

    <script>
        // Appwrite Configuration
        const CONFIG = {
            endpoint: 'https://syd.cloud.appwrite.io/v1',
            projectId: '68f23b11000d25eb3664',
            databaseId: '68f76ee1000e64ca8d05',
            therapistsCollection: 'therapists_collection_id'
        };

        // Initialize Appwrite
        const { Client, Databases, Account } = Appwrite;
        const client = new Client()
            .setEndpoint(CONFIG.endpoint)
            .setProject(CONFIG.projectId);
        const databases = new Databases(client);
        const account = new Account(client);

        function log(message, type = 'info') {
            console.log(`ğŸŒ ${message}`);
        }

        // Helper functions (copied from appwriteHelpers.ts)
        function parseLanguages(languagesString) {
            console.log('ğŸ”§ parseLanguages input:', languagesString, typeof languagesString);
            
            if (!languagesString) {
                console.log('ğŸ”§ parseLanguages: No input, returning empty array');
                return [];
            }
            
            if (Array.isArray(languagesString)) {
                console.log('ğŸ”§ parseLanguages: Input is already array:', languagesString);
                return languagesString;
            }
            
            try {
                const parsed = JSON.parse(languagesString);
                console.log('ğŸ”§ parseLanguages: Parsed successfully:', parsed);
                return Array.isArray(parsed) ? parsed : [];
            } catch (error) {
                console.log('ğŸ”§ parseLanguages: Parse error, returning empty array:', error.message);
                return [];
            }
        }

        function displayLanguages(languages) {
            if (!languages || !Array.isArray(languages) || languages.length === 0) {
                return '<span class="warning">No languages found</span>';
            }
            
            return languages.map(lang => `<span class="language-tag">${lang}</span>`).join('');
        }

        async function testLiveTherapistLanguages() {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '<div class="debug-info">ğŸ”„ Loading therapist data...</div>';
            
            try {
                // Create anonymous session first
                try {
                    await account.createAnonymousSession();
                } catch (e) {
                    console.log('Session already exists or error:', e.message);
                }
                
                log('ğŸ“¡ Fetching all therapists from Appwrite...');
                const response = await databases.listDocuments(
                    CONFIG.databaseId,
                    CONFIG.therapistsCollection,
                    []
                );
                
                log(`âœ… Found ${response.documents.length} therapist records`);
                
                if (response.documents.length === 0) {
                    resultsContainer.innerHTML = '<div class="error">âŒ No therapists found in database</div>';
                    return;
                }
                
                let html = `<h3>ğŸ“Š Found ${response.documents.length} Therapists - Language Analysis</h3>`;
                let therapistsWithLanguages = 0;
                let therapistsWithoutLanguages = 0;
                
                response.documents.forEach((therapist, index) => {
                    const rawLanguages = therapist.languages;
                    const parsedLanguages = parseLanguages(rawLanguages);
                    const hasLanguages = parsedLanguages && parsedLanguages.length > 0;
                    
                    if (hasLanguages) therapistsWithLanguages++;
                    else therapistsWithoutLanguages++;
                    
                    html += `
                        <div class="therapist-card ${hasLanguages ? 'has-languages' : 'no-languages'}">
                            <h4>${therapist.name || 'Unnamed Therapist'} ${hasLanguages ? 'âœ…' : 'âš ï¸'}</h4>
                            
                            <div class="debug-info">
                                <strong>ID:</strong> ${therapist.$id}<br>
                                <strong>Email:</strong> ${therapist.email || 'N/A'}<br>
                                <strong>Status:</strong> ${therapist.status || 'N/A'}<br>
                                <strong>Is Live:</strong> ${therapist.isLive ? 'Yes' : 'No'}
                            </div>
                            
                            <div class="language-display">
                                <strong>ğŸŒ Language Data Analysis:</strong><br>
                                <strong>Raw DB Value:</strong> <code>${JSON.stringify(rawLanguages)}</code><br>
                                <strong>Type:</strong> ${typeof rawLanguages}<br>
                                <strong>Parsed Languages:</strong> <code>${JSON.stringify(parsedLanguages)}</code><br>
                                <strong>Array Length:</strong> ${parsedLanguages ? parsedLanguages.length : 0}<br>
                                <strong>Display:</strong> ${displayLanguages(parsedLanguages)}
                            </div>
                            
                            ${hasLanguages ? 
                                `<div class="success">âœ… This therapist HAS language data and should display languages on cards</div>` :
                                `<div class="warning">âš ï¸ This therapist has NO language data - languages won't show on cards</div>`
                            }
                        </div>
                    `;
                });
                
                html += `
                    <div class="container">
                        <h3>ğŸ“Š Summary</h3>
                        <div class="debug-info">
                            <strong>Therapists WITH Languages:</strong> <span class="success">${therapistsWithLanguages}</span><br>
                            <strong>Therapists WITHOUT Languages:</strong> <span class="warning">${therapistsWithoutLanguages}</span><br>
                            <strong>Total:</strong> ${response.documents.length}
                        </div>
                        
                        ${therapistsWithoutLanguages > 0 ? 
                            `<div class="warning">
                                âš ï¸ <strong>Issue Found:</strong> ${therapistsWithoutLanguages} therapist(s) don't have language data saved.<br>
                                This is why languages aren't showing on their cards.<br><br>
                                <strong>Solution:</strong> Go to the therapist dashboard for each therapist and select/save their languages.
                            </div>` : 
                            `<div class="success">
                                âœ… <strong>All Good:</strong> All therapists have language data saved.<br>
                                If languages still don't show on cards, there might be a rendering issue.
                            </div>`
                        }
                    </div>
                `;
                
                resultsContainer.innerHTML = html;
                
            } catch (error) {
                log(`âŒ Error: ${error.message}`);
                resultsContainer.innerHTML = `<div class="error">âŒ Error: ${error.message}</div>`;
            }
        }

        // Auto-run test on page load
        window.addEventListener('load', () => {
            console.log('ğŸš€ Live Therapist Language Test Tool Ready!');
            testLiveTherapistLanguages();
        });
    </script>
</body>
</html>