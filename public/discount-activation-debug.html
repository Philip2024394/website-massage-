<!DOCTYPE html>
<html>
<head>
    <title>Discount Activation Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .error { background: #fee; border-color: #faa; }
        .success { background: #efe; border-color: #afa; }
        .info { background: #eef; border-color: #aaf; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .test-btn { background: #007cba; color: white; }
        .fix-btn { background: #28a745; color: white; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Discount Activation Debug Tool</h1>
        <p>This tool will help debug why the discount activation button is flashing without activating.</p>

        <div class="section info">
            <h3>üìã Debug Checklist</h3>
            <button class="test-btn" onclick="checkAppwriteConnection()">Test Appwrite Connection</button>
            <button class="test-btn" onclick="checkTherapistData()">Check Therapist Data</button>
            <button class="test-btn" onclick="simulateActivation()">Simulate Activation</button>
            <button class="test-btn" onclick="checkConsoleErrors()">Check Console</button>
        </div>

        <div id="results"></div>

        <div class="section">
            <h3>üöÄ Quick Fixes</h3>
            <button class="fix-btn" onclick="addDebugLogs()">Add Debug Logging</button>
            <button class="fix-btn" onclick="checkButtonValidation()">Check Button Validation</button>
            <button class="fix-btn" onclick="testSaveFunction()">Test Save Function</button>
        </div>

        <div class="section">
            <h3>üìù Common Issues & Solutions</h3>
            <ul>
                <li><strong>Button not clickable:</strong> Check if selectedDiscountPercentage and selectedDiscountDuration are > 0</li>
                <li><strong>Save fails silently:</strong> Check Appwrite permissions and authentication</li>
                <li><strong>State not updating:</strong> Check if isSavingDiscount is preventing updates</li>
                <li><strong>Button flashes:</strong> Check for JavaScript errors in console</li>
            </ul>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `section ${type}`;
            div.innerHTML = `<pre>${message}</pre>`;
            results.appendChild(div);
        }

        async function checkAppwriteConnection() {
            log('üîç Checking Appwrite connection...', 'info');
            try {
                // Test if we can access the Appwrite client
                if (typeof window !== 'undefined') {
                    log('‚úÖ Running in browser context', 'success');
                    
                    // Check if Appwrite is loaded
                    const appwriteScript = document.querySelector('script[src*="appwrite"]');
                    if (appwriteScript) {
                        log('‚úÖ Appwrite SDK found in page', 'success');
                    } else {
                        log('‚ùå Appwrite SDK not found - this might be the issue', 'error');
                    }
                } else {
                    log('‚ùå Not in browser context', 'error');
                }
            } catch (error) {
                log(`‚ùå Appwrite connection error: ${error.message}`, 'error');
            }
        }

        function checkTherapistData() {
            log('üîç Checking therapist data structure...', 'info');
            
            // Check localStorage for therapist data
            try {
                const therapistData = localStorage.getItem('therapistData');
                if (therapistData) {
                    const parsed = JSON.parse(therapistData);
                    log(`‚úÖ Therapist data found in localStorage:
${JSON.stringify(parsed, null, 2)}`, 'success');
                } else {
                    log('‚ö†Ô∏è No therapist data in localStorage', 'error');
                }
            } catch (error) {
                log(`‚ùå Error checking localStorage: ${error.message}`, 'error');
            }

            // Check sessionStorage
            try {
                const sessionData = sessionStorage.getItem('therapistId');
                if (sessionData) {
                    log(`‚úÖ Therapist ID found in sessionStorage: ${sessionData}`, 'success');
                } else {
                    log('‚ö†Ô∏è No therapist ID in sessionStorage', 'error');
                }
            } catch (error) {
                log(`‚ùå Error checking sessionStorage: ${error.message}`, 'error');
            }
        }

        function simulateActivation() {
            log('üîç Simulating discount activation...', 'info');
            
            // Check if we're on the dashboard page
            if (window.location.pathname.includes('dashboard') || window.location.href.includes('dashboard')) {
                log('‚úÖ On dashboard page', 'success');
                
                // Look for selection buttons
                const percentButtons = document.querySelectorAll('button[class*="percent"]');
                const durationButtons = document.querySelectorAll('button[class*="duration"]');
                const activateButton = document.querySelector('button[class*="gradient-to-r from-orange-500"]');
                
                log(`Found ${percentButtons.length} percent buttons`, 'info');
                log(`Found ${durationButtons.length} duration buttons`, 'info');
                log(`Activate button found: ${activateButton ? 'Yes' : 'No'}`, activateButton ? 'success' : 'error');
                
                if (activateButton) {
                    log('üîç Activate button properties:', 'info');
                    log(`Disabled: ${activateButton.disabled}`, 'info');
                    log(`Class: ${activateButton.className}`, 'info');
                }
            } else {
                log('‚ùå Not on dashboard page - navigate to therapist dashboard first', 'error');
            }
        }

        function checkConsoleErrors() {
            log('üîç Console error monitoring started...', 'info');
            log('Check the browser console (F12) for any JavaScript errors when clicking the activation button', 'info');
            log('Look for errors related to:', 'info');
            log('- Appwrite authentication', 'info');
            log('- State updates (isSavingDiscount)', 'info');
            log('- Network requests (failed saves)', 'info');
            log('- React rendering errors', 'info');
        }

        function addDebugLogs() {
            log('üîß Debug logging solution:', 'success');
            log(`Add this to the activation button onClick handler:

console.log('üöÄ ACTIVATION DEBUG:', {
    selectedDiscountPercentage: selectedDiscountPercentage,
    selectedDiscountDuration: selectedDiscountDuration,
    isDiscountActive: isDiscountActive,
    isSavingDiscount: isSavingDiscount,
    therapistId: therapistId
});

Add this before the try block:
if (selectedDiscountPercentage === 0) {
    console.error('‚ùå No discount percentage selected');
    return;
}
if (selectedDiscountDuration === 0) {
    console.error('‚ùå No discount duration selected');
    return;
}`, 'success');
        }

        function checkButtonValidation() {
            log('üîß Button validation check:', 'success');
            log(`The activation button requires both values > 0:
- selectedDiscountPercentage > 0
- selectedDiscountDuration > 0

If button appears but doesn't work, add this validation:

const isValid = selectedDiscountPercentage > 0 && selectedDiscountDuration > 0;
if (!isValid) {
    alert('Please select both discount percentage and duration first');
    return;
}`, 'success');
        }

        function testSaveFunction() {
            log('üîß Save function testing:', 'success');
            log(`Test the onSave function by adding this debug:

console.log('üíæ About to call onSave with:', therapistData);
const saveResult = await onSave(therapistData as any);
console.log('üíæ Save result:', saveResult);

Also check if onSave function is properly passed as prop:
console.log('üíæ onSave function:', typeof onSave);`, 'success');
        }

        // Auto-run basic checks
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkAppwriteConnection();
                checkTherapistData();
            }, 1000);
        });
    </script>
</body>
</html>