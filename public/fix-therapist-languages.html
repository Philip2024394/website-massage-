<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ› ï¸ Fix Therapist Languages - Data Migration Tool</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            background: white; 
            border-radius: 8px; 
            padding: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
        }
        .status-card { 
            border: 1px solid #e1e5e9; 
            border-radius: 6px; 
            padding: 15px; 
            margin: 10px 0; 
            background: #f8f9fa; 
        }
        .status-card.success { background: #d4edda; border-color: #c3e6cb; }
        .status-card.warning { background: #fff3cd; border-color: #ffeaa7; }
        .status-card.error { background: #f8d7da; border-color: #f1c2c7; }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .progress { 
            width: 100%; 
            height: 20px; 
            background: #e9ecef; 
            border-radius: 10px; 
            overflow: hidden; 
            margin: 10px 0; 
        }
        .progress-bar { 
            height: 100%; 
            background: linear-gradient(90deg, #28a745, #20c997); 
            transition: width 0.3s ease; 
        }
        .log { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 4px; 
            padding: 15px; 
            max-height: 400px; 
            overflow-y: auto; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            white-space: pre-wrap; 
            margin: 15px 0; 
        }
        .therapist-card { 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            padding: 10px; 
            margin: 5px 0; 
            background: white; 
        }
        .therapist-card.needs-fix { border-color: #dc3545; background: #fff5f5; }
        .therapist-card.fixed { border-color: #28a745; background: #f0fff4; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ› ï¸ Fix Therapist Languages - Data Migration Tool</h1>
            <p>This tool will fix empty language fields for all therapists in your Appwrite database</p>
        </div>

        <div class="status-card">
            <h3>ğŸ“Š Current Status</h3>
            <div id="statusContent">Click "Analyze Therapists" to scan the database</div>
        </div>

        <div class="controls">
            <button onclick="analyzeTherapists()">ğŸ” Analyze Therapists</button>
            <button onclick="fixAllLanguages()" id="fixBtn" disabled>ğŸ”§ Fix All Languages</button>
            <button onclick="clearLog()">ğŸ—‘ï¸ Clear Log</button>
        </div>

        <div class="progress" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
        </div>

        <div id="therapistsList"></div>
        <div class="log" id="logOutput"></div>
    </div>

    <script>
        // Appwrite configuration
        const APPWRITE_ENDPOINT = 'https://syd.cloud.appwrite.io/v1';
        const APPWRITE_PROJECT_ID = '68f23b11000d25eb3664';
        const DATABASE_ID = '68f76ee1000e64ca8d05';
        const COLLECTION_ID = '68f76ee1001b06e7ba5d'; // therapists collection

        let therapists = [];
        let fixedCount = 0;
        let totalCount = 0;

        function log(message) {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            logOutput.textContent += `[${timestamp}] ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logOutput').textContent = '';
        }

        function updateProgress(current, total) {
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            
            if (total > 0) {
                progressContainer.style.display = 'block';
                const percentage = (current / total) * 100;
                progressBar.style.width = `${percentage}%`;
            } else {
                progressContainer.style.display = 'none';
            }
        }

        async function analyzeTherapists() {
            log('ğŸ” Starting therapist analysis...');
            
            try {
                const response = await fetch(`${APPWRITE_ENDPOINT}/databases/${DATABASE_ID}/collections/${COLLECTION_ID}/documents`, {
                    method: 'GET',
                    headers: {
                        'X-Appwrite-Project': APPWRITE_PROJECT_ID,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                therapists = data.documents;
                totalCount = therapists.length;

                log(`ğŸ“Š Found ${totalCount} therapists in database`);

                // Analyze language data
                let needsFix = 0;
                let alreadyGood = 0;
                let statusContent = '';
                let therapistsList = '';

                therapists.forEach((therapist, index) => {
                    const languages = therapist.languages;
                    const isEmptyOrInvalid = !languages || languages === '' || languages === '[]' || languages === 'null';
                    
                    if (isEmptyOrInvalid) {
                        needsFix++;
                        therapistsList += `<div class="therapist-card needs-fix">
                            <strong>${therapist.name || 'Unnamed'}</strong> (${therapist.$id})<br>
                            Languages: <code>${languages || 'empty'}</code> âŒ <strong>NEEDS FIX</strong>
                        </div>`;
                        log(`âŒ ${therapist.name || therapist.$id}: languages = "${languages || 'empty'}"`);
                    } else {
                        alreadyGood++;
                        therapistsList += `<div class="therapist-card fixed">
                            <strong>${therapist.name || 'Unnamed'}</strong> (${therapist.$id})<br>
                            Languages: <code>${languages}</code> âœ… <strong>GOOD</strong>
                        </div>`;
                        log(`âœ… ${therapist.name || therapist.$id}: languages = "${languages}"`);
                    }
                });

                statusContent = `
                    <strong>Analysis Results:</strong><br>
                    âœ… Good: ${alreadyGood} therapists<br>
                    âŒ Need Fix: ${needsFix} therapists<br>
                    ğŸ“Š Total: ${totalCount} therapists
                `;

                document.getElementById('statusContent').innerHTML = statusContent;
                document.getElementById('therapistsList').innerHTML = `<h3>ğŸ“‹ Therapist Details:</h3>${therapistsList}`;
                document.getElementById('fixBtn').disabled = needsFix === 0;

                if (needsFix > 0) {
                    log(`ğŸ› ï¸ Ready to fix ${needsFix} therapists. Click "Fix All Languages" to proceed.`);
                } else {
                    log(`ğŸ‰ All therapists already have proper language data!`);
                }

            } catch (error) {
                log(`âŒ Error analyzing therapists: ${error.message}`);
                console.error('Error:', error);
            }
        }

        async function fixAllLanguages() {
            log('ğŸ› ï¸ Starting bulk language fix...');
            fixedCount = 0;
            
            const therapistsToFix = therapists.filter(t => {
                const languages = t.languages;
                return !languages || languages === '' || languages === '[]' || languages === 'null';
            });

            log(`ğŸ¯ Fixing ${therapistsToFix.length} therapists...`);

            for (let i = 0; i < therapistsToFix.length; i++) {
                const therapist = therapistsToFix[i];
                
                try {
                    // Set default language to English
                    const fixedLanguages = '["en"]';
                    
                    const response = await fetch(`${APPWRITE_ENDPOINT}/databases/${DATABASE_ID}/collections/${COLLECTION_ID}/documents/${therapist.$id}`, {
                        method: 'PATCH',
                        headers: {
                            'X-Appwrite-Project': APPWRITE_PROJECT_ID,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            languages: fixedLanguages
                        })
                    });

                    if (response.ok) {
                        fixedCount++;
                        log(`âœ… Fixed ${therapist.name || therapist.$id}: languages = "${fixedLanguages}"`);
                    } else {
                        log(`âŒ Failed to fix ${therapist.name || therapist.$id}: ${response.statusText}`);
                    }

                    updateProgress(i + 1, therapistsToFix.length);
                    
                    // Small delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                } catch (error) {
                    log(`âŒ Error fixing ${therapist.name || therapist.$id}: ${error.message}`);
                }
            }

            log(`ğŸ‰ COMPLETED! Fixed ${fixedCount}/${therapistsToFix.length} therapists`);
            
            // Refresh analysis
            setTimeout(() => {
                analyzeTherapists();
            }, 1000);
        }

        // Auto-run analysis on page load
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸš€ Therapist Language Fix Tool loaded');
            log('â„¹ï¸ This tool will fix empty language fields by setting them to ["en"]');
        });
    </script>
</body>
</html>