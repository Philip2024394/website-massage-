<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Therapist Flow Debugger</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@15.0.0"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #ff6b35;
            padding-bottom: 10px;
        }
        h2 {
            color: #ff6b35;
            margin-top: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-left: 4px solid #ff6b35;
            border-radius: 5px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #e55a2b;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 13px;
        }
        .therapist-card {
            border: 2px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: white;
        }
        .therapist-card.live {
            border-color: #28a745;
            background: #f1f9f4;
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .badge.live {
            background: #28a745;
            color: white;
        }
        .badge.offline {
            background: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Therapist Flow Debugger</h1>
        <p>This tool tests the complete flow from therapist dashboard ‚Üí Appwrite ‚Üí therapist card display</p>
        
        <div class="test-section">
            <h2>1Ô∏è‚É£ Appwrite Connection Test</h2>
            <button onclick="testConnection()">Test Connection</button>
            <div id="connectionResult"></div>
        </div>
        
        <div class="test-section">
            <h2>2Ô∏è‚É£ Therapist Collection Test</h2>
            <button onclick="listTherapists()">List All Therapists</button>
            <button onclick="findLiveTherapists()">Find Live Therapists</button>
            <div id="therapistResult"></div>
        </div>
        
        <div class="test-section">
            <h2>3Ô∏è‚É£ Test Update Function</h2>
            <input type="text" id="testTherapistId" placeholder="Therapist ID" style="padding: 10px; width: 300px; margin-right: 10px;">
            <button onclick="testUpdate()">Test Update</button>
            <div id="updateResult"></div>
        </div>
        
        <div class="test-section">
            <h2>4Ô∏è‚É£ Simulate Dashboard Save</h2>
            <button onclick="simulateDashboardSave()">Simulate Publish Button Click</button>
            <div id="saveResult"></div>
        </div>
        
        <div class="test-section">
            <h2>5Ô∏è‚É£ Verify Display on Main Site</h2>
            <button onclick="verifyMainSite()">Check Main Site Data</button>
            <div id="mainSiteResult"></div>
        </div>
    </div>

    <script>
        const { Client, Databases, Account, Query } = Appwrite;
        
        const client = new Client()
            .setEndpoint('https://syd.cloud.appwrite.io/v1')
            .setProject('68f23b11000d25eb3664');
        
        const databases = new Databases(client);
        const account = new Account(client);
        
        const DATABASE_ID = '68f76ee1000e64ca8d05';
        const THERAPIST_COLLECTION = 'therapists_collection_id';
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            element.innerHTML += `<div class="status ${className}">${message}</div>`;
            console.log(`[${type.toUpperCase()}]`, message);
        }
        
        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }
        
        async function testConnection() {
            clearLog('connectionResult');
            log('connectionResult', 'üîÑ Testing Appwrite connection...', 'info');
            
            try {
                // Test database access
                const response = await databases.listCollections(DATABASE_ID);
                log('connectionResult', `‚úÖ Connected! Found ${response.total} collections`, 'success');
                log('connectionResult', `Collections: ${response.collections.map(c => c.name).join(', ')}`, 'info');
                
                // Find therapist collection
                const therapistCol = response.collections.find(c => 
                    c.name.toLowerCase().includes('therapist') || 
                    c.$id === THERAPIST_COLLECTION ||
                    c.$id.includes('therapist')
                );
                
                if (therapistCol) {
                    log('connectionResult', `‚úÖ Therapist collection found: ${therapistCol.name} (ID: ${therapistCol.$id})`, 'success');
                } else {
                    log('connectionResult', `‚ö†Ô∏è Therapist collection not found with ID: ${THERAPIST_COLLECTION}`, 'error');
                    log('connectionResult', `Available collection IDs: ${response.collections.map(c => c.$id).join(', ')}`, 'info');
                }
            } catch (error) {
                log('connectionResult', `‚ùå Connection failed: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        async function listTherapists() {
            clearLog('therapistResult');
            log('therapistResult', 'üîÑ Fetching therapists...', 'info');
            
            try {
                const response = await databases.listDocuments(
                    DATABASE_ID,
                    THERAPIST_COLLECTION
                );
                
                log('therapistResult', `‚úÖ Found ${response.total} therapists`, 'success');
                
                response.documents.forEach(therapist => {
                    const liveStatus = therapist.isLive ? 'LIVE' : 'OFFLINE';
                    const badgeClass = therapist.isLive ? 'live' : 'offline';
                    const cardClass = therapist.isLive ? 'live' : '';
                    
                    document.getElementById('therapistResult').innerHTML += `
                        <div class="therapist-card ${cardClass}">
                            <strong>${therapist.name}</strong> 
                            <span class="badge ${badgeClass}">${liveStatus}</span>
                            <br>
                            <small>ID: ${therapist.$id}</small><br>
                            <small>WhatsApp: ${therapist.whatsappNumber || 'Not set'}</small><br>
                            <small>City: ${therapist.city || 'Not set'}</small><br>
                            <small>Updated: ${new Date(therapist.$updatedAt).toLocaleString()}</small>
                        </div>
                    `;
                });
            } catch (error) {
                log('therapistResult', `‚ùå Failed to fetch: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        async function findLiveTherapists() {
            clearLog('therapistResult');
            log('therapistResult', 'üîÑ Finding LIVE therapists...', 'info');
            
            try {
                const response = await databases.listDocuments(
                    DATABASE_ID,
                    THERAPIST_COLLECTION,
                    [Query.equal('isLive', true)]
                );
                
                log('therapistResult', `‚úÖ Found ${response.total} LIVE therapists`, 'success');
                
                if (response.total === 0) {
                    log('therapistResult', '‚ö†Ô∏è No therapists are currently LIVE. This is why they don\'t appear on the main site!', 'error');
                }
                
                response.documents.forEach(therapist => {
                    document.getElementById('therapistResult').innerHTML += `
                        <div class="therapist-card live">
                            <strong>${therapist.name}</strong> 
                            <span class="badge live">LIVE</span>
                            <br>
                            <small>ID: ${therapist.$id}</small><br>
                            <small>WhatsApp: ${therapist.whatsappNumber || 'Not set'}</small><br>
                            <small>City: ${therapist.city || 'Not set'}</small>
                        </div>
                    `;
                });
            } catch (error) {
                log('therapistResult', `‚ùå Failed: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        async function testUpdate() {
            const therapistId = document.getElementById('testTherapistId').value.trim();
            if (!therapistId) {
                alert('Please enter a therapist ID');
                return;
            }
            
            clearLog('updateResult');
            log('updateResult', `üîÑ Testing update for therapist: ${therapistId}`, 'info');
            
            try {
                // First get current data
                const current = await databases.getDocument(DATABASE_ID, THERAPIST_COLLECTION, therapistId);
                log('updateResult', `‚úÖ Current status: isLive = ${current.isLive}`, 'info');
                
                // Try to update isLive to true
                const updated = await databases.updateDocument(
                    DATABASE_ID,
                    THERAPIST_COLLECTION,
                    therapistId,
                    { isLive: true }
                );
                
                log('updateResult', `‚úÖ Update successful! New status: isLive = ${updated.isLive}`, 'success');
                log('updateResult', `Updated at: ${new Date(updated.$updatedAt).toLocaleString()}`, 'info');
            } catch (error) {
                log('updateResult', `‚ùå Update failed: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        async function simulateDashboardSave() {
            clearLog('saveResult');
            log('saveResult', 'üîÑ Simulating dashboard publish button click...', 'info');
            
            try {
                // Get current user
                const user = await account.get();
                log('saveResult', `‚úÖ Logged in as: ${user.email}`, 'success');
                
                // Find therapist by email
                const response = await databases.listDocuments(
                    DATABASE_ID,
                    THERAPIST_COLLECTION,
                    [Query.equal('email', user.email)]
                );
                
                if (response.total === 0) {
                    log('saveResult', '‚ùå No therapist found with your email', 'error');
                    return;
                }
                
                const therapist = response.documents[0];
                log('saveResult', `‚úÖ Found your profile: ${therapist.name}`, 'success');
                
                // Simulate the update that dashboard does
                const updateData = {
                    name: therapist.name,
                    whatsappNumber: therapist.whatsappNumber || '+62812345678',
                    city: therapist.city || 'Bali',
                    isLive: true  // THIS IS THE KEY FIELD
                };
                
                log('saveResult', `üîÑ Updating with data: ${JSON.stringify(updateData)}`, 'info');
                
                const updated = await databases.updateDocument(
                    DATABASE_ID,
                    THERAPIST_COLLECTION,
                    therapist.$id,
                    updateData
                );
                
                log('saveResult', `‚úÖ Profile published! isLive = ${updated.isLive}`, 'success');
                log('saveResult', `‚úÖ You should now appear on the main site!`, 'success');
                
                // Trigger refresh event (like dashboard does)
                window.dispatchEvent(new CustomEvent('refreshTherapistData', { detail: 'test-update' }));
                log('saveResult', `üîî Refresh event dispatched`, 'info');
                
            } catch (error) {
                log('saveResult', `‚ùå Simulation failed: ${error.message}`, 'error');
                if (error.code === 401) {
                    log('saveResult', '‚ö†Ô∏è You need to log in first. Please log in to the therapist dashboard at http://localhost:3003/', 'error');
                }
                console.error(error);
            }
        }
        
        async function verifyMainSite() {
            clearLog('mainSiteResult');
            log('mainSiteResult', 'üîÑ Checking what main site would see...', 'info');
            
            try {
                // Fetch like the main site does
                const response = await databases.listDocuments(
                    DATABASE_ID,
                    THERAPIST_COLLECTION
                );
                
                const liveTherapists = response.documents.filter(t => t.isLive === true);
                
                log('mainSiteResult', `üìä Total therapists in database: ${response.total}`, 'info');
                log('mainSiteResult', `‚úÖ LIVE therapists (visible on site): ${liveTherapists.length}`, liveTherapists.length > 0 ? 'success' : 'error');
                
                if (liveTherapists.length === 0) {
                    log('mainSiteResult', '‚ö†Ô∏è NO LIVE THERAPISTS! This is why the main site appears empty.', 'error');
                    log('mainSiteResult', 'üí° Use the "Simulate Dashboard Save" button above to make your profile live.', 'info');
                } else {
                    log('mainSiteResult', '‚úÖ These therapists will appear on the main site:', 'success');
                    liveTherapists.forEach(t => {
                        document.getElementById('mainSiteResult').innerHTML += `
                            <div class="therapist-card live">
                                <strong>${t.name}</strong>
                                <br><small>City: ${t.city || 'Not set'}</small>
                                <br><small>WhatsApp: ${t.whatsappNumber || 'Not set'}</small>
                            </div>
                        `;
                    });
                }
            } catch (error) {
                log('mainSiteResult', `‚ùå Failed: ${error.message}`, 'error');
                console.error(error);
            }
        }
    </script>
</body>
</html>
