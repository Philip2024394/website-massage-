name: Block Legacy Edits

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  prevent-legacy-changes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check for legacy file modifications
        run: |
          echo "INFO: Checking for legacy file edits..."

          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          echo "INFO: Changed files:"
          echo "$CHANGED_FILES"
          echo ""

          LEGACY_CHANGES=$(echo "$CHANGED_FILES" | grep "^legacy/" || true)
          LOCKED_PAGES=$(echo "$CHANGED_FILES" | grep -E "^pages/HomePage\.tsx$|^components/TherapistHomeCard\.tsx$" || true)

          if [ -n "$LEGACY_CHANGES" ]; then
            echo "ERROR: Legacy files were modified!"
            echo ""
            echo "The following legacy files cannot be edited:"
            echo "$LEGACY_CHANGES"
            echo ""
            echo "WARN: Legacy code is frozen."
            echo "INFO: Fix options:"
            echo "   1. Revert changes to legacy files"
            echo "   2. Create new domain-isolated implementation"
            echo "   3. Request explicit permission to migrate on touch"
            echo ""
            echo "INFO: See DOMAIN_ISOLATION_ROADMAP.md (Phase 4)"
            exit 1
          fi

          if [ -n "$LOCKED_PAGES" ]; then
            echo "ERROR: Production-locked files were modified!"
            echo ""
            echo "The following files are LOCKED (structure & logic):"
            echo "$LOCKED_PAGES"
            echo ""
            echo "INFO: Therapist Home Page is production-ready and locked."
            echo "INFO: You CAN still update (no code changes needed):"
            echo "   - translations/home.ts - UI text (Indonesian/English)"
            echo "   - lib/appwriteService.ts - Backend integration"
            echo "   - lib/therapistService.ts - Data fetching"
            echo "   - constants/indonesianCities.ts - City lists"
            echo "   - constants/massageTypes.ts - Service categories"
            echo "   - Therapist data in Appwrite - Updates daily automatically"
            echo ""
            echo "ERROR: You CANNOT modify without approval:"
            echo "   - Page structure & layout"
            echo "   - Filtering/sorting algorithms"
            echo "   - State management patterns"
            echo "   - Component interfaces & props"
            echo ""
            echo "INFO: To modify locked logic:"
            echo "   1. Review LOCKED_FILES.md for full details"
            echo "   2. Contact the architecture team with justification"
            echo "   3. Get approval and document changes"
            echo "   4. Request a temporary unlock"
            echo ""
            echo "INFO: See LOCKED_FILES.md"
            exit 1
          fi

          echo "INFO: No legacy file edits detected. Proceeding..."

      - name: Check for hardcoded routes
        run: |
          echo "INFO: Checking for hardcoded route strings..."

          CHANGED_TS_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(ts|tsx)$' || true)

          if [ -z "$CHANGED_TS_FILES" ]; then
            echo "INFO: No TypeScript files changed. Skipping route check."
            exit 0
          fi

          VIOLATIONS=""

          for file in $CHANGED_TS_FILES; do
            if [ -f "$file" ]; then
              if grep -nE "setPage\(['\"]" "$file" > /dev/null 2>&1; then
                echo "WARN: Found hardcoded route in: $file"
                VIOLATIONS="$VIOLATIONS\n$file"
              fi
            fi
          done

          if [ -n "$VIOLATIONS" ]; then
            echo ""
            echo "ERROR: Hardcoded route strings detected!"
            echo ""
            echo "Files with violations:"
            echo -e "$VIOLATIONS"
            echo ""
            echo "INFO: All navigation must use ROUTES constants."
            echo "INFO: To fix this:"
            echo "   1. Import ROUTES from 'src/routes.ts'"
            echo "   2. Replace: setPage('route-name')"
            echo "   3. With: setPage(ROUTES.ROUTE_NAME)"
            echo ""
            echo "INFO: See ROUTING_QUICK_REFERENCE.ts for examples"
            echo "INFO: This is a warning - not blocking deployment yet"
          else
            echo "INFO: No hardcoded routes detected."
          fi

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "================================================================================"
          echo "INFO: Architecture Validation Passed"
          echo "================================================================================"
          echo "INFO: No legacy file modifications"
          echo "INFO: Route contract respected"
          echo "INFO: Ready for review"
          echo "================================================================================"
