<!DOCTYPE html>
<html>
<head>
    <title>üîß 401 Error Fix Verification</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .error { background: #f8d7da; border: 2px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .warning { background: #fff3cd; border: 2px solid #ffc107; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 2px solid #28a745; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .info { background: #d1ecf1; border: 2px solid #17a2b8; padding: 15px; margin: 10px 0; border-radius: 5px; }
        button { background: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        code { background: #f8f9fa; padding: 2px 6px; border-radius: 3px; font-family: monospace; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 11px; }
        .network-log { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #f8f9fa; font-family: monospace; font-size: 11px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß 401 Error Fix Verification</h1>
        
        <div class="info">
            <h3>üéØ Testing Our Fixes:</h3>
            <ol>
                <li><strong>Collection ID Validation:</strong> Service should skip when collection is empty</li>
                <li><strong>Authentication Context:</strong> Check existing user session first</li>
                <li><strong>No More Double-Slash URLs:</strong> /collections//documents should be gone</li>
                <li><strong>Proper Error Handling:</strong> Graceful fallbacks instead of 401s</li>
            </ol>
        </div>

        <div class="grid">
            <div>
                <h3>üîç Collection Configuration Check</h3>
                <div id="config-status">Loading...</div>
                <button onclick="checkConfig()">üîß Check Config</button>
            </div>
            
            <div>
                <h3>üìä Network Monitoring</h3>
                <div id="network-status">Not monitoring</div>
                <button onclick="startNetworkMonitoring()">üì° Start Monitoring</button>
                <button onclick="clearNetworkLog()">üßπ Clear Log</button>
            </div>
        </div>

        <h3>üåê Network Requests Log</h3>
        <div id="network-log" class="network-log">Network monitoring not active...</div>
        
        <div id="test-results"></div>
        
        <div class="info">
            <h3>üß™ Test Actions</h3>
            <button onclick="testMainApp()">üè† Test Main App</button>
            <button onclick="testTherapistLogin()">üë®‚Äç‚öïÔ∏è Test Therapist Login</button>
            <button onclick="simulateBookingCheck()">‚è∞ Simulate Booking Check</button>
            <button onclick="openDevTools()">üõ†Ô∏è Open DevTools</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
    <script>
        let networkRequests = [];
        let isMonitoring = false;
        
        // Configuration check
        async function checkConfig() {
            const statusDiv = document.getElementById('config-status');
            statusDiv.innerHTML = '<p>üîÑ Checking configuration...</p>';
            
            try {
                // Simulate the config check our service does
                const configCheck = {
                    bookingsCollection: '', // This is what causes the issue
                    shouldSkip: '' === '',
                    hasValidConfig: '' !== ''
                };
                
                let html = '<div class="warning">';
                html += '<h4>üìã Configuration Status:</h4>';
                html += '<strong>Bookings Collection ID:</strong> <code>"' + configCheck.bookingsCollection + '"</code><br>';
                html += '<strong>Should Skip Check:</strong> ' + (configCheck.shouldSkip ? '‚úÖ Yes (Good!)' : '‚ùå No') + '<br>';
                html += '<strong>Valid Configuration:</strong> ' + (configCheck.hasValidConfig ? '‚úÖ Yes' : '‚ùå No (Expected)') + '<br>';
                html += '</div>';
                
                html += '<div class="success">';
                html += '<h4>‚úÖ Expected Behavior:</h4>';
                html += '<p>Since bookings collection is empty (<code>""</code>), the booking expiration service should:</p>';
                html += '<ol>';
                html += '<li>Detect empty collection ID</li>';
                html += '<li>Log: "‚ö†Ô∏è Bookings collection not configured - skipping expiration check"</li>';
                html += '<li>Return early without making any HTTP requests</li>';
                html += '<li><strong>Result: No more 401 errors!</strong></li>';
                html += '</ol>';
                html += '</div>';
                
                statusDiv.innerHTML = html;
                
            } catch (error) {
                statusDiv.innerHTML = '<div class="error">‚ùå Config check failed: ' + error.message + '</div>';
            }
        }
        
        // Network monitoring
        function startNetworkMonitoring() {
            if (isMonitoring) return;
            
            isMonitoring = true;
            document.getElementById('network-status').innerHTML = '<span style="color: green;">üü¢ Monitoring active</span>';
            
            // Intercept fetch requests
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                const url = args[0];
                const options = args[1] || {};
                
                logNetworkRequest('FETCH', url, options);
                
                return originalFetch.apply(this, args)
                    .then(response => {
                        logNetworkResponse('FETCH', url, response.status, response.statusText);
                        return response;
                    })
                    .catch(error => {
                        logNetworkError('FETCH', url, error.message);
                        throw error;
                    });
            };
            
            // Monitor XMLHttpRequest too
            const originalXHR = window.XMLHttpRequest;
            window.XMLHttpRequest = function() {
                const xhr = new originalXHR();
                const originalOpen = xhr.open;
                const originalSend = xhr.send;
                
                let method, url;
                
                xhr.open = function(m, u, ...args) {
                    method = m;
                    url = u;
                    return originalOpen.apply(this, [m, u, ...args]);
                };
                
                xhr.send = function(...args) {
                    logNetworkRequest('XHR', `${method} ${url}`, {});
                    
                    xhr.addEventListener('load', () => {
                        logNetworkResponse('XHR', url, xhr.status, xhr.statusText);
                    });
                    
                    xhr.addEventListener('error', () => {
                        logNetworkError('XHR', url, 'Network error');
                    });
                    
                    return originalSend.apply(this, args);
                };
                
                return xhr;
            };
        }
        
        function logNetworkRequest(type, url, options) {
            const timestamp = new Date().toLocaleTimeString();
            let logEntry = `[${timestamp}] ${type} REQUEST: ${url}`;
            
            if (url && url.includes && url.includes('appwrite.io')) {
                if (url.includes('/collections//documents')) {
                    logEntry += ' ‚ö†Ô∏è DOUBLE SLASH DETECTED!';
                }
                if (url.includes('syd.cloud.appwrite.io')) {
                    logEntry += ' üéØ APPWRITE REQUEST';
                }
            }
            
            networkRequests.push({
                type: 'request',
                timestamp,
                method: type,
                url,
                message: logEntry
            });
            
            updateNetworkLog();
        }
        
        function logNetworkResponse(type, url, status, statusText) {
            const timestamp = new Date().toLocaleTimeString();
            let logEntry = `[${timestamp}] ${type} RESPONSE: ${status} ${statusText} - ${url}`;
            
            if (status === 401) {
                logEntry += ' ‚ùå 401 UNAUTHORIZED!';
            } else if (status === 404) {
                logEntry += ' ‚ö†Ô∏è 404 NOT FOUND';
            } else if (status >= 200 && status < 300) {
                logEntry += ' ‚úÖ SUCCESS';
            }
            
            networkRequests.push({
                type: 'response',
                timestamp,
                status,
                url,
                message: logEntry
            });
            
            updateNetworkLog();
        }
        
        function logNetworkError(type, url, error) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type} ERROR: ${error} - ${url}`;
            
            networkRequests.push({
                type: 'error',
                timestamp,
                url,
                error,
                message: logEntry
            });
            
            updateNetworkLog();
        }
        
        function updateNetworkLog() {
            const logDiv = document.getElementById('network-log');
            const recent = networkRequests.slice(-50); // Show last 50 requests
            
            const logHtml = recent.map(entry => {
                const className = entry.status === 401 ? 'error' : 
                                entry.type === 'error' ? 'error' :
                                entry.status >= 200 && entry.status < 300 ? 'success' : 'warning';
                
                return `<div style="color: ${
                    entry.status === 401 ? '#dc3545' : 
                    entry.type === 'error' ? '#dc3545' : 
                    entry.status >= 200 && entry.status < 300 ? '#28a745' : '#856404'
                }">${entry.message}</div>`;
            }).join('');
            
            logDiv.innerHTML = logHtml || 'No network requests yet...';
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearNetworkLog() {
            networkRequests = [];
            updateNetworkLog();
        }
        
        function testMainApp() {
            window.open('http://localhost:3006/', '_blank');
        }
        
        function testTherapistLogin() {
            window.open('http://localhost:3006/#therapist-login', '_blank');
        }
        
        function simulateBookingCheck() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = `
                <div class="info">
                    <h3>‚è∞ Simulating Booking Expiration Check</h3>
                    <p>The booking expiration service runs automatically. With our fix:</p>
                    <ol>
                        <li>Service detects empty collection ID: <code>""</code></li>
                        <li>Logs warning and returns early</li>
                        <li>No HTTP request is made</li>
                        <li>No 401 error occurs</li>
                    </ol>
                    <p><strong>Check the browser console for the skip message!</strong></p>
                </div>
            `;
        }
        
        function openDevTools() {
            alert('Press F12 or right-click ‚Üí Inspect Element to open DevTools.\nGo to Network tab to see real-time requests.');
        }
        
        // Auto-start config check
        setTimeout(checkConfig, 1000);
        
        // Auto-start network monitoring
        setTimeout(startNetworkMonitoring, 2000);
        
        console.log('üîß 401 Error Fix Verification Tool Loaded');
        console.log('üìä This tool will help verify our fixes are working');
    </script>
</body>
</html>