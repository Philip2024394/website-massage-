<!DOCTYPE html>
<html>
<head>
    <title>üîÑ Copy Profile Data Pattern to Discount System</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .working { background: #d4edda; padding: 15px; border-radius: 5px; border: 2px solid #28a745; }
        .broken { background: #f8d7da; padding: 15px; border-radius: 5px; border: 2px solid #dc3545; }
        .fix { background: #fff3cd; padding: 15px; border-radius: 5px; border: 2px solid #ffc107; }
        h3 { margin-top: 0; }
        code { background: #f8f9fa; padding: 2px 4px; border-radius: 3px; font-size: 12px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 11px; }
        .step { margin: 10px 0; padding: 10px; border-left: 3px solid #007bff; background: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Copy Profile Data Pattern to Discount System</h1>
        
        <div class="step">
            <h3>üìä Analysis: Why Profile Works vs Discount Doesn't</h3>
            <p><strong>Profile data saves and displays perfectly</strong> because it follows a complete data flow pattern. The discount system has gaps in this flow.</p>
        </div>

        <div class="comparison">
            <div class="working">
                <h3>‚úÖ WORKING: Profile Data Flow</h3>
                <div class="step">
                    <strong>1. Dashboard Save:</strong><br>
                    <code>TherapistDashboardPage.tsx</code><br>
                    ‚Üí <code>handleSave()</code><br>
                    ‚Üí <code>onSave(therapistData)</code>
                </div>
                
                <div class="step">
                    <strong>2. Handler Processing:</strong><br>
                    <code>useProviderAgentHandlers.ts</code><br>
                    ‚Üí <code>handleSaveTherapist()</code><br>
                    ‚Üí Maps all profile fields<br>
                    ‚Üí <code>therapistService.update()</code>
                </div>
                
                <div class="step">
                    <strong>3. Appwrite Storage:</strong><br>
                    <code>appwriteService.ts</code><br>
                    ‚Üí <code>therapistService.update()</code><br>
                    ‚Üí <code>databases.updateDocument()</code><br>
                    ‚Üí Data saved to Appwrite
                </div>
                
                <div class="step">
                    <strong>4. Card Display:</strong><br>
                    <code>TherapistCard.tsx</code><br>
                    ‚Üí Receives <code>therapist</code> prop<br>
                    ‚Üí Displays <code>therapist.name</code><br>
                    ‚Üí Shows <code>therapist.profilePicture</code><br>
                    ‚Üí ‚úÖ <strong>WORKS PERFECTLY</strong>
                </div>
            </div>

            <div class="broken">
                <h3>‚ùå BROKEN: Discount Data Flow</h3>
                <div class="step">
                    <strong>1. Dashboard Save:</strong><br>
                    <code>TherapistDashboardPage.tsx</code><br>
                    ‚Üí <code>discount activation</code><br>
                    ‚Üí <code>onSave(therapistData)</code><br>
                    ‚Üí ‚úÖ <strong>Includes discount fields</strong>
                </div>
                
                <div class="step">
                    <strong>2. Handler Processing:</strong><br>
                    <code>useProviderAgentHandlers.ts</code><br>
                    ‚Üí <code>handleSaveTherapist()</code><br>
                    ‚Üí ‚ùì <strong>Maps discount fields?</strong><br>
                    ‚Üí <code>therapistService.update()</code>
                </div>
                
                <div class="step">
                    <strong>3. Appwrite Storage:</strong><br>
                    <code>appwriteService.ts</code><br>
                    ‚Üí <code>therapistService.update()</code><br>
                    ‚Üí ‚ùì <strong>Includes discount fields?</strong><br>
                    ‚Üí Data saved to Appwrite
                </div>
                
                <div class="step">
                    <strong>4. Card Display:</strong><br>
                    <code>TherapistCard.tsx</code><br>
                    ‚Üí <code>isDiscountActive(therapist)</code><br>
                    ‚Üí Checks <code>therapist.discountPercentage</code><br>
                    ‚Üí ‚ùå <strong>MISSING OR UNDEFINED</strong>
                </div>
            </div>
        </div>

        <div class="fix">
            <h3>üîß Fix Strategy: Copy Profile Pattern Exactly</h3>
            
            <h4>Step 1: Check Handler Mapping</h4>
            <p>Verify that <code>useProviderAgentHandlers.ts</code> properly maps discount fields the same way it maps profile fields like <code>name</code> and <code>profilePicture</code>.</p>
            
            <h4>Step 2: Check Appwrite Service</h4>
            <p>Ensure <code>therapistService.update()</code> includes discount fields in the data being sent to Appwrite.</p>
            
            <h4>Step 3: Test End-to-End</h4>
            <p>Follow the exact same data path that works for profile data but trace discount data instead.</p>
        </div>

        <button onclick="runDiagnostic()">üîç Run Data Flow Diagnostic</button>
        <button onclick="checkFieldMapping()">üìã Check Field Mapping</button>
        
        <div id="results"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
    <script>
        const { Client, Databases, Query } = Appwrite;
        
        const client = new Client()
            .setEndpoint('https://cloud.appwrite.io/v1')
            .setProject('68f23b11000d25eb3664');
        
        const databases = new Databases(client);
        
        async function runDiagnostic() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>üîÑ Running data flow diagnostic...</p>';
            
            try {
                // Get phil10 data to test both profile and discount fields
                const response = await databases.listDocuments(
                    '68f23b11000d25eb3664',
                    '68f25bf4000ba08315b5',
                    [Query.equal('name', 'phil10')]
                );
                
                if (response.documents.length === 0) {
                    resultsDiv.innerHTML = '<div style="color: red;">‚ùå Phil10 not found in database</div>';
                    return;
                }
                
                const phil10 = response.documents[0];
                
                let html = '<h3>üîç Data Flow Analysis Results</h3>';
                
                // Check profile fields (known to work)
                html += '<div class="working">';
                html += '<h4>‚úÖ Profile Fields (Working Pattern)</h4>';
                html += '<div>Name: ' + (phil10.name || 'undefined') + '</div>';
                html += '<div>Profile Picture: ' + (phil10.profilePicture ? 'SET (' + phil10.profilePicture.length + ' chars)' : 'undefined') + '</div>';
                html += '<div>Location: ' + (phil10.location || 'undefined') + '</div>';
                html += '<div>WhatsApp: ' + (phil10.whatsappNumber || 'undefined') + '</div>';
                html += '</div>';
                
                // Check discount fields (suspected broken)
                html += '<div class="broken">';
                html += '<h4>‚ùì Discount Fields (Testing Pattern)</h4>';
                html += '<div>Discount Percentage: ' + (phil10.discountPercentage !== undefined ? phil10.discountPercentage : 'undefined') + '</div>';
                html += '<div>Discount End Time: ' + (phil10.discountEndTime || 'undefined') + '</div>';
                html += '<div>Is Discount Active: ' + (phil10.isDiscountActive !== undefined ? phil10.isDiscountActive : 'undefined') + '</div>';
                html += '<div>Discount Duration: ' + (phil10.discountDuration !== undefined ? phil10.discountDuration : 'undefined') + '</div>';
                html += '</div>';
                
                // Analysis
                const profileWorking = !!(phil10.name && phil10.profilePicture);
                const discountWorking = !!(phil10.discountPercentage && phil10.discountEndTime && phil10.isDiscountActive);
                
                html += '<div class="fix">';
                html += '<h4>üìä Pattern Comparison</h4>';
                html += '<div><strong>Profile Pattern Working:</strong> ' + (profileWorking ? '‚úÖ YES' : '‚ùå NO') + '</div>';
                html += '<div><strong>Discount Pattern Working:</strong> ' + (discountWorking ? '‚úÖ YES' : '‚ùå NO') + '</div>';
                
                if (profileWorking && !discountWorking) {
                    html += '<div style="color: orange; margin-top: 10px;"><strong>üîß ISSUE IDENTIFIED:</strong> Profile data saves correctly but discount data is missing. The handler mapping needs to include discount fields.</div>';
                } else if (!profileWorking) {
                    html += '<div style="color: red; margin-top: 10px;"><strong>‚ö†Ô∏è UNEXPECTED:</strong> Profile data is also missing. Check if save operation is working at all.</div>';
                } else {
                    html += '<div style="color: green; margin-top: 10px;"><strong>‚úÖ BOTH WORKING:</strong> Data flow is correct. Issue might be in display logic.</div>';
                }
                html += '</div>';
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('‚ùå Diagnostic failed:', error);
                resultsDiv.innerHTML = '<div style="color: red;">‚ùå Diagnostic failed: ' + error.message + '</div>';
            }
        }
        
        function checkFieldMapping() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <h3>üìã Field Mapping Check</h3>
                <div class="step">
                    <h4>Profile Fields in useProviderAgentHandlers.ts</h4>
                    <p>These fields work perfectly and save to Appwrite:</p>
                    <pre>
const updateData = {
    name: therapistData.name,                    // ‚úÖ WORKS
    profilePicture: therapistData.profilePicture, // ‚úÖ WORKS  
    location: therapistData.location,            // ‚úÖ WORKS
    whatsappNumber: therapistData.whatsappNumber, // ‚úÖ WORKS
    // ... other profile fields
};
                    </pre>
                </div>
                
                <div class="step">
                    <h4>Discount Fields Need Same Treatment</h4>
                    <p>These fields should be added to updateData using the exact same pattern:</p>
                    <pre>
const updateData = {
    // ... existing profile fields (working)
    
    // ADD THESE DISCOUNT FIELDS:
    discountPercentage: therapistData.discountPercentage,   // ‚ö†Ô∏è CHECK IF INCLUDED
    discountEndTime: therapistData.discountEndTime,         // ‚ö†Ô∏è CHECK IF INCLUDED  
    isDiscountActive: therapistData.isDiscountActive,       // ‚ö†Ô∏è CHECK IF INCLUDED
    discountDuration: therapistData.discountDuration,       // ‚ö†Ô∏è CHECK IF INCLUDED
};
                    </pre>
                </div>
                
                <div class="fix">
                    <h4>üîß Action Required</h4>
                    <p>Check if the handler is missing discount field mapping. The profile fields work because they're explicitly mapped. Discount fields need the same explicit mapping.</p>
                </div>
            `;
        }
    </script>
</body>
</html>