// ðŸ”„ LOCAL DATABASE SYNC HOOK
// Replaces Appwrite with local database functionality

import { useState, useEffect, useCallback } from 'react';
import localDatabase from '../database/localDatabase';
import type { DatabaseTherapist, DatabasePlace } from '../database/schema';
import type { Therapist, Place } from '../types';

interface LocalDatabaseHook {
    // Data states
    therapists: Therapist[];
    places: Place[];
    isLoading: boolean;
    error: string | null;
    
    // Therapist operations
    saveTherapist: (therapistData: Partial<Therapist>) => Promise<void>;
    updateTherapist: (id: string, updates: Partial<Therapist>) => Promise<void>;
    deleteTherapist: (id: string) => Promise<void>;
    getTherapist: (id: string) => Therapist | null;
    
    // Place operations
    savePlace: (placeData: Partial<Place>) => Promise<void>;
    updatePlace: (id: string, updates: Partial<Place>) => Promise<void>;
    deletePlace: (id: string) => Promise<void>;
    getPlace: (id: string) => Place | null;
    
    // Utility operations
    refreshData: () => Promise<void>;
    searchTherapists: (query: string) => Therapist[];
    searchPlaces: (query: string) => Place[];
    
    // Authentication
    login: (email: string, password: string, userType: 'therapist' | 'place' | 'admin') => Promise<any>;
    register: (userData: any) => Promise<any>;
    getCurrentUser: () => any;
    logout: () => void;
}

export const useLocalDatabase = (): LocalDatabaseHook => {
    const [therapists, setTherapists] = useState<Therapist[]>([]);
    const [places, setPlaces] = useState<Place[]>([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);

    // Convert database format to app format
    const convertTherapistFromDB = (dbTherapist: DatabaseTherapist): Therapist => ({
        id: dbTherapist.id,
        name: dbTherapist.name,
        email: dbTherapist.email,
        whatsappNumber: dbTherapist.whatsappNumber,
        profilePicture: dbTherapist.profilePicture,
        mainImage: dbTherapist.mainImage || '',
        description: dbTherapist.description,
        massageTypes: JSON.stringify(dbTherapist.massageTypes),
        pricing: JSON.stringify(dbTherapist.pricing),
        location: dbTherapist.location,
        coordinates: JSON.stringify(dbTherapist.coordinates),
        status: dbTherapist.status as any,
        distance: 0, // Default distance, will be calculated later
        rating: dbTherapist.rating,
        reviewCount: dbTherapist.reviewCount,
        isLive: dbTherapist.isLive,
        activeMembershipDate: dbTherapist.createdAt.split('T')[0]
    });

    const convertPlaceFromDB = (dbPlace: DatabasePlace): Place => ({
        id: dbPlace.id,
        name: dbPlace.name,
        email: dbPlace.email,
        whatsappNumber: dbPlace.whatsappNumber,
        profilePicture: dbPlace.profilePicture,
        mainImage: dbPlace.mainImage,
        description: dbPlace.description,
        category: dbPlace.category,
        services: dbPlace.services,
        pricing: JSON.stringify(dbPlace.pricing),
        location: dbPlace.location,
        coordinates: JSON.stringify(dbPlace.coordinates),
        operatingHours: JSON.stringify(dbPlace.operatingHours),
        amenities: dbPlace.amenities,
        rating: dbPlace.rating,
        reviewCount: dbPlace.reviewCount,
        isLive: dbPlace.isLive,
        analytics: JSON.stringify(dbPlace.analytics)
    });

    // Convert app format to database format
    const convertTherapistToDB = (therapist: Partial<Therapist>): Omit<DatabaseTherapist, 'id' | 'createdAt' | 'updatedAt'> => ({
        name: therapist.name || '',
        email: therapist.email || '',
        whatsappNumber: therapist.whatsappNumber || '',
        profilePicture: therapist.profilePicture || '',
        mainImage: therapist.mainImage,
        description: therapist.description || '',
        specialization: therapist.massageTypes ? (Array.isArray(therapist.massageTypes) ? therapist.massageTypes[0] : 'General Massage') : 'General Massage',
        yearsOfExperience: therapist.yearsOfExperience || 0,
        isLicensed: therapist.isLicensed || false,
        massageTypes: Array.isArray(therapist.massageTypes) ? therapist.massageTypes : 
                     (typeof therapist.massageTypes === 'string' ? JSON.parse(therapist.massageTypes || '[]') : []),
        languages: Array.isArray(therapist.languages) ? therapist.languages : 
                  (typeof therapist.languages === 'string' ? JSON.parse(therapist.languages || '[]') : []),
        pricing: typeof therapist.pricing === 'string' ? JSON.parse(therapist.pricing || '{"60":0,"90":0,"120":0}') : 
                (therapist.pricing || {"60":0,"90":0,"120":0}),
        hotelPricing: undefined,
        location: therapist.location || '',
        coordinates: typeof therapist.coordinates === 'string' ? JSON.parse(therapist.coordinates || '{"lat":0,"lng":0}') :
                    (therapist.coordinates || {"lat":0,"lng":0}),
        status: (therapist.status as any) || 'available',
        availability: 'full-time',
        hourlyRate: typeof therapist.pricing === 'string' ? 
                   (JSON.parse(therapist.pricing || '{"60":100}'))["60"] || 100 :
                   (therapist.pricing?.["60"] || 100),
        rating: therapist.rating || 0,
        reviewCount: therapist.reviewCount || 0,
        isLive: therapist.isLive !== undefined ? therapist.isLive : true,
        hotelId: '',
        hotelDiscount: 0,
        analytics: typeof therapist.analytics === 'string' ? JSON.parse(therapist.analytics || '{}') :
                  (therapist.analytics || {
                      impressions: 0,
                      views: 0,
                      profileViews: 0,
                      whatsappClicks: 0,
                      phoneClicks: 0,
                      directionsClicks: 0,
                      bookings: 0
                  }),
        isActive: true
    });

    const convertPlaceToDB = (place: Partial<Place>): Omit<DatabasePlace, 'id' | 'createdAt' | 'updatedAt'> => ({
        name: place.name || '',
        email: place.email || '',
        whatsappNumber: place.whatsappNumber || '',
        profilePicture: place.profilePicture || '',
        mainImage: place.mainImage,
        description: place.description || '',
        category: (place.category as any) || 'spa',
        services: Array.isArray(place.services) ? place.services : [],
        pricing: typeof place.pricing === 'string' ? JSON.parse(place.pricing || '{"60":0,"90":0,"120":0}') : 
                (place.pricing || {"60":0,"90":0,"120":0}),
        location: place.location || '',
        coordinates: typeof place.coordinates === 'string' ? JSON.parse(place.coordinates || '{"lat":0,"lng":0}') :
                    (place.coordinates || {"lat":0,"lng":0}),
        operatingHours: typeof place.operatingHours === 'string' ? JSON.parse(place.operatingHours || '{}') :
                       (place.operatingHours || {
                           monday: { open: "09:00", close: "21:00", closed: false },
                           tuesday: { open: "09:00", close: "21:00", closed: false },
                           wednesday: { open: "09:00", close: "21:00", closed: false },
                           thursday: { open: "09:00", close: "21:00", closed: false },
                           friday: { open: "09:00", close: "21:00", closed: false },
                           saturday: { open: "09:00", close: "21:00", closed: false },
                           sunday: { open: "09:00", close: "21:00", closed: false }
                       }),
        amenities: Array.isArray(place.amenities) ? place.amenities : [],
        rating: place.rating || 0,
        reviewCount: place.reviewCount || 0,
        isLive: place.isLive !== undefined ? place.isLive : true,
        analytics: typeof place.analytics === 'string' ? JSON.parse(place.analytics || '{}') :
                  (place.analytics || {
                      impressions: 0,
                      views: 0,
                      profileViews: 0,
                      whatsappClicks: 0,
                      phoneClicks: 0,
                      directionsClicks: 0,
                      bookings: 0
                  }),
        isActive: true
    });

    // Load data from local database
    const loadData = useCallback(async () => {
        try {
            setIsLoading(true);
            setError(null);

            const dbTherapists = localDatabase.getAllTherapists();
            const dbPlaces = localDatabase.getAllPlaces();

            setTherapists(dbTherapists.map(convertTherapistFromDB));
            setPlaces(dbPlaces.map(convertPlaceFromDB));

            console.log('ðŸ“Š Loaded from local database:', {
                therapists: dbTherapists.length,
                places: dbPlaces.length
            });
        } catch (err) {
            setError((err as Error).message);
            console.error('âŒ Failed to load data:', err);
        } finally {
            setIsLoading(false);
        }
    }, []);

    // Initialize data loading
    useEffect(() => {
        loadData();
    }, [loadData]);

    // Therapist operations
    const saveTherapist = async (therapistData: Partial<Therapist>): Promise<void> => {
        try {
            setError(null);
            const dbTherapistData = convertTherapistToDB(therapistData);
            
            if (therapistData.id) {
                await localDatabase.updateTherapist(therapistData.id, dbTherapistData as any);
                console.log('âœ… Therapist updated:', therapistData.name);
            } else {
                await localDatabase.createTherapist(dbTherapistData);
                console.log('âœ… Therapist created:', therapistData.name);
            }
            
            await loadData(); // Refresh data
        } catch (err) {
            setError((err as Error).message);
            throw err;
        }
    };

    const updateTherapist = async (id: string, updates: Partial<Therapist>): Promise<void> => {
        try {
            setError(null);
            const dbUpdates = convertTherapistToDB(updates);
            await localDatabase.updateTherapist(id, dbUpdates as any);
            await loadData();
            console.log('âœ… Therapist updated:', id);
        } catch (err) {
            setError((err as Error).message);
            throw err;
        }
    };

    const deleteTherapist = async (id: string): Promise<void> => {
        try {
            setError(null);
            await localDatabase.deleteTherapist(id);
            await loadData();
            console.log('âœ… Therapist deleted:', id);
        } catch (err) {
            setError((err as Error).message);
            throw err;
        }
    };

    const getTherapist = (id: string): Therapist | null => {
        return therapists.find(t => t.id === id) || null;
    };

    // Place operations
    const savePlace = async (placeData: Partial<Place>): Promise<void> => {
        try {
            setError(null);
            const dbPlaceData = convertPlaceToDB(placeData);
            
            if (placeData.id) {
                await localDatabase.updatePlace(placeData.id, dbPlaceData as any);
                console.log('âœ… Place updated:', placeData.name);
            } else {
                await localDatabase.createPlace(dbPlaceData);
                console.log('âœ… Place created:', placeData.name);
            }
            
            await loadData(); // Refresh data
        } catch (err) {
            setError((err as Error).message);
            throw err;
        }
    };

    const updatePlace = async (id: string, updates: Partial<Place>): Promise<void> => {
        try {
            setError(null);
            const dbUpdates = convertPlaceToDB(updates);
            await localDatabase.updatePlace(id, dbUpdates as any);
            await loadData();
            console.log('âœ… Place updated:', id);
        } catch (err) {
            setError((err as Error).message);
            throw err;
        }
    };

    const deletePlace = async (id: string): Promise<void> => {
        try {
            setError(null);
            await localDatabase.deletePlace(id);
            await loadData();
            console.log('âœ… Place deleted:', id);
        } catch (err) {
            setError((err as Error).message);
            throw err;
        }
    };

    const getPlace = (id: string): Place | null => {
        return places.find(p => p.id === id) || null;
    };

    // Search operations
    const searchTherapists = (query: string): Therapist[] => {
        const dbResults = localDatabase.searchTherapists(query);
        return dbResults.map(convertTherapistFromDB);
    };

    const searchPlaces = (query: string): Place[] => {
        const dbResults = localDatabase.searchPlaces(query);
        return dbResults.map(convertPlaceFromDB);
    };

    // Authentication (simplified for local use)
    const login = async (email: string, password: string, userType: 'therapist' | 'place' | 'admin') => {
        try {
            // For admin login
            if (userType === 'admin' && email === 'admin@massage.com' && password === 'admin123') {
                const adminUser = {
                    id: 'admin_local',
                    email,
                    userType: 'admin',
                    name: 'Admin User'
                };
                
                localStorage.setItem('userSession', JSON.stringify(adminUser));
                return adminUser;
            }

            // For therapist/place login, find by email
            const user = localDatabase.getUserByEmail(email);
            if (!user) {
                throw new Error('User not found');
            }

            if (user.userType !== userType) {
                throw new Error('Invalid user type');
            }

            // Simple password check (in real app, this would be hashed)
            if (user.password !== password) {
                throw new Error('Invalid password');
            }

            const sessionUser = {
                id: user.id,
                email: user.email,
                userType: user.userType,
                name: user.profile?.name || 'User'
            };

            localStorage.setItem('userSession', JSON.stringify(sessionUser));
            return sessionUser;
        } catch (err) {
            setError((err as Error).message);
            throw err;
        }
    };

    const register = async (userData: any) => {
        try {
            // Create user account
            const newUser = await localDatabase.createUser({
                email: userData.email,
                password: userData.password,
                userType: userData.userType,
                profile: null,
                isActive: true
            });

            const sessionUser = {
                id: newUser.id,
                email: newUser.email,
                userType: newUser.userType,
                name: userData.name || 'User'
            };

            localStorage.setItem('userSession', JSON.stringify(sessionUser));
            return sessionUser;
        } catch (err) {
            setError((err as Error).message);
            throw err;
        }
    };

    const getCurrentUser = () => {
        const session = localStorage.getItem('userSession');
        return session ? JSON.parse(session) : null;
    };

    const logout = () => {
        localStorage.removeItem('userSession');
        console.log('ðŸ‘‹ User logged out');
    };

    const refreshData = async (): Promise<void> => {
        await loadData();
    };

    return {
        // Data states
        therapists,
        places,
        isLoading,
        error,
        
        // Therapist operations
        saveTherapist,
        updateTherapist,
        deleteTherapist,
        getTherapist,
        
        // Place operations
        savePlace,
        updatePlace,
        deletePlace,
        getPlace,
        
        // Utility operations
        refreshData,
        searchTherapists,
        searchPlaces,
        
        // Authentication
        login,
        register,
        getCurrentUser,
        logout
    };
};

export default useLocalDatabase;