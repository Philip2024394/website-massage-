/**
 * üîÑ LOCAL DATABASE PROVIDER AGENT HANDLERS
 * Modified version that uses local database instead of Appwrite
 */

import { useState, useCallback } from 'react';
import { useLocalDatabase } from './useLocalDatabaseSimple';
import type { Therapist, Place, Agent } from '../types';

export const useProviderAgentHandlersLocal = () => {
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);
    
    // Get our local database functions
    const localDB = useLocalDatabase();

    // üîÑ THERAPIST SAVE HANDLER - Uses local database instead of Appwrite
    const handleSaveTherapist = useCallback(async (therapistData: any): Promise<void> => {
        console.log('üîÑ LOCAL DATABASE: handleSaveTherapist called with:', therapistData.name);
        
        try {
            setIsLoading(true);
            setError(null);

            // Use our local database save function
            await localDB.handleSaveTherapist(therapistData);

            // Success feedback
            console.log('‚úÖ LOCAL DATABASE: Therapist saved successfully');
            
            // You can add additional success handling here if needed
            // For example, showing a toast notification:
            // showToast('Profile saved successfully!', 'success');
            
        } catch (err) {
            const errorMessage = (err as Error).message;
            setError(errorMessage);
            console.error('‚ùå LOCAL DATABASE: Failed to save therapist:', errorMessage);
            
            // You can add error handling here if needed
            // For example, showing an error toast:
            // showToast('Failed to save profile: ' + errorMessage, 'error');
            
            throw err; // Re-throw to allow component-level handling
        } finally {
            setIsLoading(false);
        }
    }, [localDB]);

    // üîÑ PLACE SAVE HANDLER - Uses local database instead of Appwrite  
    const handleSavePlace = useCallback(async (placeData: any): Promise<void> => {
        console.log('üîÑ LOCAL DATABASE: handleSavePlace called with:', placeData.name);
        
        try {
            setIsLoading(true);
            setError(null);

            // Use our local database save function
            await localDB.handleSavePlace(placeData);

            console.log('‚úÖ LOCAL DATABASE: Place saved successfully');
            
        } catch (err) {
            const errorMessage = (err as Error).message;
            setError(errorMessage);
            console.error('‚ùå LOCAL DATABASE: Failed to save place:', errorMessage);
            throw err;
        } finally {
            setIsLoading(false);
        }
    }, [localDB]);

    // üéØ GET DATA FOR DISPLAY - Uses local database instead of Appwrite
    const getDisplayData = useCallback(() => {
        console.log('üîÑ LOCAL DATABASE: Getting display data from local storage');
        return localDB.getDisplayData();
    }, [localDB]);

    // üìä GET STATISTICS - Uses local database 
    const getDashboardStats = useCallback(() => {
        return localDB.getDashboardStats();
    }, [localDB]);

    // üîç SEARCH FUNCTIONALITY - Uses local database
    const searchProviders = useCallback((query: string) => {
        return localDB.searchData(query);
    }, [localDB]);

    // üóÇÔ∏è DATABASE MANAGEMENT - For admin use
    const exportDatabase = useCallback(() => {
        return localDB.exportDatabase();
    }, [localDB]);

    const importDatabase = useCallback(async (jsonData: string) => {
        return await localDB.importDatabase(jsonData);
    }, [localDB]);

    // üë§ USER AUTHENTICATION - Simple local authentication
    const getCurrentUser = useCallback(() => {
        return localDB.getCurrentUser();
    }, [localDB]);

    const isUserAuthenticated = useCallback(() => {
        return localDB.isAuthenticated();
    }, [localDB]);

    // üîÑ AGENT SAVE HANDLER - Placeholder for agent functionality
    const handleSaveAgentProfile = useCallback(async (agentData: Agent): Promise<void> => {
        console.log('üîÑ LOCAL DATABASE: handleSaveAgentProfile called - using localStorage');
        
        try {
            // Simple localStorage save for agents
            const agents = JSON.parse(localStorage.getItem('local_agents') || '[]');
            const existingIndex = agents.findIndex((a: any) => a.id === agentData.id);
            
            if (existingIndex >= 0) {
                agents[existingIndex] = { ...agentData, updatedAt: new Date().toISOString() };
            } else {
                agents.push({ 
                    ...agentData, 
                    id: `agent_${Date.now()}`,
                    createdAt: new Date().toISOString() 
                });
            }
            
            localStorage.setItem('local_agents', JSON.stringify(agents));
            console.log('‚úÖ LOCAL DATABASE: Agent saved successfully');
            
        } catch (err) {
            console.error('‚ùå LOCAL DATABASE: Failed to save agent:', err);
            throw err;
        }
    }, []);

    return {
        // Main save handlers - Compatible with existing system
        handleSaveTherapist,
        handleSavePlace,
        handleSaveAgentProfile,
        
        // Data retrieval functions
        getDisplayData,
        getDashboardStats,
        searchProviders,
        
        // Database management functions
        exportDatabase,
        importDatabase,
        
        // Authentication functions
        getCurrentUser,
        isUserAuthenticated,
        
        // State
        isLoading,
        error,
        
        // Direct access to local database
        localDatabase: localDB.database
    };
};

export default useProviderAgentHandlersLocal;