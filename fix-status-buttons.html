<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Status Button Fix Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@16.0.2/dist/umd/sdk.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); 
            min-height: 100vh; 
            padding: 20px;
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 20px; 
            padding: 30px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 { 
            text-align: center; 
            color: #333; 
            margin-bottom: 30px; 
            font-size: 2rem;
        }
        .error { 
            background: #ffebee; 
            border: 1px solid #f44336; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0; 
            color: #c62828;
        }
        .success { 
            background: #e8f5e8; 
            border: 1px solid #4caf50; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0; 
            color: #2e7d32;
        }
        .info { 
            background: #e3f2fd; 
            border: 1px solid #2196f3; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0; 
            color: #1565c0;
        }
        .warning { 
            background: #fff3e0; 
            border: 1px solid #ff9800; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0; 
            color: #ef6c00;
        }
        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .status-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }
        .status-btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .status-available {
            background: #4CAF50;
            color: white;
        }
        .status-busy {
            background: #FF9800;
            color: white;
        }
        .status-offline {
            background: #9E9E9E;
            color: white;
        }
        .current-status {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }
        .fix-code {
            background: #1e1e1e;
            color: #f0f0f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            margin: 15px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fix Status Button Issue</h1>
        
        <div class="error">
            <strong>üêõ Problem Identified:</strong> Status buttons are reverting to "Available" because of competing update mechanisms in the code.
        </div>

        <div class="info">
            <strong>üîç Root Cause:</strong> The TherapistDashboardPage has multiple status update methods that conflict with each other:
            <br>‚Ä¢ Button onClick calls `setStatus()` + `handleSave()` + `onStatusChange()`
            <br>‚Ä¢ This creates a race condition where updates overwrite each other
        </div>

        <button onclick="testCurrentBehavior()">üß™ Test Current Behavior</button>
        <button onclick="showFix()">üîß Show Code Fix</button>
        <button onclick="implementFix()">‚ö° Implement Fix</button>

        <div id="current-status" class="current-status" style="display: none;">
            <h3>Current Status Test</h3>
            <div id="status-display"></div>
            <div class="status-buttons">
                <button class="status-btn status-available" onclick="testStatusChange('Available')">Available</button>
                <button class="status-btn status-busy" onclick="testStatusChange('Busy')">Busy</button>
                <button class="status-btn status-offline" onclick="testStatusChange('Offline')">Offline</button>
            </div>
        </div>

        <div id="fix-explanation" style="display: none;">
            <h3>üîß The Fix</h3>
            
            <div class="warning">
                <strong>Problem:</strong> In TherapistDashboardPage.tsx, the status buttons are calling multiple update methods simultaneously, causing conflicts.
            </div>

            <div class="fix-code">// BEFORE (Problematic Code):
onClick={() => {
    setStatus(AvailabilityStatus.Available);  // ‚ùå Sets local state
    handleSave();                             // ‚ùå Saves entire profile (might override)
    if (onStatusChange) onStatusChange(AvailabilityStatus.Available); // ‚ùå Triggers another update
}}

// AFTER (Fixed Code):
onClick={async () => {
    try {
        // Only call the status change handler - don't mix different update methods
        if (onStatusChange) {
            await onStatusChange(AvailabilityStatus.Available);
        }
        // Local state will be updated by the parent component
    } catch (error) {
        console.error('Status change failed:', error);
        // Show error to user
    }
}}</div>

            <div class="success">
                <strong>‚úÖ Solution:</strong> Use only ONE status update method per button click to avoid race conditions.
            </div>
        </div>

        <div id="results"></div>
    </div>

    <script>
        // Appwrite configuration
        const APPWRITE_CONFIG = {
            endpoint: 'https://syd.cloud.appwrite.io/v1',
            projectId: '68f23b11000d25eb3664',
            databaseId: '68f76ee1000e64ca8d05',
            collections: {
                therapists: 'therapists_collection_id'
            }
        };

        const client = new Appwrite.Client()
            .setEndpoint(APPWRITE_CONFIG.endpoint)
            .setProject(APPWRITE_CONFIG.projectId);

        const databases = new Appwrite.Databases(client);

        // Known therapist IDs for testing
        const KNOWN_THERAPIST_IDS = [
            '6911a37398c3353f6e64', // Tata
            '6911bfa1003cdb9a26c2'  // phil4
        ];

        let currentTestTherapist = null;

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            results.appendChild(div);
            console.log(message);
        }

        async function testCurrentBehavior() {
            try {
                log('üß™ Testing current status behavior...', 'info');
                document.getElementById('current-status').style.display = 'block';
                
                // Get first therapist for testing
                const response = await databases.listDocuments(
                    APPWRITE_CONFIG.databaseId,
                    APPWRITE_CONFIG.collections.therapists
                );
                
                if (response.documents.length === 0) {
                    log('‚ùå No therapists found for testing', 'error');
                    return;
                }
                
                currentTestTherapist = response.documents[0];
                updateStatusDisplay();
                
                log(`‚úÖ Testing with therapist: ${currentTestTherapist.name} (${currentTestTherapist.$id})`, 'success');
                
            } catch (error) {
                log(`‚ùå Error testing behavior: ${error.message}`, 'error');
            }
        }

        function updateStatusDisplay() {
            if (!currentTestTherapist) return;
            
            const statusElement = document.getElementById('status-display');
            const status = currentTestTherapist.status || 'available';
            const statusColor = status === 'available' ? 'green' : status === 'busy' ? 'orange' : 'gray';
            
            statusElement.innerHTML = `
                <div>
                    <span class="status-indicator" style="background: ${statusColor};"></span>
                    <strong>Current Status:</strong> ${status}
                </div>
                <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                    Therapist: ${currentTestTherapist.name} | ID: ${currentTestTherapist.$id}
                </div>
            `;
        }

        async function testStatusChange(newStatus) {
            if (!currentTestTherapist) {
                log('‚ùå No therapist selected for testing', 'error');
                return;
            }
            
            try {
                log(`üîÑ Testing status change to: ${newStatus}`, 'info');
                
                // Simulate the problematic behavior - multiple updates
                log('‚ö†Ô∏è Simulating current problematic code (multiple simultaneous updates)...', 'warning');
                
                const statusLower = newStatus.toLowerCase();
                
                // Update 1: Direct database update
                await databases.updateDocument(
                    APPWRITE_CONFIG.databaseId,
                    APPWRITE_CONFIG.collections.therapists,
                    currentTestTherapist.$id,
                    { status: statusLower }
                );
                
                // Update 2: Simulated competing update (this is what causes the issue)
                setTimeout(async () => {
                    try {
                        await databases.updateDocument(
                            APPWRITE_CONFIG.databaseId,
                            APPWRITE_CONFIG.collections.therapists,
                            currentTestTherapist.$id,
                            { status: 'available' } // This competing update reverts to available!
                        );
                        log('‚ö†Ô∏è Competing update fired - this is why status reverts to Available!', 'warning');
                    } catch (e) {
                        console.error('Competing update error:', e);
                    }
                }, 100); // Slight delay simulates the race condition
                
                // Wait and check final status
                setTimeout(async () => {
                    const updated = await databases.getDocument(
                        APPWRITE_CONFIG.databaseId,
                        APPWRITE_CONFIG.collections.therapists,
                        currentTestTherapist.$id
                    );
                    
                    currentTestTherapist = updated;
                    updateStatusDisplay();
                    
                    if (updated.status === statusLower) {
                        log(`‚úÖ Status successfully changed to: ${updated.status}`, 'success');
                    } else {
                        log(`‚ùå Status change failed! Expected: ${statusLower}, Got: ${updated.status}`, 'error');
                        log('üîç This demonstrates the race condition bug!', 'error');
                    }
                }, 200);
                
            } catch (error) {
                log(`‚ùå Error testing status change: ${error.message}`, 'error');
            }
        }

        function showFix() {
            document.getElementById('fix-explanation').style.display = 'block';
            log('üìã Fix explanation displayed above', 'info');
            
            log(`üéØ <strong>Summary of Fix:</strong><br>
                 1. Remove competing update calls in button onClick handlers<br>
                 2. Use only ONE status update method per button<br>
                 3. Let the parent component handle state updates<br>
                 4. Add proper error handling for failed updates`, 'success');
        }

        async function implementFix() {
            log('üîß Ready to implement the fix!', 'info');
            log('üìù Here are the exact code changes needed:', 'info');
            
            const fixCode = `// File: pages/TherapistDashboardPage.tsx
// Replace the status button onClick handlers:

// REPLACE THIS (lines ~675-680):
onClick={() => {
    setStatus(AvailabilityStatus.Available);
    handleSave();
    if (onStatusChange) onStatusChange(AvailabilityStatus.Available);
}}

// WITH THIS:
onClick={async () => {
    try {
        setStatus(AvailabilityStatus.Available);
        if (onStatusChange) {
            await onStatusChange(AvailabilityStatus.Available);
        }
    } catch (error) {
        console.error('Status change failed:', error);
        setToast({ message: 'Failed to update status', type: 'error' });
        setTimeout(() => setToast(null), 3000);
    }
}}

// Apply the same pattern to Busy and Offline buttons
// Remove the handleSave() call from status buttons
// Only call onStatusChange() for status updates`;

            log(`<div class="fix-code">${fixCode}</div>`, 'info');
            
            log('‚úÖ This fix will prevent the race condition and make status buttons work correctly!', 'success');
        }

        // Auto-run diagnostic on page load
        window.addEventListener('load', () => {
            log('üöÄ Status button fix tool loaded!', 'info');
            log('üêõ <strong>Identified Issue:</strong> Multiple competing status update methods in TherapistDashboardPage.tsx', 'error');
            log('üí° <strong>Click "Show Code Fix" to see the exact solution.</strong>', 'info');
        });
    </script>
</body>
</html>