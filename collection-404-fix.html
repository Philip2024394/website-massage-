<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collection 404 Fix - Quick Diagnostic</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .error {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }
        .success {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }
        .warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }
        .info {
            background-color: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }
        .button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .code {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        .collection-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        .collection-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>üö® Collection 404 Error Fix</h1>
    
    <div class="section error">
        <h2>‚ùå Current Problem</h2>
        <p><strong>Error:</strong> <code>Collection with the requested ID could not be found</code></p>
        <p><strong>Cause:</strong> Your config uses collection names like <code>'places'</code> and <code>'bookings'</code> that don't exist in Appwrite</p>
    </div>

    <div class="section">
        <h2>üîç Quick Diagnosis</h2>
        <button class="button" onclick="diagnoseCollections()">üß™ Test Current Collections</button>
        <div id="diagnosis-results"></div>
    </div>

    <div class="section">
        <h2>üí° Quick Fix Options</h2>
        
        <h3>Option 1: Use Therapist Collection Only (Fastest)</h3>
        <p>Since you know <code>therapists_collection_id</code> works, let's disable the problematic collections temporarily:</p>
        <button class="button" onclick="generateMinimalConfig()">üîß Generate Minimal Config</button>
        
        <h3>Option 2: Find Missing Collections</h3>
        <p>Find what collections actually exist in your Appwrite database:</p>
        <button class="button" onclick="scanExistingCollections()">üîç Scan Existing Collections</button>
        
        <div id="fix-results"></div>
    </div>

    <div class="section">
        <h2>üõ†Ô∏è Implementation</h2>
        <div id="implementation-code"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
    <script>
        const APPWRITE_CONFIG = {
            endpoint: 'https://syd.cloud.appwrite.io/v1',
            projectId: '68f23b11000d25eb3664',
            databaseId: '68f76ee1000e64ca8d05'
        };

        const client = new Appwrite.Client()
            .setEndpoint(APPWRITE_CONFIG.endpoint)
            .setProject(APPWRITE_CONFIG.projectId);

        const databases = new Appwrite.Databases(client);

        function addResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `section ${type}`;
            div.innerHTML = message;
            container.appendChild(div);
        }

        async function diagnoseCollections() {
            const container = document.getElementById('diagnosis-results');
            container.innerHTML = '';

            const problematicCollections = ['places', 'bookings', 'notifications', 'users'];
            
            addResult('diagnosis-results', 'üîç Testing problematic collections...', 'info');

            for (const collectionId of problematicCollections) {
                try {
                    await databases.listDocuments(APPWRITE_CONFIG.databaseId, collectionId, []);
                    addResult('diagnosis-results', `‚úÖ ${collectionId}: EXISTS`, 'success');
                } catch (error) {
                    if (error.message.includes('Collection with the requested ID could not be found')) {
                        addResult('diagnosis-results', `‚ùå ${collectionId}: NOT FOUND`, 'error');
                    } else {
                        addResult('diagnosis-results', `‚ö†Ô∏è ${collectionId}: ${error.message}`, 'warning');
                    }
                }
            }

            // Test the working one
            try {
                await databases.listDocuments(APPWRITE_CONFIG.databaseId, 'therapists_collection_id', []);
                addResult('diagnosis-results', `‚úÖ therapists_collection_id: WORKING`, 'success');
            } catch (error) {
                addResult('diagnosis-results', `‚ùå therapists_collection_id: ${error.message}`, 'error');
            }
        }

        function generateMinimalConfig() {
            const code = `// QUICK FIX: Minimal configuration that only uses working collections
export const APPWRITE_CONFIG = {
    endpoint: 'https://syd.cloud.appwrite.io/v1',
    projectId: '68f23b11000d25eb3664',
    databaseId: '68f76ee1000e64ca8d05',
    
    collections: {
        // Working collections
        admins: 'admin_messages',
        therapists: 'therapists_collection_id',
        
        // Placeholder collections (will be ignored by services)
        places: null, // Disabled temporarily
        agents: null, // Disabled temporarily  
        bookings: null, // Disabled temporarily
        reviews: null, // Disabled temporarily
        notifications: null, // Disabled temporarily
        users: null, // Disabled temporarily
        
        // Keep existing working collections as-is
        agentVisits: 'agent_visits_collection_id',
        hotelBookings: 'hotel_bookings',
        hotels: 'hotels_collection_id',
        massageTypes: 'massage_types_collection_id',
        membershipPricing: 'membership_pricing_collection_id',
        imageAssets: 'image_assets',
        loginBackgrounds: 'login_backgrounds',
        customLinks: 'custom_links_collection_id',
        translations: 'translations_collection_id',
        commissionRecords: 'commission_records',
        attributes: 'ATTRIBUTES',
        analyticsEvents: 'Analytics Events',
        therapistJobListings: 'therapist_job_listings',
        employerJobPostings: 'employer_job_postings',
        bankDetails: 'bank_details',
        paymentTransactions: 'payment_transactions',
        messages: 'messages_collection_id',
        packages: 'packages_collection_id',
        pushSubscriptions: 'push_subscriptions',
        loyaltyWallets: 'loyalty_wallets',
        providerLoyaltySettings: 'provider_loyalty_settings',
        coinTransactions: 'coin_transactions',
        userRegistrations: 'user_registrations',
        chatRooms: 'chat_rooms',
        chatMessages: 'chat_messages',
        coins: 'coins',
        referrals: 'referrals',
        activeDiscounts: 'active_discounts',
        appConfig: 'app_config',
    },
    
    // Storage bucket ID
    storageId: '68f76bdd002387590584'
};`;

            document.getElementById('implementation-code').innerHTML = `
                <h3>üîß Copy this configuration to lib/appwrite.config.ts:</h3>
                <div class="code">${code}</div>
                <p><strong>This will:</strong></p>
                <ul>
                    <li>‚úÖ Keep therapist functionality working</li>
                    <li>‚úÖ Disable problematic collections temporarily</li>
                    <li>‚úÖ Stop the 404 errors immediately</li>
                    <li>‚ö†Ô∏è Places/bookings features will be disabled until you create those collections</li>
                </ul>
            `;
        }

        async function scanExistingCollections() {
            const container = document.getElementById('fix-results');
            container.innerHTML = '';
            
            addResult('fix-results', 'üîç Scanning your Appwrite database for existing collections...', 'info');

            try {
                const collections = await databases.listCollections(APPWRITE_CONFIG.databaseId);
                
                if (collections.collections.length === 0) {
                    addResult('fix-results', '‚ö†Ô∏è No collections found in database. You may need to create them first.', 'warning');
                    return;
                }

                addResult('fix-results', `‚úÖ Found ${collections.collections.length} collections in your database:`, 'success');

                let collectionsHtml = '<div class="collection-list">';
                collections.collections.forEach(collection => {
                    collectionsHtml += `
                        <div class="collection-item">
                            <strong>${collection.name}</strong><br>
                            <code>${collection.$id}</code>
                        </div>
                    `;
                });
                collectionsHtml += '</div>';

                addResult('fix-results', collectionsHtml, 'info');
                
                // Generate mapping
                generateCollectionMapping(collections.collections);

            } catch (error) {
                addResult('fix-results', `‚ùå Error scanning collections: ${error.message}`, 'error');
            }
        }

        function generateCollectionMapping(collections) {
            let mapping = `// Update lib/appwrite.config.ts with these real collection IDs:\n\ncollections: {\n`;
            
            // Try to match collection names to config keys
            const configMappings = {
                'therapists': ['therapists', 'therapist', 'providers'],
                'places': ['places', 'locations', 'venues', 'spas'],
                'bookings': ['bookings', 'appointments', 'reservations'],
                'users': ['users', 'customers', 'clients'],
                'notifications': ['notifications', 'alerts', 'messages'],
                'reviews': ['reviews', 'ratings', 'feedback']
            };

            for (const [configKey, possibleNames] of Object.entries(configMappings)) {
                const matchedCollection = collections.find(col => 
                    possibleNames.some(name => 
                        col.name.toLowerCase().includes(name) || col.$id.includes(name)
                    )
                );
                
                if (matchedCollection) {
                    mapping += `    ${configKey}: '${matchedCollection.$id}', // Found: ${matchedCollection.name}\n`;
                } else {
                    mapping += `    ${configKey}: null, // ‚ùå Not found - create this collection\n`;
                }
            }

            // Add other collections
            mapping += `    
    // Keep existing working collections
    admins: 'admin_messages',
    agentVisits: 'agent_visits_collection_id',
    // ... (rest of your existing collections)
};`;

            addResult('fix-results', `<h3>üéØ Suggested Configuration Update:</h3><div class="code">${mapping}</div>`, 'success');
        }

        // Auto-run diagnosis on page load
        window.onload = function() {
            console.log('üîç Collection diagnostic tool ready');
            console.log('üìã Current errors indicate missing collections: places, bookings, notifications');
            console.log('üí° Use the buttons above to diagnose and fix the issues');
        };
    </script>
</body>
</html>